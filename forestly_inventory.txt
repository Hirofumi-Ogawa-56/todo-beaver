app/mailers/application_mailer.rb
--- START OF FILE ---
class ApplicationMailer < ActionMailer::Base
  default from: "from@example.com"
  layout "mailer"
end
-e \n--- END OF FILE ---\n
app/models/reaction.rb
--- START OF FILE ---
# app/models/reaction.rb
class Reaction < ApplicationRecord
  belongs_to :comment
  belongs_to :profile

  KINDS = %w[heart].freeze  # 将来ここに "smile", "thumbs_up" など足せる

  validates :kind,
            presence: true,
            inclusion: { in: KINDS }
end
-e \n--- END OF FILE ---\n
app/models/tag.rb
--- START OF FILE ---
# app/models/tag.rb
class Tag < ApplicationRecord
  has_many :task_tags, dependent: :destroy
  has_many :tasks, through: :task_tags

  validates :name, presence: true, uniqueness: true, length: { maximum: 20 }
end
-e \n--- END OF FILE ---\n
app/models/task_tag.rb
--- START OF FILE ---
# app/models/task_tag.rb
class TaskTag < ApplicationRecord
  belongs_to :task
  belongs_to :tag

  validates :tag_id, uniqueness: { scope: :task_id }
end
-e \n--- END OF FILE ---\n
app/models/membership_request.rb
--- START OF FILE ---
# app/models/membership_request.rb
class MembershipRequest < ApplicationRecord
  # 関連
  belongs_to :requester_profile, class_name: "Profile"
  belongs_to :target_profile, class_name: "Profile", optional: true
  belongs_to :team

  # 方向
  enum :direction, { profile_to_team: 0, team_to_profile: 1 }

  # 状態
  enum :status, { pending: 0, approved: 1, rejected: 2, canceled: 3 }

  # バリデーション
  validates :direction, presence: true
  validates :status, presence: true

  # 同じ内容の pending 申請を重複させない
  validates :requester_profile_id,
            uniqueness: {
              scope: [ :target_profile_id, :team_id, :direction ],
              conditions: -> { where(status: statuses[:pending]) },
              message: "同じ申請がすでに送信されており、承認待ちです。"
            }

  validate :target_presence

  private

  # direction に応じて、team or target_profile が必須
  def target_presence
    case direction&.to_sym
    when :profile_to_team
      errors.add(:team, "を指定してください") if team.nil?
    when :team_to_profile
      errors.add(:team, "を指定してください") if team.nil?
      errors.add(:target_profile, "を指定してください") if target_profile.nil?
    end
  end
end
-e \n--- END OF FILE ---\n
app/models/task_assignment.rb
--- START OF FILE ---
# app/models/task_assignment.rb
class TaskAssignment < ApplicationRecord
  belongs_to :task
  belongs_to :profile

  validates :profile_id, uniqueness: { scope: :task_id }
end
-e \n--- END OF FILE ---\n
app/models/team.rb
--- START OF FILE ---
# app/models/team.rb
class Team < ApplicationRecord
  has_many :team_memberships, dependent: :destroy
  has_many :profiles, through: :team_memberships
  has_many :membership_requests, dependent: :destroy

  has_one_attached :avatar

  validates :name, presence: true, length: { maximum: 30 }
  validates :join_token, uniqueness: true, allow_nil: true

  before_create :set_join_token

  def display_initials
    base = name.presence || "?"
    base.split(/\s+/).map { |part| part[0] }.join[0, 2].upcase
  end

  attr_accessor :remove_avatar

  before_save :purge_avatar_if_needed

  private

  def set_join_token
    self.join_token ||= generate_unique_join_token
  end

  def generate_unique_join_token
    loop do
      token = SecureRandom.alphanumeric(8).upcase
      break token unless self.class.exists?(join_token: token)
    end
  end

  def purge_avatar_if_needed
    if ActiveModel::Type::Boolean.new.cast(remove_avatar)
      avatar.purge
    end
  end
end
-e \n--- END OF FILE ---\n
app/models/team_membership.rb
--- START OF FILE ---
# app/models/team_membership.rb
class TeamMembership < ApplicationRecord
  belongs_to :team
  belongs_to :profile

  validates :profile_id, uniqueness: { scope: :team_id }

  ADMIN_ROLE = "admin"

  scope :admins, -> { where(role: ADMIN_ROLE) }

  def admin?
    role == ADMIN_ROLE
  end

  # 管理者がゼロになったら、全員を管理者にする
  after_destroy :ensure_at_least_one_admin
  after_update :ensure_at_least_one_admin, if: :saved_change_to_role?

  private

  def ensure_at_least_one_admin
    # まだこのチームに管理者がいれば何もしない
    return if team.team_memberships.admins.exists?

    # いなければ、このチームのメンバー全員を管理者に昇格
    team.team_memberships.update_all(role: ADMIN_ROLE)
  end
end
-e \n--- END OF FILE ---\n
app/models/profile.rb
--- START OF FILE ---
# app/models/profile.rb
class Profile < ApplicationRecord
  belongs_to :user

  validates :label, presence: true, length: { maximum: 25 }
  validates :display_name, presence: true, length: { maximum: 30 }

  validates :join_token, uniqueness: true, allow_nil: true

  has_many :team_memberships, dependent: :destroy
  has_many :teams, through: :team_memberships

  has_many :task_assignments, dependent: :destroy
  has_many :assigned_tasks, through: :task_assignments, source: :task
  has_many :comments, foreign_key: :author_profile_id, dependent: :nullify
  has_many :reactions, dependent: :destroy

  has_many :sent_membership_requests,
           class_name: "MembershipRequest",
           foreign_key: :requester_profile_id,
           dependent: :destroy

  has_many :received_membership_requests,
           class_name: "MembershipRequest",
           foreign_key: :target_profile_id,
           dependent: :destroy

  has_one_attached :avatar

  attr_accessor :remove_avatar

  before_create :set_join_token
  before_save :purge_avatar_if_needed

  THEMES = %w[
  default
  slate
  indigo
  emerald
  rose
  amber
  ].freeze
  before_validation :set_default_theme
  validates :theme, inclusion: { in: THEMES }, allow_nil: true

  LOCALES = %w[ja en ja_en].freeze
  validates :locale, inclusion: { in: LOCALES }, allow_blank: true



  def display_initials
    base = display_name.presence || label.presence || "?"
    base.split(/\s+/).map { |part| part[0] }.join[0, 2].upcase
  end

  private

  def set_join_token
    self.join_token ||= generate_unique_join_token
  end

  def purge_avatar_if_needed
    if ActiveModel::Type::Boolean.new.cast(remove_avatar)
      avatar.purge
    end
  end

  def generate_unique_join_token
    loop do
      token = SecureRandom.alphanumeric(8).upcase # 例: "A9B3ZK1Q"
      break token unless self.class.exists?(join_token: token)
    end
  end

  def set_default_theme
    self.theme = "default" if theme.blank?
  end
end
-e \n--- END OF FILE ---\n
app/models/comment.rb
--- START OF FILE ---
# app/models/comment.rb
class Comment < ApplicationRecord
  belongs_to :task
  belongs_to :author_profile, class_name: "Profile"

  def pinned?
    pinned
  end

  has_many :reactions, dependent: :destroy
  has_many :heart_reactions,
           -> { where(kind: "heart") },
           class_name: "Reaction"

  validates :body, presence: true, length: { maximum: 2000 }
end
-e \n--- END OF FILE ---\n
app/models/application_record.rb
--- START OF FILE ---
class ApplicationRecord < ActiveRecord::Base
  primary_abstract_class
end
-e \n--- END OF FILE ---\n
app/models/user.rb
--- START OF FILE ---
# app/models/user.rb

# Userクラスの定義
class User < ApplicationRecord
  # Userの機能を定義
  devise :database_authenticatable,
        :registerable,
        :recoverable,
        :rememberable,
        :validatable,
        :confirmable

  # Userの関連を定義
  has_many :profiles, dependent: :destroy # 一人のUserはたくさんのProfileを持てる
end
-e \n--- END OF FILE ---\n
app/models/task.rb
--- START OF FILE ---
# app/models/task.rb
class Task < ApplicationRecord
  belongs_to :owner_profile,    class_name: "Profile"
  belongs_to :assignee_profile, class_name: "Profile", optional: true
  belongs_to :team, optional: true

  has_many :task_tags, dependent: :destroy
  has_many :tags, through: :task_tags
  has_many :task_assignments, dependent: :destroy
  has_many :assignees, through: :task_assignments, source: :profile
  has_many :comments, dependent: :destroy
  has_many :pinned_comments,
           -> { where(pinned: true).order(created_at: :asc) },
           class_name: "Comment"

  enum :status, { todo: 0, done: 1, in_progress: 2, archived: 3 }

  validates :title, presence: true, length: { maximum: 30 }
  validates :status, presence: true


  # フォーム用の「仮想」属性
  attr_accessor :due_date, :due_time, :tag_list

  # 検索スコープ
  scope :keyword_search, ->(query) do
    terms = query.to_s.strip.split(/\s+/)
    rel   = left_outer_joins(:tags).distinct

    terms.each do |term|
      next if term.blank?

      pattern = "%#{sanitize_sql_like(term)}%" # ← Task. は不要

      rel = rel.where(
        "tasks.title ILIKE :pattern OR tasks.description ILIKE :pattern OR tags.name ILIKE :pattern",
        pattern:
      )
    end

    rel
  end

  # フォーム表示用：既存タグ → カンマ区切り文字列
  def tag_list
    @tag_list || tags.pluck(:name).join(", ")
  end

  # カンマ区切り文字列から tags 関連を更新
  def update_tags_from_list!
    names =
      tag_list.to_s
              .split(/[,\n]/)
              .map { |n| n.strip }
              .reject(&:blank?)
              .uniq

    new_tags = names.map { |name| Tag.find_or_create_by!(name: name) }
    self.tags = new_tags
  end

  private

  def due_at_cannot_be_in_the_past
    return if due_at >= Time.current.beginning_of_day

    errors.add(:due_at, "は今日以降を指定してください")
  end
end
-e \n--- END OF FILE ---\n
app/jobs/application_job.rb
--- START OF FILE ---
class ApplicationJob < ActiveJob::Base
  # Automatically retry jobs that encountered a deadlock
  # retry_on ActiveRecord::Deadlocked

  # Most jobs are safe to ignore if the underlying records are no longer available
  # discard_on ActiveJob::DeserializationError
end
-e \n--- END OF FILE ---\n
app/controllers/application_controller.rb
--- START OF FILE ---
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  allow_browser versions: :modern
  before_action :authenticate_user!, unless: :devise_controller?
  before_action :set_current_profile
  before_action :set_locale
  helper_method :current_profile

  def set_locale
    I18n.locale = current_profile&.locale || I18n.default_locale
  end

  private

  def set_current_profile
    return unless user_signed_in?

    if session[:current_profile_id].present?
      @current_profile = current_user.profiles.find_by(id: session[:current_profile_id])
    end

    if @current_profile.nil?
      @current_profile = current_user.profiles.order(created_at: :asc).first
      session[:current_profile_id] = @current_profile.id if @current_profile
    end
  end

  def current_profile
    @current_profile
  end

  def switch_profile(profile)
    return unless user_signed_in?
    return unless profile.user_id == current_user.id

    session[:current_profile_id] = profile.id
    @current_profile = profile
  end

  def require_current_profile!
    return if current_profile

    redirect_to profiles_path,
                alert: "タスクを利用するにはプロフィールを選択してください。"
  end
end
-e \n--- END OF FILE ---\n
app/controllers/reactions_controller.rb
--- START OF FILE ---
# app/controllers/reaction_controller.rb
class ReactionsController < ApplicationController
  before_action :authenticate_user!
  before_action :require_current_profile!
  before_action :set_comment

  def create
    reaction = @comment.reactions.find_by(
      profile: current_profile,
      kind: "heart"
    )

    if reaction
      # すでに押している → 解除
      reaction.destroy
    else
      # まだ押していない → 付与
      @comment.reactions.create!(
        profile: current_profile,
        kind: "heart"
      )
    end

    redirect_to task_path(@comment.task)
  end

  private

  def set_comment
    @comment = Comment.find(params[:comment_id])
  end
end
-e \n--- END OF FILE ---\n
app/controllers/teams_controller.rb
--- START OF FILE ---
# app/controllers/teams_controller.rb
class TeamsController < ApplicationController
  before_action :authenticate_user!
  before_action :require_current_profile!
  before_action :set_team, only: %i[show edit update destroy manage]

  def index
    @teams = Team.order(created_at: :desc)
  end

  def show
  end

  def new
    @team = Team.new
  end

  def create
    @team = Team.new(team_params)

    if @team.save
      # 作成した人を自動的に管理者にする
      if current_profile
        TeamMembership.create!(
          team: @team,
          profile: current_profile,
          role: TeamMembership::ADMIN_ROLE
        )
      end
      redirect_to @team, notice: "チームを作成しました"
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @team.update(team_params)
      redirect_to @team, notice: "チームを更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def destroy
    @team.destroy
    redirect_to teams_path, notice: "チームを削除しました"
  end

  # ★ 旧 team_settings#members を統合したアクション
  def manage
    # set_team により、この時点で @team は取得済みです
    
    @memberships = @team.team_memberships.includes(:profile)
    @members     = @memberships.map(&:profile)

    # 今のプロフィールがこのチームの管理者かどうか
    @current_membership = @memberships.find { |m| m.profile_id == current_profile.id }
    @can_manage_members = @current_membership&.admin?

    # プロフィール検索用（招待用トークン）
    @profile_invite_token = params[:profile_invite_token].to_s.strip.upcase
    if @profile_invite_token.present?
      @found_profile = Profile.where(join_token: @profile_invite_token)
                              .where.not(id: @members.map(&:id))
                              .first
    end

    # このチームに届いている参加申請（プロフィールからチームへ）
    @incoming_join_requests = @team.membership_requests
                                   .profile_to_team
                                   .pending
                                   .includes(:requester_profile)
  end

  private

  def set_team
    @team = Team.find(params[:id])
  end

  def require_current_profile!
    return if current_profile
    redirect_to profiles_path, alert: "プロフィールを選択してください。"
  end

  def team_params
    params.require(:team).permit(:name, :avatar, :remove_avatar)
  end
end-e \n--- END OF FILE ---\n
app/controllers/account_settings_controller.rb
--- START OF FILE ---
# app/controllers/account_settings_controller.rb
class AccountSettingsController < ApplicationController
  before_action :authenticate_user!

  def send_change_email
    new_email = params[:email].to_s.strip

    if new_email.blank?
      redirect_back fallback_location: edit_user_registration_path, alert: "新しいメールアドレスを入力してください"
      return
    end

    if current_user.update(email: new_email)
      redirect_back fallback_location: edit_user_registration_path,
                    notice: "確認メールを送信しました。メール内リンクから手続きを進めてください。"
    else
      redirect_back fallback_location: edit_user_registration_path,
                    alert: current_user.errors.full_messages.first
    end
  end

  def send_password_reset
    current_user.send_reset_password_instructions
    redirect_back fallback_location: edit_user_registration_path,
                  notice: "パスワード変更用のメールを送信しました。"
  end
end
-e \n--- END OF FILE ---\n
app/controllers/tasks_controller.rb
--- START OF FILE ---
# app/controllers/tasks_controller.rb
class TasksController < ApplicationController
  before_action :authenticate_user!
  before_action :require_current_profile!
  before_action :set_task, only: %i[show edit update destroy]
  before_action :set_collections, only: %i[new create edit update]

  def index
    @view_mode = params[:view] == "calendar" ? "calendar" : "list"
    @all_profiles_mode = (params[:all_profiles] == "1")

    if @all_profiles_mode
      profile_ids = current_user.profiles.pluck(:id)

      assigned_task_ids =
        TaskAssignment.where(profile_id: profile_ids).select(:task_id)

      base_scope =
        Task.where(owner_profile_id: profile_ids)
            .or(Task.where(id: assigned_task_ids))
    else
      assigned_task_ids =
        TaskAssignment.where(profile_id: current_profile.id).select(:task_id)

      base_scope =
        Task.where(owner_profile_id: current_profile.id)
            .or(Task.where(id: assigned_task_ids))
    end

    if @view_mode == "calendar"
      setup_calendar(base_scope)
      render :calendar
    else
      @query = params[:q].to_s

      rel = apply_filter(base_scope)
      rel = rel.keyword_search(@query) if @query.present?
      rel = apply_column_filters(rel)

      @tasks =
        rel
          .includes(:team, :owner_profile, :assignees)
          .order(build_order_clause)
          .page(params[:page])
          .per(50)

      respond_to do |format|
        format.html          # 初回表示 / 通常遷移
        format.turbo_stream  # もっと見る用（.turbo_stream を付けて叩く）
      end
    end
  end

  def slot_tasks
    # date と hour は +N バッジ側からパラメータでもらう想定
    date =
      begin
        Date.parse(params[:date])
      rescue ArgumentError
        Time.zone.today.to_date
      end

    hour = params[:hour].to_i

    assigned_task_ids =
      TaskAssignment.where(profile_id: current_profile.id).select(:task_id)

    base_scope =
      Task.where(owner_profile_id: current_profile.id)
          .or(Task.where(id: assigned_task_ids))

    # その日のタスクだけざっくり絞る
    day_start = date.beginning_of_day.in_time_zone
    day_end   = date.end_of_day.in_time_zone

    tasks_for_day =
      base_scope
        .where(due_at: day_start..day_end)
        .includes(:team, :owner_profile, :assignees)

    # カレンダーと同じルール:
    # display_time = due_at - 1.hour の「時」が指定 hour と一致するもの
    @tasks_in_slot =
      tasks_for_day.select do |task|
        next false if task.due_at.blank?

        display_time = task.due_at - 1.hour
        display_time.hour == hour
      end

    @slot_date = date
    @slot_hour = hour

    # side-panel の turbo_frame に埋め込む想定なので layout なしでOK
    render layout: false
  end

  def show
  end

  def new
    tomorrow = 1.day.from_now.to_date

    @task = Task.new(
      status: :todo
    )

    @task.due_date = tomorrow
    @task.due_time = "23:30"

    @task.assignee_ids = [ current_profile.id ]
  end

  def create
    @task = Task.new(task_params)
    @task.owner_profile = current_profile
    @task.team          ||= current_profile.teams.first

    build_due_at_from_virtual_fields(@task)

    if @task.errors.any?
      set_collections
      render :new, status: :unprocessable_entity
      return
    end

    Task.transaction do
      if @task.save
        @task.update_tags_from_list!
      end
    end

    if @task.errors.empty?
      # ★ ここを変更
      redirect_to tasks_path, notice: "タスクを作成しました。"
    else
      set_collections
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    if @task.due_at.present?
      @task.due_date ||= @task.due_at.to_date
      @task.due_time ||= @task.due_at.strftime("%H:%M")
    end
  end

  def update
    @task.assign_attributes(task_params)

    if task_params.key?(:due_date) || task_params.key?(:due_time)
      build_due_at_from_virtual_fields(@task)
      if @task.errors.any?
        set_collections
        render :edit, status: :unprocessable_entity
        return
      end
    end

    Task.transaction do
      if @task.save
        @task.update_tags_from_list! if task_params.key?(:tag_list)
      end
    end

    if @task.errors.empty?
      respond_to do |format|
        format.html do
          if turbo_frame_request?
            redirect_to task_path(@task), notice: "タスクを更新しました。"
          else
            redirect_to tasks_path, notice: "タスクを更新しました。"
          end
        end
        format.turbo_stream # update.turbo_stream.erb を探す
      end
    else
      set_collections
      render :edit, status: :unprocessable_entity
    end
  end


  def destroy
    if @task.team_id.present?
      unless current_profile.teams.exists?(id: @task.team_id)
        redirect_to tasks_path, alert: "このタスクを削除する権限がありません。"
        return
      end
    else
      unless @task.owner_profile_id == current_profile.id
        redirect_to tasks_path, alert: "このタスクを削除する権限がありません。"
        return
      end
    end

    @task.destroy

    respond_to do |format|
      format.html { redirect_to tasks_path, notice: "タスクを削除しました。" }
      format.turbo_stream # ← destroy.turbo_stream.erb を探す
    end
  end


  private

  def set_task
    @task = Task.find(params[:id])
  end

  def set_collections
    @teams = current_profile.teams.order(:name)

    @assignee_candidates =
      if @teams.any?
        Profile.joins(:team_memberships)
              .where(team_memberships: { team_id: @teams.ids })
              .distinct
              .order(:display_name, :label)
      else
        Profile.where(id: current_profile.id)
      end
  end

  def task_params
    params.require(:task).permit(
      :title,
      :description,
      :status,
      :due_date,
      :due_time,
      :tag_list,
      assignee_ids: []
    )
  end

  def build_due_at_from_virtual_fields(task)
    date_str = task.due_date.presence
    time_str = task.due_time.presence

    if date_str.blank? && time_str.blank?
      task.due_at = nil
      return
    end

    if date_str.blank? || time_str.blank?
      task.errors.add(:base, "期限日と時間は両方入力するか、両方空にしてください")
      return
    end

    unless time_str =~ /\A\d{1,2}:(00|30)\z/
      task.errors.add(:due_time, "は 30分単位で HH:MM 形式で入力してください（例: 09:00, 13:30）")
      return
    end

    begin
      task.due_at = Time.zone.parse("#{date_str} #{time_str}")
    rescue ArgumentError
      task.errors.add(:base, "期限の形式が正しくありません")
    end
  end

  def apply_filter(scope)
    case params[:filter]
    when "today"
      scope.where(due_at: Time.current.all_day)
    when "this_week"
      scope.where(
        due_at: Time.current.beginning_of_week..Time.current.end_of_week
      )
    when "incomplete"
      scope.where.not(status: Task.statuses[:done])
    when "done"
      scope.done
    else
      scope
    end
  end

  def setup_calendar(scope)
    # ▼ 基準日（?date=YYYY-MM-DD があればそれ、なければ今日）
    @base_date =
      begin
        params[:date].present? ? Date.parse(params[:date]) : Time.zone.today.to_date
      rescue ArgumentError
        Time.zone.today.to_date
      end

    # ▼ 週の開始・終了（ここでは月曜はじまり）
    @week_start = @base_date.beginning_of_week(:monday)
    @week_end   = @week_start + 6.days

    # ビューで使う配列
    @calendar_days = (@week_start..@week_end).to_a

    # ▼ 時間軸（とりあえず 8:00〜23:00）
    @hours = (8..23).to_a

    # ▼ この週に「期限がある」タスクだけ取得
    @tasks_for_calendar =
      scope
        .where(due_at: @week_start.beginning_of_day..@week_end.end_of_day)
        .includes(:team, :owner_profile, :assignees)

    # ▼ [日付][時間] => [タスク...] なハッシュ
    slots = {}
    @calendar_days.each do |date|
      slots[date] = {}
      @hours.each { |h| slots[date][h] = [] }
    end

    @tasks_for_calendar.each do |task|
      next unless task.due_at

      date = task.due_at.to_date
      hour = task.due_at.hour

      next unless slots[date] && slots[date][hour]

      slots[date][hour] << task
    end

    @calendar_slots = slots
  end

  def apply_column_filters(scope)
    rel = scope

    # タイトルフィルタ
    if params[:title_contains].present?
      rel = rel.where("tasks.title ILIKE ?", "%#{params[:title_contains]}%")
    end

    # 期限フィルタ（特定の日付だけを表示）
    if params[:due_on].present?
      begin
        date = Date.parse(params[:due_on])
        rel = rel.where(due_at: date.beginning_of_day..date.end_of_day)
      rescue ArgumentError
        # 不正な日付は無視（何もしない）
      end
    end

    # ステータスフィルタ（自由記入：todo / in / done など部分一致）
    if params[:status_keyword].present?
      keyword = params[:status_keyword].to_s

      matched_keys =
        Task.statuses.keys.select { |k| k.include?(keyword) }

      if matched_keys.any?
        rel = rel.where(status: Task.statuses.values_at(*matched_keys))
      else
        # 何もマッチしない → 結果0件
        rel = rel.none
      end
    end

    # 担当者フィルタ（display_name 部分一致）
    if params[:assignee_keyword].present?
      profile_ids =
        Profile.where("display_name ILIKE ?", "%#{params[:assignee_keyword]}%")
               .pluck(:id)

      if profile_ids.any?
        task_ids =
          TaskAssignment.where(profile_id: profile_ids).select(:task_id)
        rel = rel.where(id: task_ids)
      else
        rel = rel.none
      end
    end

    # 作成者フィルタ（display_name 部分一致）
    if params[:owner_keyword].present?
      profile_ids =
        Profile.where("display_name ILIKE ?", "%#{params[:owner_keyword]}%")
               .pluck(:id)

      if profile_ids.any?
        rel = rel.where(owner_profile_id: profile_ids)
      else
        rel = rel.none
      end
    end

    rel
  end

  # ソート条件を組み立てる
  def build_order_clause
    # どのカラムでソートするか（許可リスト）
    column =
    case params[:sort]
    when "title"
        "tasks.title"
    when "due_at"
        "tasks.due_at"
    when "status"
        "tasks.status"
    when "owner"
        # 作成者（owner_profile の display_name）
        "(SELECT display_name FROM profiles " \
          "WHERE profiles.id = tasks.owner_profile_id LIMIT 1)"
    when "assignee"
        # 担当者（複数いる場合は一番小さい名前で代表させる）
        "(SELECT MIN(p.display_name) FROM task_assignments ta " \
          "JOIN profiles p ON p.id = ta.profile_id " \
          "WHERE ta.task_id = tasks.id)"
    else
        "tasks.due_at"  # デフォルト
    end

    # 昇順 or 降順（パラメータが変な値なら ASC に倒す）
    direction = params[:direction] == "desc" ? "DESC" : "ASC"

    # ついでに created_at も第2キーにしておくと安定
    Arel.sql("#{column} #{direction}, tasks.created_at ASC")
  end
end
-e \n--- END OF FILE ---\n
app/controllers/comments_controller.rb
--- START OF FILE ---
# app/controllers/comments_controller.rb
class CommentsController < ApplicationController
  before_action :authenticate_user!
  before_action :require_current_profile!
  before_action :set_task
  before_action :set_comment, only: %i[edit update destroy]

  def create
    @comment = @task.comments.build(comment_params)
    @comment.author_profile = current_profile

    ActiveRecord::Base.transaction do
      @comment.save!
      apply_task_status_change
    end

    redirect_to task_path(@task), notice: "コメントを追加しました。"
  rescue ActiveRecord::RecordInvalid
    @comments = @task.comments.includes(:author_profile).order(:created_at)
    render "tasks/show", status: :unprocessable_entity
  end

  def edit
  end

  def update
    ActiveRecord::Base.transaction do
      @comment.update!(comment_params)
      apply_task_status_change
    end

    redirect_to task_path(@task), notice: "コメントを更新しました。"
  rescue ActiveRecord::RecordInvalid
    render :edit, status: :unprocessable_entity
  end

  def destroy
    @comment.destroy
    redirect_to task_path(@task), notice: "コメントを削除しました。"
  end

  private

  def set_task
    @task = Task.find(params[:task_id])
  end

  def set_comment
    @comment = @task.comments.find(params[:id])
  end

  def comment_params
    params.require(:comment).permit(:body, :pinned)
  end

  def apply_task_status_change
    new_status = params.dig(:comment, :task_status).presence
    return unless new_status

    @task.update!(status: new_status)
  end
end
-e \n--- END OF FILE ---\n
app/controllers/profiles_controller.rb
--- START OF FILE ---
# app/controllers/profiles_controller.rb
class ProfilesController < ApplicationController
  before_action :authenticate_user!
  before_action :set_profile, only: %i[show edit update destroy settings]

  skip_before_action :verify_authenticity_token, only: :switch

  def index
    @profiles = current_user.profiles.order(created_at: :asc)
  end

  def show
  end

  def new
    @profile = current_user.profiles.build
  end

  def create
    @profile = current_user.profiles.build(profile_params)
    if @profile.save
      redirect_to @profile, notice: "プロフィールを作成しました"
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @profile.update(profile_params)
      redirect_to @profile, notice: "プロフィールを更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def destroy
    if current_user.profiles.count <= 1
      redirect_to profiles_path, alert: "最後のプロフィールは削除できません"
    else
      @profile.destroy
      redirect_to profiles_path, notice: "プロフィールを削除しました"
    end
  end

  def switch
    profile = current_user.profiles.find(params[:profile_id])
    session[:current_profile_id] = profile.id
    redirect_back fallback_location: profiles_path
  end

  def settings
    @incoming_team_invites = @profile.received_membership_requests
                                     .team_to_profile
                                     .pending
                                     .includes(:team, :requester_profile)


    @team_invite_token = params[:team_invite_token].to_s.strip.upcase
    @invite_teams = @team_invite_token.present? ? Team.where(join_token: @team_invite_token) : Team.none
  end

  private

  def set_profile
    @profile = current_user.profiles.find(params[:id])
  end

  def profile_params
    params.require(:profile).permit(
      :label,
      :display_name,
      :theme,
      :avatar,
      :remove_avatar,
      :locale
    )
  end
end
-e \n--- END OF FILE ---\n
app/controllers/team_memberships_controller.rb
--- START OF FILE ---
# app/controllers/team_memberships_controller.rb
class TeamMembershipsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_team_membership, only: [ :destroy, :update ]
  before_action :require_team_admin!, only: [ :destroy, :update ]

  def create
    team    = Team.find(params[:team_id])
    profile = Profile.find(params[:profile_id])

    membership = TeamMembership.new(
      team: team,
      profile: profile,
      role: params[:role].presence # 入力なければ nil のまま
    )

    if membership.save
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    notice: "メンバーを追加しました"
    else
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                   alert: "メンバーを追加できませんでした"
    end
  end

  # ★ 追加：役割変更
  def update
    team = @team_membership.team

    # selectから来る値（"admin" or ""）を受け取る
    new_role = params.require(:team_membership)[:role].presence

    if @team_membership.update(role: new_role)
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    notice: "メンバーの役割を更新しました"
    else
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    alert:  "役割を更新できませんでした"
    end
  end

  def destroy
    team = @team_membership.team
    @team_membership.destroy

    redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                  notice: "メンバーを削除しました"
  end

  private

  def set_team_membership
    @team_membership = TeamMembership.find(params[:id])
  end

  # このチームの「管理者」だけが destroy / update できる
  def require_team_admin!
    team = @team_membership.team

    admin_membership = team.team_memberships.find_by(
      profile: current_profile,
      role: TeamMembership::ADMIN_ROLE
    )

    return if admin_membership

    redirect_to root_path,
                alert: "このチームのメンバー管理を行う権限がありません"
  end
end
-e \n--- END OF FILE ---\n
app/controllers/users/passwords_controller.rb
--- START OF FILE ---
# app/controllers/users/passwords_controller.rb
class Users::PasswordsController < Devise::PasswordsController
  skip_before_action :authenticate_user!, only: %i[new create edit update]
  before_action :sign_out_if_signed_in, only: %i[edit update]

  def create
    email = resource_params[:email].to_s.downcase.strip
    deliver_emails = ENV.fetch("DELIVER_EMAILS", "false") == "true"

    is_new_demo_creation = false

    # 提出モードの場合、許可リストを作成
    unless deliver_emails
      allowed_demo_emails = []
      allowed_demo_emails << ENV.fetch("DEMO_EMAIL", "demo@example.com").to_s.downcase
      # 2つ目のデモメールが環境変数に設定されていれば追加
      if ENV["DEMO_EMAIL_2"].present?
        allowed_demo_emails << ENV["DEMO_EMAIL_2"].to_s.downcase
      end
      allowed_demo_emails.compact!

      # 許可リストに含まれていなければ、スパム登録を防ぐためにリダイレクト
      unless allowed_demo_emails.include?(email)
        return redirect_to new_user_session_path, alert: "提出モードでは指定されたデモメールのみ使用できます。"
      end
    end

    user = User.find_by(email: email)

    if user.nil?
      is_new_demo_creation = true
      password =
        if deliver_emails
          Devise.friendly_token.first(20)
        else
          ENV.fetch("DEMO_PASSWORD", "password")
        end

      user = User.new(email: email, password: password, password_confirmation: password)

      # 提出モードは確認済みにしてログインできるようにする
      user.confirmed_at = Time.current unless deliver_emails

      unless user.save
        return redirect_to new_user_session_path, alert: user.errors.full_messages.first
      end

      # ★★★ 新しいユーザー作成時のプロフィール作成ロジックのみ実行 ★★★

      # 1. プロファイルを作成
      new_profile_label = email.split("@").first
      user.profiles.create!(
        display_name: new_profile_label.capitalize,
        label: new_profile_label,
        theme: "default"
      )

      # ★★★ チーム参加ロジックは削除 ★★★
    end

    if deliver_emails
      user.send_reset_password_instructions
      notice = "メールを送信しました。メールを確認し、リンクからパスワード設定（再設定）を完了してください。"
    else
      # ユーザーが今作成されたばかりの場合、その情報を通知
      if is_new_demo_creation
        notice = "テストユーザー**「#{email}」**を作成しました。パスワードは**「#{ENV.fetch("DEMO_PASSWORD", "password")}」**でログインしてください。"
      else
        # 既存のデモアカウントの場合
        notice = "デモアカウントを作成しました。画面上のデモID/パスワードでログインしてください。"
      end
    end

    redirect_to new_user_session_path, notice: notice
  end

  private

  def sign_out_if_signed_in
    sign_out(current_user) if user_signed_in?
  end
end
-e \n--- END OF FILE ---\n
app/controllers/users/confirmations_controller.rb
--- START OF FILE ---
# app/controllers/users/confirmations_controller.rb
class Users::ConfirmationsController < Devise::ConfirmationsController
  def create
    token = params[:confirmation_token].to_s

    # ✅ あなたの “メール変更確定” フロー
    if token.present?
      self.resource = resource_class.confirm_by_token(token)

      if resource.errors.empty?
        redirect_to edit_user_registration_path, notice: "メールアドレスを確定しました。"
      else
        redirect_to edit_user_registration_path, alert: resource.errors.full_messages.first
      end
      return
    end

    # ✅ Devise本来の “確認メール再送”
    super
  end
end
-e \n--- END OF FILE ---\n
app/controllers/membership_requests_controller.rb
--- START OF FILE ---
# app/controllers/membership_requests_controller.rb
class MembershipRequestsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_membership_request, only: [ :approve ]

  def create
    direction = params[:direction]

    case direction
    when "team_to_profile"
      create_team_to_profile_request

    when "profile_to_team"
      team = Team.find(params[:team_id])

      # すでにメンバーなら申請不要
      if team.profiles.exists?(id: current_profile.id)
        redirect_back fallback_location: edit_profile_path(current_profile),
                      alert: "すでにこのチームのメンバーです"
        return
      end

      req = MembershipRequest.new(
        direction: "profile_to_team",
        team: team,
        requester_profile: current_profile,
        status: :pending,
        admin: params[:admin] == "1"
      )

      if req.save
        redirect_back fallback_location: edit_profile_path(current_profile),
                      notice: "参加申請を送信しました。"
      else
        redirect_back fallback_location: edit_profile_path(current_profile),
                      alert: req.errors.full_messages.first
      end

    else
      redirect_back fallback_location: root_path, alert: "不正なリクエストです。"
    end
  end

  def approve
    req = @membership_request

    case req.direction
    when "team_to_profile"
      unless req.pending? && req.target_profile_id == current_profile&.id
        redirect_back fallback_location: edit_profile_path(current_profile),
                      alert: "この招待は承認できません"
        return
      end

      TeamMembership.transaction do
        role_value = req.admin? ? TeamMembership::ADMIN_ROLE : nil

        TeamMembership.find_or_create_by!(team: req.team, profile: current_profile) do |m|
          m.role = role_value
        end

        if role_value.present?
          membership = TeamMembership.find_by!(team: req.team, profile: current_profile)
          membership.update!(role: TeamMembership::ADMIN_ROLE) unless membership.admin?
        end

        req.update!(status: :approved)
      end

      redirect_back fallback_location: edit_profile_path(current_profile),
                    notice: "チーム招待を承認しました。"

    when "profile_to_team"
      team    = req.team
      profile = req.requester_profile

      admin_membership =
        team.team_memberships.find_by(profile: current_profile, role: TeamMembership::ADMIN_ROLE)

      unless admin_membership
        redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                      alert: "このチームの申請を承認する権限がありません"
        return
      end

      TeamMembership.transaction do
        TeamMembership.find_or_create_by!(team: team, profile: profile)
        req.update!(status: :approved)
      end

      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    notice: "参加申請を承認しました。"

    else
      redirect_back fallback_location: root_path, alert: "不正なリクエストです。"
    end
  end

  private

  def set_membership_request
    @membership_request = MembershipRequest.find(params[:id])
  end

  def create_team_to_profile_request
    team = Team.find(params[:team_id])
    target_profile = Profile.find(params[:target_profile_id])

    requester_profile = current_profile
    unless requester_profile
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    alert: "現在のプロフィールが選択されていません"
      return
    end

    # 管理者だけ招待できる
    admin_membership =
      team.team_memberships.find_by(profile: requester_profile, role: TeamMembership::ADMIN_ROLE)

    unless admin_membership
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    alert: "このチームの招待を送る権限がありません"
      return
    end

    # すでにメンバーなら招待不要（任意だけど親切）
    if team.profiles.exists?(id: target_profile.id)
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    alert: "このプロフィールはすでにチームメンバーです"
      return
    end

    membership_request = MembershipRequest.new(
      requester_profile: requester_profile,
      target_profile: target_profile,
      team: team,
      direction: :team_to_profile,
      status: :pending,
      admin: params[:admin] == "1"
    )

    if membership_request.save
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    notice: "招待を送信しました"
    else
      redirect_back fallback_location: manage_team_path(@team)(team_id: team.id),
                    alert: membership_request.errors.full_messages.first
    end
  end
end
-e \n--- END OF FILE ---\n
app/views/comments/edit.html.erb
--- START OF FILE ---
<!-- app/views/comments/edit.html.erb -->
<h1 class="text-sm font-semibold mb-3">コメント編集</h1>

<%= render "form", task: @task, comment: @comment %>-e \n--- END OF FILE ---\n
app/views/comments/_comment.html.erb
--- START OF FILE ---
<!-- app/views/comments/_comment.html.erb -->
<% profile = comment.author_profile %>

<div class="py-2 border-b border-gray-100">
  <!-- 1行目：チップ + 日付 -->
  <div class="flex items-center justify-between text-[11px] text-gray-500">
    <%= profile_chip(
          profile,
          size: :xs,
          wrapper_class: "text-xs text-gray-700 font-semibold"
        ) %>

    <span><%= l comment.created_at, format: :ja_short %></span>
  </div>

  <!-- 2行目：本文（左）＋ PINバッジ＆ハート（右） -->
  <div class="mt-1 flex items-start justify-between gap-2">
    <!-- 本文（左側） -->
    <div class="flex-1 pl-6 text-sm">
      <%= simple_format(
            h(comment.body),
            {},               # pタグのクラスを追加したければここに
            wrapper_tag: "p"
          ) %>
    </div>

    <!-- 右側：PINバッジ + ハート（横並びで右寄せ） -->
    <div class="flex items-center gap-1 text-[11px] text-gray-500 pr-1">
      <% if comment.pinned? %>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-yellow-50 text-[10px] text-yellow-700 border border-yellow-200">
          <%= t('tasks.show.pin') %>
        </span>
      <% end %>

      <% heart_reactions = comment.heart_reactions.includes(:profile) %>
      <% liked_by_current = heart_reactions.any? { |r| r.profile_id == current_profile.id } %>
      <% count = heart_reactions.size %>

      <%= button_to(
            task_comment_reactions_path(comment.task, comment),
            method: :post,
            class: "inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[11px] " \
                   "hover:bg-pink-50 " \
                   "#{liked_by_current ? 'bg-pink-50 border-pink-300 text-pink-700' : 'bg-white border-gray-300 text-gray-500'}"
          ) do %>
        <span><%= liked_by_current ? "♥" : "♡" %></span>
        <% if count.positive? %>
          <span><%= count %></span>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

-e \n--- END OF FILE ---\n
app/views/comments/_form.html.erb
--- START OF FILE ---
<!-- app/views/comments/_form.html.erb -->
<%= form_with model: [@task, comment], local: true do |f| %>
  <% if comment.errors.any? %>
    <div class="mb-2 p-2 bg-red-50 text-red-700 rounded text-xs">
      <p class="font-semibold">
        <%= t('errors.template.header', count: comment.errors.count, model: t('activerecord.models.comment')) %>
      </p>
      <ul class="list-disc list-inside">
        <% comment.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-2">
    <%= f.text_area :body,
                    rows: 3,
                    class: "w-full border rounded px-2 py-1 text-sm",
                    placeholder: t('activerecord.placeholders.comment.body') %>
  </div>

  <!-- ★ ピン留め + ステータス変更 -->
  <div class="mb-2 flex flex-wrap items-center gap-4 text-[11px] text-gray-600">
    <!-- ピン留め -->
    <label class="inline-flex items-center gap-1">
      <%= f.check_box :pinned %>
      <span><%= t('activerecord.attributes.comment.pinned') %></span>
    </label>
  </div>

  <div class="flex justify-end">
    <%= f.submit t('helpers.submit.comment.create', model: t('activerecord.models.comment')),
                 class: "px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 cursor-pointer" %>
  </div>
<% end %>
-e \n--- END OF FILE ---\n
app/views/devise/unlocks/new.html.erb
--- START OF FILE ---
<h2>Resend unlock instructions</h2>

<%= form_for(resource, as: resource_name, url: unlock_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <div class="actions">
    <%= f.submit "Resend unlock instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>
-e \n--- END OF FILE ---\n
app/views/devise/passwords/edit.html.erb
--- START OF FILE ---
<!-- app/views/devise/passwords/edit.html.erb -->
<div class="min-h-screen flex items-center justify-center bg-white px-4">
  <div class="w-full max-w-md">
    <!-- ロゴ -->
    <div class="flex flex-col items-center text-center mb-8">
      <%= image_tag "forestly_logo.png",
                    alt: "forestly",
                    class: "block",
                    style: "height: 128px; width: auto;" %>
      <p class="mt-0 text-sm text-gray-600">
        <%= t('common.tagline') %>
      </p>
    </div>

    <% if flash[:alert].present? %>
      <div class="mb-4 rounded border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <% if flash[:notice].present? %>
      <div class="mb-4 rounded border border-green-200 bg-green-50 px-3 py-2 text-sm text-green-800">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- タイトル -->
    <h1 class="text-lg font-semibold text-center mb-4">
      <%= t('devise.passwords.edit.title') %>
    </h1>

    <p class="text-sm text-gray-600 text-center mb-6">
      <%= t('devise.passwords.edit.instruction') %>
    </p>

    <%= form_for(resource,
                 as: resource_name,
                 url: user_password_path,
                 html: { method: :put, data: { turbo: false } }) do |f| %>

      <!-- reset token は必須 -->
      <%= f.hidden_field :reset_password_token %>

      <% if resource.errors.any? %>
        <div class="mb-4 rounded border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
          <ul class="list-disc list-inside">
            <% resource.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="space-y-3">
        <div class="flex items-center gap-3">
          <%= f.label :password, t('activerecord.attributes.user.password'), class: "w-28 text-sm text-gray-700" %>
          <%= f.password_field :password,
                               autocomplete: "new-password",
                               class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <div class="flex items-center gap-3">
          <%= f.label :password_confirmation, t('activerecord.attributes.user.password_confirmation'), class: "w-28 text-sm text-gray-700" %>
          <%= f.password_field :password_confirmation,
                               autocomplete: "new-password",
                               class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <div class="pt-2">
          <%= f.submit t('common.submit_confirm'),
                      class: "w-full px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" %>
        </div>
      </div>
    <% end %>

    <div class="mt-6 text-center text-sm">
      <%= link_to t('devise.sessions.new.back_to_login', default: "ログインへ戻る"), new_user_session_path, class: "text-gray-600 underline" %>
    </div>
  </div>
</div>
-e \n--- END OF FILE ---\n
app/views/devise/passwords/new.html.erb
--- START OF FILE ---
<h2>Forgot your password?</h2>

<%= form_for(resource, as: resource_name, url: password_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <div class="actions">
    <%= f.submit "Send me reset password instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/confirmation_instructions.html.erb
--- START OF FILE ---
<!-- app/views/devise/mailer/confirmation_instructions.html.erb -->
<p>
  <%= t('common.app_name') %>
</p>

<p>
  <%= t('devise.mailer.confirmation_instructions.instruction_title') %>
</p>

<p>
  <%= t('devise.mailer.confirmation_instructions.instruction_body') %>
</p>

<p>
  <%= link_to t('devise.mailer.confirmation_instructions.action_link'), 
              user_confirmation_url(confirmation_token: @token) %>
</p>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/reset_password_instructions.html.erb
--- START OF FILE ---
<!-- app/views/devise/mailer/reset_password_instructions.html.erb -->
<p>
  <%= t('common.app_name') %>
</p>

<p>
  <%= t('devise.mailer.reset_password_instructions.instruction_title') %>
</p>

<p>
  <%= t('devise.mailer.reset_password_instructions.instruction_body') %>
</p>

<p>
  <%= link_to t('devise.mailer.reset_password_instructions.action_link'),
              edit_user_password_url(reset_password_token: @token) %>
</p>-e \n--- END OF FILE ---\n
app/views/devise/mailer/password_change.html.erb
--- START OF FILE ---
<p>Hello <%= @resource.email %>!</p>

<p>We're contacting you to notify you that your password has been changed.</p>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/email_changed.html.erb
--- START OF FILE ---
<p>Hello <%= @email %>!</p>

<% if @resource.try(:unconfirmed_email?) %>
  <p>We're contacting you to notify you that your email is being changed to <%= @resource.unconfirmed_email %>.</p>
<% else %>
  <p>We're contacting you to notify you that your email has been changed to <%= @resource.email %>.</p>
<% end %>
-e \n--- END OF FILE ---\n
app/views/devise/mailer/unlock_instructions.html.erb
--- START OF FILE ---
<p>Hello <%= @resource.email %>!</p>

<p>Your account has been locked due to an excessive number of unsuccessful sign in attempts.</p>

<p>Click the link below to unlock your account:</p>

<p><%= link_to 'Unlock my account', unlock_url(@resource, unlock_token: @token) %></p>
-e \n--- END OF FILE ---\n
app/views/devise/shared/_error_messages.html.erb
--- START OF FILE ---
<% if resource.errors.any? %>
  <div id="error_explanation" data-turbo-cache="false">
    <h2>
      <%= I18n.t("errors.messages.not_saved",
                 count: resource.errors.count,
                 resource: resource.class.model_name.human.downcase)
       %>
    </h2>
    <ul>
      <% resource.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>
-e \n--- END OF FILE ---\n
app/views/devise/shared/_links.html.erb
--- START OF FILE ---
<%- if controller_name != 'sessions' %>
  <%= link_to "Log in", new_session_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.registerable? && controller_name != 'registrations' %>
  <%= link_to "Sign up", new_registration_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.recoverable? && controller_name != 'passwords' && controller_name != 'registrations' %>
  <%= link_to "Forgot your password?", new_password_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.confirmable? && controller_name != 'confirmations' %>
  <%= link_to "Didn't receive confirmation instructions?", new_confirmation_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.lockable? && resource_class.unlock_strategy_enabled?(:email) && controller_name != 'unlocks' %>
  <%= link_to "Didn't receive unlock instructions?", new_unlock_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.omniauthable? %>
  <%- resource_class.omniauth_providers.each do |provider| %>
    <%= button_to "Sign in with #{OmniAuth::Utils.camelize(provider)}", omniauth_authorize_path(resource_name, provider), data: { turbo: false } %><br />
  <% end %>
<% end %>
-e \n--- END OF FILE ---\n
app/views/devise/sessions/new.html.erb
--- START OF FILE ---
<!-- app/views/devise/sessions/new.html.erb -->
<div class="min-h-screen flex items-center justify-center bg-white px-4">
  <div class="w-full max-w-md">
    <!-- ロゴ -->
    <div class="flex flex-col items-center text-center mb-8">
      <%= image_tag "forestly_logo.png",
                    alt: t('common.app_name'),
                    class: "block",
                    style: "height: 128px; width: auto;" %>
      <p class="mt-0 text-sm text-gray-600">
        <%= t('common.tagline') %>
      </p>
    </div>

    <% if flash[:alert].present? %>
      <div class="mb-4 rounded border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <% if flash[:notice].present? %>
      <div class="mb-4 rounded border border-green-200 bg-green-50 px-3 py-2 text-sm text-green-800">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- ログイン -->
    <h1 class="text-lg font-semibold text-center mb-4"><%= t('devise.sessions.new.title') %></h1>
    <% if submit_mode? %>
      <div class="mb-4 rounded border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
        <p class="font-semibold"><%= t('devise.sessions.new.demo_mode.header') %></p>
        <p class="mt-1">
          Email (A):
          <code class="px-1 py-0.5 bg-white/60 rounded select-all"><%= ENV.fetch("DEMO_EMAIL", "demo@example.com") %></code>
          <br>
          Email (B):
          <code class="px-1 py-0.5 bg-white/60 rounded select-all"><%= ENV.fetch("DEMO_EMAIL_2", "demo2@example.com") %></code>
          <br>
          <%= t('activerecord.attributes.user.password') %> (<%= t('devise.sessions.new.demo_mode.common') %>):
          <code class="px-1 py-0.5 bg-white/60 rounded select-all"><%= ENV.fetch("DEMO_PASSWORD", "password") %></code>
        </p>
        <p class="mt-2 text-xs text-amber-800">
          <%= t('devise.sessions.new.demo_mode.note') %>
        </p>
      </div>
    <% end %>

    <%= form_for(resource,
             as: resource_name,
             url: session_path(resource_name),
             html: { data: { turbo: false } }) do |f| %>
      <div class="space-y-3">
        <!-- Email 横並び -->
        <div class="flex items-center gap-3">
          <%= f.label :email, t('activerecord.attributes.user.email'), class: "w-28 text-sm text-gray-700" %>
          <%= f.email_field :email,
                            autofocus: true,
                            autocomplete: "email",
                            placeholder: "email@domain.com",
                            class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <!-- Password 横並び -->
        <div class="flex items-center gap-3">
          <%= f.label :password, t('activerecord.attributes.user.password'), class: "w-28 text-sm text-gray-700" %>
          <%= f.password_field :password,
                               autocomplete: "current-password",
                               class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <!-- ログインボタン -->
        <div class="pt-2">
          <%= f.submit t('devise.sessions.new.title'),
                       class: "w-full px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" %>
        </div>
      </div>
    <% end %>

    <!-- 区切り -->
    <div class="my-8 flex items-center gap-3">
      <div class="h-px flex-1 bg-gray-200"></div>
      <div class="text-xs text-gray-500 whitespace-nowrap"><%= t('devise.sessions.new.sign_up_link') %></div>
      <div class="h-px flex-1 bg-gray-200"></div>
    </div>

    <!-- 登録用メール送信（パスワード設定メールを送る） -->
    <%= form_for(resource_class.new,
                as: resource_name,
                url: user_password_path,   # ←ここが重要
                method: :post,
                html: { data: { turbo: false } }) do |f| %>
      <div class="space-y-3">
        <div class="flex items-center gap-3">
          <%= f.label :email, t('activerecord.attributes.user.email'), class: "w-28 text-sm text-gray-700" %>
          <%= f.email_field :email,
                            autocomplete: "email",
                            placeholder: "email@domain.com",
                            class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <div class="pt-2">
          <%= f.submit t('devise.sessions.new.send_sign_up_email'),
                      class: "w-full px-4 py-2 bg-gray-900 text-white text-sm rounded hover:bg-gray-800" %>
        </div>
      </div>
    <% end %>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/devise/confirmations/new.html.erb
--- START OF FILE ---
<h2>Resend confirmation instructions</h2>

<%= form_for(resource, as: resource_name, url: confirmation_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email", value: (resource.pending_reconfirmation? ? resource.unconfirmed_email : resource.email) %>
  </div>

  <div class="actions">
    <%= f.submit "Resend confirmation instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>
-e \n--- END OF FILE ---\n
app/views/devise/registrations/edit.html.erb
--- START OF FILE ---
<!-- app/views/devise/registrations/edit.erb -->
<% if user_signed_in? && current_user.profiles.any? %>
  <% content_for :sidebar do %>
    <%= render "profiles/sidebar" %>
  <% end %>
<% end %>

<h1 class="text-xl font-bold mb-6"><%= t('devise.registrations.edit.title') %></h1>

<!-- 1) 現在のメール -->
<div class="mb-8 p-4 rounded">
  <h2 class="font-semibold mb-2"><%= t('devise.registrations.edit.current_email') %></h2>
  <p class="text-sm text-gray-700"><%= current_user.email %></p>

  <% if current_user.respond_to?(:unconfirmed_email) && current_user.unconfirmed_email.present? %>
    <p class="text-xs text-amber-700 mt-2">
      <%= t('devise.registrations.edit.unconfirmed_email_msg', email: current_user.unconfirmed_email) %>
    </p>
  <% end %>
</div>

<!-- 2) メール変更申請（新しいメールに確認メールを送る） -->
<div class="mb-8 p-4 rounded" id="email">
  <h2 class="font-semibold mb-2"><%= t('devise.registrations.edit.change_email_title') %></h2>

  <%= form_with url: send_change_email_path, method: :post, local: true do |f| %>
    <div class="mb-3">
      <%= label_tag :email, t('activerecord.attributes.user.new_email'), class: "block text-sm mb-1" %>
      <%= email_field_tag :email, "", class: "w-full border border-gray-300 rounded px-3 py-2" %>
    </div>

    <%= submit_tag t('devise.registrations.edit.send_email_change_instructions'),
                   class: "px-4 py-2 rounded bg-blue-600 text-white" %>
  <% end %>
</div>

<!-- 3) パスワード変更メール送信（リセットメール） -->
<div class="p-4 rounded" id="password">
  <h2 class="font-semibold mb-2"><%= t('devise.registrations.edit.change_password_title') %></h2>

  <%= button_to t('devise.registrations.edit.send_password_reset_instructions'),
                send_password_reset_path,
                method: :post,
                class: "px-4 py-2 rounded bg-blue-600 text-white" %>
</div>-e \n--- END OF FILE ---\n
app/views/devise/registrations/new.html.erb
--- START OF FILE ---
<h2>Sign up</h2>

<%= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <div class="field">
    <%= f.label :password %>
    <% if @minimum_password_length %>
    <em>(<%= @minimum_password_length %> characters minimum)</em>
    <% end %><br />
    <%= f.password_field :password, autocomplete: "new-password" %>
  </div>

  <div class="field">
    <%= f.label :password_confirmation %><br />
    <%= f.password_field :password_confirmation, autocomplete: "new-password" %>
  </div>

  <div class="actions">
    <%= f.submit "Sign up" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>
-e \n--- END OF FILE ---\n
app/views/tasks/index.html.erb
--- START OF FILE ---
<!-- app/views/tasks/index.html.erb -->
<% content_for :sidebar do %>
  <%= render "tasks/sidebar" %>
<% end %>

<div>
  <!-- ▼ 総合検索フォーム -->
  <div class="mb-1">
    <%= form_with url: tasks_path, method: :get, local: true,
                  class: "flex items-center gap-2 max-w-xl" do %>

      <!-- 今のクイックフィルタを維持 -->
      <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>

      <!-- all_profiles も維持 -->
      <%= hidden_field_tag :all_profiles, params[:all_profiles] if params[:all_profiles].present? %>

      <%= text_field_tag :q,
                        @query,
                        class: "flex-1 border border-gray-300 rounded px-3 py-1 text-sm",
                        placeholder: t('tasks.index.search_placeholder') %>

      <%= submit_tag t('common.search'),
                    class: "px-3 py-1 bg-gray-800 text-white text-sm rounded hover:bg-gray-900" %>

      <% if @query.present? %>
        <%= link_to t('common.clear'),
                    tasks_path(
                      filter:      params[:filter],
                      all_profiles: params[:all_profiles]  # ★ ここでモード維持
                    ),
                    class: "text-xs text-gray-500 underline ml-2" %>
      <% end %>
    <% end %>
  </div>

  <!-- ▼ カラムごとのフィルタ -->
  <div class="mb-1">
    <%= form_with url: tasks_path, method: :get, local: true do %>
      <%# 総合検索とクイックフィルタは維持 %>
      <%= hidden_field_tag :q, @query if @query.present? %>
      <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>
      <%= hidden_field_tag :all_profiles, params[:all_profiles] if params[:all_profiles].present? %>

      <table class="w-full text-xs">
        <tbody>
          <tr>
            <!-- タイトル -->
            <td class="py-1 px-2">
              <%= text_field_tag :title_contains,
                                 params[:title_contains],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: t('tasks.index.filter_title') %>
            </td>

            <!-- 期限（自由入力でもいいですが、UX的に date_field_tag おすすめ） -->
            <td class="py-1 px-2">
              <%= date_field_tag :due_on,
                                 params[:due_on],
                                 class: "w-full border border-gray-300 rounded px-2 py-1" %>
            </td>

            <!-- ステータス（todo / in / done など） -->
            <td class="py-1 px-2">
              <%= text_field_tag :status_keyword,
                                 params[:status_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: t('tasks.index.filter_placeholder_status') %>
            </td>

            <!-- 担当者 -->
            <td class="py-1 px-2">
              <%= text_field_tag :assignee_keyword,
                                 params[:assignee_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: t('tasks.index.filter_placeholder_assignee') %>
            </td>

            <!-- 作成者 -->
            <td class="py-1 px-2">
              <%= text_field_tag :owner_keyword,
                                 params[:owner_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: t('tasks.index.filter_placeholder_owner') %>
            </td>

            <!-- 右端：ボタン -->
            <td class="py-1 px-2">
              <div class="flex justify-end gap-2">
                <%= submit_tag t('common.filter_apply'),
                               class: "px-3 py-1 bg-gray-100 text-gray-700 text-xs rounded border border-gray-300 hover:bg-gray-200" %>

                <%= link_to t('common.filter_apply'),
                            tasks_path(
                              q:           @query,
                              filter:      params[:filter],
                              all_profiles: params[:all_profiles]
                            ),
                            class: "px-3 py-1 text-xs text-gray-500 underline" %>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    <% end %>
  </div>


<% if @tasks.any? %>
  <div class="overflow-y-auto max-h-[calc(100vh-260px)]">
    <table class="w-full text-sm">
      <thead class="sticky top-0 bg-gray-50 z-10">
        <tr class="border-b">
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_title'), "title") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_due_at'), "due_at") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_status'), "status") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_assignee'), "assignee") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_owner'), "owner") %>
          </th>
          <th class="text-left py-2 px-2"></th>
        </tr>
      </thead>

      <!-- ★ ここに id を付ける -->
      <tbody id="tasks-table-body">
        <%= render partial: "tasks/task_row", collection: @tasks, as: :task %>
      </tbody>
    </table>
  <!-- ▼ もっと見る（次のページへ） -->
  <% if @tasks.next_page.present? %>
    <div id="load-more-tasks" class="mt-2 flex justify-center">
      <%= link_to t('common.more'),
                  tasks_path(
                    request.query_parameters.merge(
                      page:   @tasks.next_page,
                      format: :turbo_stream
                    )
                  ),
                  class: "px-4 py-2 text-xs bg-gray-100 border border-gray-300 rounded hover:bg-gray-200" %>
    </div>
  <% end %>
  </div>



<% else %>
  <p class="text-sm text-gray-500">
    <%= t('tasks.index.no_tasks') %>
  </p>
<% end %>
</div>
-e \n--- END OF FILE ---\n
app/views/tasks/destroy.turbo_stream.erb
--- START OF FILE ---
<!-- app/views/tasks/destroy.turbo_stream.erb -->
<%= turbo_stream.remove dom_id(@task) %>-e \n--- END OF FILE ---\n
app/views/tasks/_task_row.html.erb
--- START OF FILE ---
<!-- app/views/tasks/_task_row.html.erb -->
    <tr id="<%= dom_id(task) %>" class="border-gray-50">
    <!-- Taskのタイトル -->
    <td class="py-2 px-2">
        <%= link_to task.title,
                    task_path(task),
                    class: "font-semibold text-gray-600 underline",
                    data: {
                    turbo_frame: "side-panel-frame",
                    action: "click->side-panel#open",
                    side_panel_title_param: t('tasks.show.title')
                    } %>
    </td>

    <!-- Taskの期限 -->
    <td class="py-2 px-2">
        <%= due_badge(task) %>
    </td>

    <!-- Taskのステータス -->
    <td class="py-2 px-2">
        <div class="mb-1">
        <%= status_badge(task) %>
        </div>
    </td>

    <!-- Taskの担当者 -->
    <td class="py-2">
        <% if task.assignees.any? %>
        <% task.assignees.each do |profile| %>
            <%= profile_chip(
                profile,
                size: :xs,
                wrapper_class: "px-2 py-1 mr-1 mb-1 rounded bg-gray-100 text-xs font-semibold"
                ) %>
        <% end %>
        <% else %>
        <span class="text-xs text-gray-400"><%= t('common.not_set') %></span>
        <% end %>
    </td>

    <!-- Taskの作成者 -->
    <td class="py-2 px-2">
        <% if task.owner_profile %>
        <%= profile_chip(
                task.owner_profile,
                size: :xs,
                wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
            ) %>
        <% else %>
        <span class="text-xs text-gray-400"><%= t('common.unknown') %></span>
        <% end %>
    </td>

    <!-- Taskのステータス変更 + 編集・削除 -->
    <td class="py-2 px-2 text-right">
        <div class="flex items-center justify-end gap-2">
        <!-- ステータス変更プルダウン -->
        <%= form_with model: task,
                        url: task_path(task),
                        method: :patch,
                        local: true do |f| %>
            <%= f.select :status,
                        Task.statuses.keys.map { |k| [k, k] },
                        {},
                        class: "border border-gray-300 rounded px-2 py-1 text-xs",
                        onchange: "this.form.submit();" %>
        <% end %>

        <!-- 編集ボタン -->
        <%= link_to t('common.edit'),
                    edit_task_path(task),
                    class: "text-xs text-gray-600 underline",
                    data: {
                        turbo_frame: "side-panel-frame",
                        action: "click->side-panel#open",
                        side_panel_title_param: t('tasks.show.edit_title')
                    } %>

        <!-- 削除ボタン -->
        <%= button_to t('common.delete'),
                    task_path(task),
                    method: :delete,
                    form: { data: { turbo_confirm: t('tasks.index.confirm_delete'), turbo_stream: true } },
                    class: "text-xs text-red-600 underline" %>
        </div>
    </td>
    </tr>-e \n--- END OF FILE ---\n
app/views/tasks/index.turbo_stream.erb
--- START OF FILE ---
<!-- app/views/tasks/index.turbo_stream.erb -->
<%= turbo_stream.append "tasks-table-body" do %>
  <%= render partial: "tasks/task_row", collection: @tasks, as: :task %>
<% end %>

<%# 「もっと見る」ボタンの制御（ここは現状のままでOKです） %>
<% if @tasks.next_page.present? %>
  <%= turbo_stream.replace "load-more-tasks" do %>
    <div id="load-more-tasks" class="mt-2 flex justify-center">
      <%= link_to "もっと見る",
                  tasks_path(request.query_parameters.merge(page: @tasks.next_page, format: :turbo_stream)),
                  class: "px-4 py-2 text-xs bg-gray-100 border border-gray-300 rounded hover:bg-gray-200" %>
    </div>
  <% end %>
<% else %>
  <%= turbo_stream.remove "load-more-tasks" %>
<% end %>-e \n--- END OF FILE ---\n
app/views/tasks/slot_tasks.html.erb
--- START OF FILE ---
<!-- app/views/tasks/slot_tasks.html.erb -->
<turbo-frame id="side-panel-frame">
  <div class="space-y-3 text-sm">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-xs text-gray-500">
            <%= t('tasks.calendar.slot_time_header', 
                            date: l(@slot_date, format: :short), 
                            time: "%02d:00" % @slot_hour) %>
        </div>
        <div class="text-lg font-semibold text-gray-800">
          <%= t('tasks.calendar.slot_title_list') %>
        </div>
      </div>
    </div>

    <% if @tasks_in_slot.any? %>
      <ul class="space-y-2">
        <% @tasks_in_slot.each do |task| %>
          <li class="border border-gray-300 rounded px-3 py-2 hover:bg-gray-50">
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="font-semibold text-gray-800 truncate">
                  <%= task.title %>
                </div>
                <div class="text-[11px] text-gray-500 mt-0.5">
                  <%= t('tasks.show.due_date') %>:
                  <% if task.due_at %>
                    <%= task.due_at.strftime("%m/%d %H:%M") %>
                  <% else %>
                    <%= t('common.not_set') %>
                  <% end %>
                </div>
                <div class="text-[11px] text-gray-500 mt-0.5 flex flex-wrap gap-1">
                  <% if task.assignees.any? %>
                    <% task.assignees.each do |profile| %>
                      <%= profile_chip(
                            profile,
                            size: :xs,
                            wrapper_class: "px-1 py-0.5 rounded bg-gray-100 text-[11px]"
                          ) %>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400">
                      <%= t('tasks.show.assignee') %>: <%= t('common.not_set') %>
                    </span>
                  <% end %>
                </div>
              </div>

              <div class="flex flex-col items-end gap-1">
                <%= status_badge(task) %>

                <%= link_to "詳細を見る",
                            task_path(task),
                            class: "text-[11px] text-blue-600 underline",
                            data: {
                              turbo_frame: "side-panel-frame",
                              action: "click->side-panel#open",
                              side_panel_title_param: t('tasks.show.title')
                            } %>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-xs text-gray-500">
        <%= t('tasks.calendar.no_tasks_in_slot') %>
      </p>
    <% end %>
  </div>
</turbo-frame>
-e \n--- END OF FILE ---\n
app/views/tasks/calendar.html.erb
--- START OF FILE ---
<!-- app/views/tasks/calendar.html.erb -->
<% content_for :sidebar do %>
  <%= render "tasks/sidebar" %>
<% end %>

<div>
  <!-- 週移動ナビ -->
  <div class="flex items-center gap-2 text-xs text-gray-600 mb-3">
    <%= link_to t('common.prev_week'),
                tasks_path(view: :calendar, date: (@week_start - 7.days).to_s),
                class: "px-2 py-1 rounded border border-gray-300 hover:bg-gray-50" %>

    <span>
      <%= @week_start.strftime("%Y/%m/%d") %> 〜 <%= @week_end.strftime("%Y/%m/%d") %>
    </span>

    <%= link_to t('common.next_week'),
                tasks_path(view: :calendar, date: (@week_start + 7.days).to_s),
                class: "px-2 py-1 rounded border border-gray-300 hover:bg-gray-50" %>

    <%= link_to t('common.today'),
                tasks_path(view: :calendar),
                class: "px-2 py-1 rounded border border-gray-300 hover:bg-gray-50" %>
  </div>

    <!-- 共通変数 -->
    <% header_height = 48 %>              <%# ヘッダーの高さ（px）を共通化 %>
    <% column_height = 16 * 60 %>         <%# 8:00〜24:00 などを表現する高さ %>
    <% start_hour = @hours.first %>
    <% end_hour   = @hours.last %>        <%# ここでは +1 しない %>
    <% total_minutes = (end_hour - start_hour + 1) * 60 %>
    <% px_per_min = column_height.to_f / total_minutes %>

    <!-- カレンダー -->
    <div class="mt-8"> 
    <div class="border border-gray-300 rounded bg-white overflow-x-auto">

        <div class="flex min-w-[900px] text-[11px]">
            <!-- ▼ 左側：時間カラム -->
            <div class="w-10 border-r border-gray-300 bg-gray-50">
            <!-- 上のヘッダー（右の日付ヘッダーと高さを揃える） -->
            <div class="border-b border-gray-300 flex items-center justify-center text-[11px] text-gray-400"
                style="height: <%= header_height %>px;">
                <%= t('common.time') %>
            </div>

            <!-- 時間軸エリア -->
            <div class="relative" style="height: <%= column_height %>px;">
                <% (start_hour..end_hour).each do |h| %>
                <% minutes_from_start = (h - start_hour) * 60 %>
                <% top = minutes_from_start * px_per_min %>

                <div class="absolute left-0 right-0 border-t border-gray-100"
                    style="top: <%= top %>px;">
                    <span class="absolute right-1 top-0.5 text-[10px] text-gray-400">
                    <%= "%02d:00" % h %>
                    </span>
                </div>
                <% end %>
            </div>
            </div>

            <!-- ▼ 右側：日カラム -->
            <div class="flex-1 flex">
            <% @calendar_days.each do |date| %>
                <% day_tasks = @tasks_for_calendar.select { |t| t.due_at&.to_date == date } %>

                <!-- 1日ぶんの縦カラム -->
                <div class="flex-1 border-l border-gray-300">
                <!-- 日付ヘッダー（高さを header_height に合わせる） -->
                <div class="bg-gray-50 border-b border-gray-300
                            flex flex-col items-center justify-center text-center"
                    style="height: <%= header_height %>px;">
                    <div class="text-lg font-semibold leading-tight">
                    <%= date.strftime("%m/%d") %>
                    </div>
                    <div class="leading-tight">
                    <%= %w[Sun. Mon. Tue. Wed. Thu. Fri. Sat.][date.wday] %>
                    </div>
                </div>

            <!-- 時間軸エリア -->
            <div class="relative" style="height: <%= column_height %>px;">
                <% day_start = date.to_time.in_time_zone.change(hour: start_hour, min: 0) %>
                <% day_end   = date.to_time.in_time_zone.change(hour: end_hour,   min: 0) + 1.hour %>

                <!-- 背景の時間グリッド（横線） -->
                <% (start_hour..end_hour).each do |h| %>
                <% minutes_from_start = (h - start_hour) * 60 %>
                <% top = minutes_from_start * px_per_min %>

                <div class="absolute left-0 right-0 border-t border-gray-100"
                    style="top: <%= top %>px;">
                    <span class="absolute left-1 top-0.5 text-[10px] text-gray-300">
                    <%= "%02d:00" % h %>
                    </span>
                </div>
                <% end %>

                <% max_per_slot = 2 %> <%# この時間帯で横に並べる最大件数 %>
                <% slot_groups = Hash.new { |h, k| h[k] = [] } %>

                <% day_tasks.each do |task| %>
                    <% next unless task.due_at %>
                    <% display_time = task.due_at - 1.hour %>
                    <% slot_time = display_time.beginning_of_hour %>
                    <% slot_groups[slot_time] << task %>
                <% end %>

                <% slot_groups.sort.each do |slot_time, tasks_in_slot| %>
                    <% start_time = slot_time %>
                    <% end_time   = slot_time + 1.hour %>

                    <% start_clamped = [start_time, day_start].max %>
                    <% end_clamped   = [end_time,   day_end].min %>

                    <% duration = end_clamped - start_clamped %>
                    <% next if duration <= 0 %>

                    <% minutes_from_start = ((start_clamped - day_start) / 60).to_i %>
                    <% top_px = minutes_from_start * px_per_min %>
                    <% height_px = 18 %>

                    <% visible_tasks = tasks_in_slot.first(max_per_slot) %>
                    <% hidden_count  = [tasks_in_slot.size - max_per_slot, 0].max %>

                    <div class="absolute left-0 right-0 px-1"
                        style="top: <%= top_px %>px; height: <%= height_px %>px;">
                    <div class="flex gap-1 items-center">
                        <% visible_tasks.each do |task| %>
                        <% color_class =
                            case task.status
                            when "todo"        then "bg-red-100 text-red-700"
                            when "in_progress" then "bg-blue-100 text-blue-700"
                            when "done"        then "bg-green-100 text-green-700"
                            when "archived"    then "bg-yellow-100 text-yellow-800"
                            else                    "bg-gray-100 text-gray-600"
                            end
                        %>

                        <%= link_to task_path(task),
                            class: "flex-1 min-w-0 rounded text-[11px] px-2 py-0 " \
                                    "overflow-hidden truncate border border-gray-300 shadow-sm " \
                                    "hover:opacity-80 #{color_class}",
                            data: {
                                turbo_frame: "side-panel-frame",
                                action: "click->side-panel#open",
                                side_panel_title_param: task.title
                            } do %>
                            <!-- <span class="text-[10px]">T｜</span> -->
                            <span><%= task.title %></span>
                        <% end %>
                        <% end %>

                        <% if hidden_count > 0 %>
                        <%= link_to(
                                "+#{hidden_count}",
                                slot_tasks_path(
                                date: date.to_s,
                                hour: slot_time.hour
                                ),
                                class: "text-[11px] px-2 py-0.5 rounded-full bg-white/80
                                        border border-gray-300 text-gray-500 whitespace-nowrap font-semibold hover:bg-gray-100",
                                data: {
                                turbo_frame: "side-panel-frame",
                                action: "click->side-panel#open",
                                side_panel_title_param: "#{date.strftime('%m/%d')} #{slot_time.strftime('%H:%M')} のタスク"
                                }
                            ) %>
                        <% end %>
                    </div>
                    </div>
                <% end %>
                </div>
            </div>
            <% end %>
        </div>
        </div>
    </div>
</div>-e \n--- END OF FILE ---\n
app/views/tasks/_sidebar.html.erb
--- START OF FILE ---
<!-- app/views/tasks/_sidebar.html.erb -->

<h2 class="font-semibold text-lg mb-3">Task</h2>

<!-- ▼表示切り替え（リスト/カレンダー）+新規作成ボタン -->
<div class="mb-4 flex justify-between items-center text-sm">
  <div class="inline-flex items-center rounded-full border border-gray-300 bg-gray-50 p-0.5">
    <%= link_to t('tasks.sidebar.view_list'),
                tasks_path,
                class: "px-3 py-1 text-xs rounded-full " +
                        (@view_mode == "calendar" ?
                          "text-gray-500 hover:bg-white" :
                          "bg-white shadow text-gray-900") %>

    <%= link_to t('tasks.sidebar.view_calendar'),
                tasks_path(view: :calendar),
                class: "px-3 py-1 text-xs rounded-full " +
                        (@view_mode == "calendar" ?
                          "bg-white shadow text-gray-900" :
                          "text-gray-500 hover:bg-white") %>
  </div>
</div>

<div class="mb-4 flex justify-between items-center text-sm">
  <%= link_to t('tasks.sidebar.new_task'),
              new_task_path,
              class: "text-xs px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",
              data: {
                turbo_frame: "side-panel-frame",
                action: "click->side-panel#open",
                side_panel_title_param: t('tasks.sidebar.new_task')
              } %>
</div>

<nav class="space-y-1">
  <!-- 全体 -->
  <%= link_to t('tasks.sidebar.all_tasks'),
              tasks_path,
              class: nav_class(tasks_path) %>

  <!-- よくある絞り込み（あとで実装予定でもOK） -->
  <%= link_to t('tasks.sidebar.today_tasks'),
              tasks_path(filter: :today),
              class: nav_class(tasks_path(filter: :today)) %>

  <%= link_to t('tasks.sidebar.week_tasks'),
              tasks_path(filter: :this_week),
              class: nav_class(tasks_path(filter: :this_week)) %>

  <%= link_to t('tasks.sidebar.incomplete_tasks'),
              tasks_path(filter: :incomplete),
              class: nav_class(tasks_path(filter: :incomplete)) %>

  <%= link_to t('tasks.sidebar.done_tasks'),
              tasks_path(filter: :done),
              class: nav_class(tasks_path(filter: :done)) %>

  <hr class="my-3">
  
</nav>-e \n--- END OF FILE ---\n
app/views/tasks/edit.html.erb
--- START OF FILE ---
<!-- app/views/tasks/edit.html.erb -->
<turbo-frame id="side-panel-frame">
  <% unless turbo_frame_request? %>
    <% content_for :sidebar do %>
      <%= render "tasks/sidebar" %>
    <% end %>
    <h1 class="text-xl font-bold mb-4"><%= t('tasks.edit.title') %></h1>
  <% end %>

  <%= render "form", task: @task %>
</turbo-frame>
-e \n--- END OF FILE ---\n
app/views/tasks/show.html.erb
--- START OF FILE ---
<!-- app/views/tasks/show.html.erb -->

<turbo-frame id="side-panel-frame">
  <% unless turbo_frame_request? %>
    <% content_for :sidebar do %>
      <%= render "tasks/sidebar" %>
    <% end %>
  <% end %>

  <!-- 1行目：タイトル -->
  <h1 class="text-xl font-bold mb-2"><%= @task.title %></h1>

  <!-- 2行目：期限 ｜ 担当者 ｜ 作成者 -->
  <div class="flex flex-wrap items-center text-sm text-gray-700 mb-1">
    <!-- 期限 -->
      <div class="flex items-center gap-1">
        <span class="text-gray-500"><%= t('tasks.show.due_date') %></span>
        <span>
          <%= due_badge(@task) %>
        </span>
      </div>

    <!-- 区切り：薄いグレーの ｜ -->
    <span class="mx-2 text-gray-300">｜</span>

    <!-- 担当者 -->
    <div class="flex items-center gap-1 flex-wrap">
      <span class="text-gray-500"><%= t('tasks.show.assignee') %></span>
      <% if @task.assignees.any? %>
        <% @task.assignees.each do |profile| %>
          <%= profile_chip(
                profile,
                size: :xs,
                wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-xs mr-1 mb-1"
              ) %>
        <% end %>
      <% else %>
        <span class="text-xs text-gray-400"><%= t('common.not_set') %></span>
      <% end %>
    </div>

    <!-- 区切り -->
    <span class="mx-2 text-gray-300">｜</span>

    <!-- 作成者 -->
    <div class="flex items-center gap-1">
      <span class="text-gray-500"><%= t('tasks.show.owner') %></span>
      <% if @task.owner_profile %>
        <%= profile_chip(
              @task.owner_profile,
              size: :xs,
              wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-xs"
            ) %>
      <% else %>
        <span class="text-xs text-gray-400"><%= t('common.unknown') %></span>
      <% end %>
    </div>
  </div>

  <!-- 3行目：ステータス ＋ ピン留めコメント概要 -->
  <div class="flex flex-wrap items-center gap-4 text-sm text-gray-700 mb-3">
    <!-- ステータス -->
      <div class="flex items-center gap-1">
        <span class="text-gray-500"><%= t('tasks.show.status') %></span>
        <span class="ml-1">
          <%= status_badge(@task) %>
        </span>
        <!-- 即時変更用プルダウン -->
        <%= form_with model: @task,
                      url: task_path(@task),
                      method: :patch,
                      data: { turbo_frame: "side-panel-frame" },
                      class: "inline-block" do |f_task| %>
          <%= f_task.select :status,
                            Task.statuses.keys.map { |k| [k, k] },
                            { selected: @task.status },
                            class: "border border-gray-300 rounded px-2 py-1",
                            onchange: "this.form.submit();" %>
        <% end %>
      </div>

    <% if @task.pinned_comments.any? %>
      <!-- 区切り：薄いグレーの ｜ -->
      <span class="text-gray-300">｜</span>

      <% main_pinned = @task.pinned_comments.first %>

      <!-- ピン留めコメント概要 -->
      <div class="flex items-center gap-1 min-w-0">
        <span class="text-gray-500 text-[11px]">
          ピン
          <% if @task.pinned_comments.size > 1 %>
            (<%= @task.pinned_comments.size %>)
          <% end %>
        </span>

        <%= profile_chip(
              main_pinned.author_profile,
              size: :xs,
              wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-[11px]"
            ) %>

        <!-- コメント本文は1行だけ、省略表示 -->
        <span class="text-[11px] text-gray-600 truncate max-w-xs">
          <%= h(main_pinned.body) %>
        </span>
      </div>
    <% end %>
  </div>


  <!-- 操作ボタン -->
  <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
    <%= link_to t('common.edit'),
                edit_task_path(@task),
                class: "px-2 py-1 bg-gray-50 border border-gray-300 rounded hover:bg-gray-100",
                data: {
                  turbo_frame: "side-panel-frame",
                  action: "click->side-panel#open",
                  side_panel_title_param: t('tasks.show.edit_title')
                } %>

    <%= button_to "削除",
                task_path(@task),
                method: :delete,
                form: {data: { turbo_confirm: t('tasks.index.confirm_delete') }},
                class: "ml-auto px-2 py-1 bg-red-50 text-red-700 border border-red-200 rounded hover:bg-red-100" %>
  </div>

  <!-- コメント一覧 -->
  <div class="mt-4 pt-3 border-t border-gray-300">
    <h2 class="text-sm font-semibold mb-2"><%= t('tasks.show.comment_title') %></h2>

    <div class="space-y-3 mb-3">
      <%= render partial: "comments/comment",
                  collection: @task.comments.includes(:author_profile).order(:created_at),
                  as: :comment %>

      <% if @task.comments.empty? %>
        <p class="text-xs text-gray-400"><%= t('tasks.show.no_comments') %></p>
      <% end %>
    </div>

    <!-- 新規コメントフォーム -->
    <div class="mt-3">
      <h3 class="text-xs text-gray-500 mb-1"><%= t('tasks.show.new_comment') %></h3>
      <%= render "comments/form", task: @task, comment: @task.comments.build %>
    </div>
  </div>
</turbo-frame>
-e \n--- END OF FILE ---\n
app/views/tasks/update.turbo_stream.erb
--- START OF FILE ---
<!-- app/views/tasks/update.turbo_stream.erb -->
<%# 一覧画面の該当行だけを最新のパーシャルで差し替える %>
<%= turbo_stream.replace dom_id(@task), partial: "tasks/task_row", locals: { task: @task } %>

<%# サイドパネルが開いている場合、その中身も最新にする %>
<%= turbo_stream.replace "side-panel-frame", template: "tasks/show" %>

<%# 通知（フラッシュメッセージ）を更新する %>
<%= turbo_stream.prepend "flash", partial: "shared/flash" %>-e \n--- END OF FILE ---\n
app/views/tasks/_form.html.erb
--- START OF FILE ---
<!-- app/views/tasks/_form.html.erb -->
<%= form_with model: @task,
              local: true,
              data: (@task.new_record? ? { turbo_frame: "_top" } : {}) do |f| %>
  <% if @task.errors.any? %>
    <div class="mb-4 p-3 bg-red-50 text-red-700 rounded text-sm">
      <p class="font-semibold">
        <%= t('errors.template.header', count: @task.errors.count, model: Task.model_name.human) %>
      </p>
      <ul class="list-disc list-inside">
        <% @task.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- タイトル -->
  <div class="mb-4">
    <%= f.label :title, t('tasks.form.title'), class: "block text-sm mb-1" %>
    <%= f.text_field :title,
                     class: "border border-gray-300 rounded px-2 py-1 w-full text-sm",
                     placeholder: t('tasks.form.title') %>
  </div>

  <!-- 期限 -->
  <div class="mb-4">
    <%= f.label :due_date, t('tasks.form.due_date'), class: "block text-sm mb-1" %>

    <div class="flex items-center gap-2">
      <!-- 日付：カレンダーで選ぶ -->
      <%= f.date_field :due_date,
                       value: (@task.due_date || @task.due_at&.to_date),
                       class: "border border-gray-300 rounded px-2 py-1 text-sm" %>

      <span class="text-sm text-gray-500"><%= t('tasks.form.due_time') %></span>

      <!-- 時刻：テキスト入力のみ（30分単位を想定） -->
      <%= f.text_field :due_time,
                       value: (@task.due_time || @task.due_at&.strftime("%H:%M")),
                       class: "border border-gray-300 rounded px-2 py-1 text-sm w-20",
                       placeholder: "23:30",
                       inputmode: "numeric",
                       pattern: "[0-2][0-9]:(00|30)" %>
    </div>

    <p class="text-[11px] text-gray-500 mt-1">
      <%= t('tasks.form.due_hint') %>
    </p>
  </div>

  <!-- 担当者 -->
    <div class="mb-4">
      <%= f.label :assignee_ids, t('tasks.form.assignees'), class: "block text-sm mb-1" %>

      <div class="flex flex-wrap gap-2">
        <%= f.collection_check_boxes :assignee_ids,
                                    @assignee_candidates,
                                    :id,
                                    :display_name do |b| %>
          <label class="inline-flex items-center px-2 py-1 rounded-full border border-gray-300 bg-gray-50 cursor-pointer text-xs">
            <!-- 実際のチェックボックス（地味でもOK） -->
            <%= b.check_box(class: "mr-1") %>

            <!-- アイコン＋名前 -->
            <%= profile_avatar(b.object, size: :xs) %>
            <span class="ml-1"><%= b.object.display_name %></span>
          </label>
        <% end %>
      </div>

      <p class="text-[11px] text-gray-500 mt-1">
        <%= t('tasks.form.assignee_hint') %>
      </p>
    </div>

  <!-- 詳細 -->
  <div class="mb-4">
    <%= f.label :description, t('tasks.form.description'), class: "block text-sm mb-1" %>
    <%= f.text_area :description,
                    rows: 4,
                    class: "border border-gray-300 rounded px-2 py-1 w-full text-sm" %>
  </div>

  <!-- タグ -->
  <div class="mb-4">
    <%= f.label :tag_list, t('tasks.form.tags'), class: "block text-sm mb-1" %>
    <%= f.text_field :tag_list,
                     value: @task.tag_list,
                     class: "border border-gray-300 rounded px-2 py-1 w-full text-sm",
                     placeholder: t('tasks.form.tag_placeholder') %>
    <p class="text-[11px] text-gray-500 mt-1">
      <%= t('tasks.form.tag_hint') %>
    </p>
  </div>

  <!-- ステータス -->
  <div class="mb-4">
    <%= f.label :status, t('tasks.form.status'), class: "block text-sm mb-1" %>
    <%= f.select :status,
                 Task.statuses.keys.map { |k| [k, k] },
                 {},
                 class: "border border-gray-300 rounded px-2 py-1 w-full text-sm" %>
  </div>

  <%= f.submit (@task.new_record? ? t('tasks.form.submit_create') : t('tasks.form.submit_update')),
             class: "px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" %>
<% end %>-e \n--- END OF FILE ---\n
app/views/tasks/new.html.erb
--- START OF FILE ---
<!-- app/views/tasks/new.html.erb -->
<turbo-frame id="side-panel-frame">
  <% unless turbo_frame_request? %>
    <!-- 直接 /tasks/new にアクセスしたときだけページタイトルを出す -->
    <h1 class="text-xl font-bold mb-4"><%= t('tasks.new.title') %></h1>
  <% end %>

  <%= render "form", task: @task %>
</turbo-frame>
-e \n--- END OF FILE ---\n
app/views/shared/_flash.html.erb
--- START OF FILE ---
<!-- app/views/shared/_flash.html.erb -->
<% flash.each do |flash_type, message| %>
  <div class="flash-message p-4 mb-4 text-sm rounded-lg <%= flash_type == 'notice' ? 'bg-blue-50 text-blue-700' : 'bg-red-50 text-red-700' %>" 
       data-controller="removable">
    <%= message %>
  </div>
<% end %>-e \n--- END OF FILE ---\n
app/views/shared/_side_panel.html.erb
--- START OF FILE ---
<!-- app/views/shared/_side_panel.html.erb -->

<div
  data-side-panel-target="panel"
  class="fixed top-0 right-0 h-full bg-white shadow-lg border-l border-gray-300
         translate-x-full transition-transform duration-200 ease-out
         flex flex-col z-40"
  style="width: 480px;"
>
  <!-- 左端リサイズ用ハンドル -->
  <div
    data-side-panel-target="resizeHandle"
    data-action="mousedown->side-panel#startResize"
    class="absolute left-0 top-0 h-full w-1 cursor-col-resize bg-transparent"
  ></div>

  <!-- ヘッダー -->
  <div class="flex items-center justify-between px-3 py-2 border-b border-gray-300">
    <h2 class="text-sm font-semibold" data-side-panel-target="title">
      <!-- タイトルはリンク側から渡す -->
    </h2>
    <button
      type="button"
      class="text-xs text-gray-500 hover:text-gray-800"
      data-action="click->side-panel#close"
    >
      ✕
    </button>
  </div>

  <!-- 中身：Turbo Frame で差し替わる -->
  <div class="flex-1 overflow-y-auto p-3">
    <turbo-frame id="side-panel-frame">
      <p class="text-xs text-gray-400">
        ここに、新規タスク作成フォームなどが表示されます。
      </p>
    </turbo-frame>
  </div>
</div>-e \n--- END OF FILE ---\n
app/views/layouts/application.html.erb
--- START OF FILE ---
<!-- app/views/layouts/application.html.erb -->
<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Todo Beaver" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# <link rel="manifest" href="/manifest.json"> %>
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="bg-white">
    <% if submit_mode? %>
      <div class="fixed top-0 inset-x-0 z-20 text-xs px-3 py-2 bg-amber-50 text-amber-800 border-b border-amber-200">
        <%= t('layouts.application.submit_mode') %>
      </div>
    <% end %>
    <!-- ヘッダー -->
      <header class="fixed <%= submit_mode? ? 'top-8' : 'top-0' %> inset-x-0 shadow-sm z-10 <%= header_theme_class %>">
        <div class="w-full h-16 px-4 flex items-center">
          <!-- 1段：左 = プロフィール + ナビ / 右 = ロゴ -->
          <div class="flex items-center justify-between w-full">
            <!-- 左側：プロフィールブロック + ナビブロック -->
            <div class="flex items-center gap-8">
              <!-- プロフィール表示 + プロフィール切替 + ドロップダウン -->
              <div class="flex items-center gap-4">
                <% if user_signed_in? && current_user.profiles.any? && current_profile %>
                  <!-- プロフィールアイコン＋名前（クリックでメニュー） -->
                  <details class="relative">
                    <summary class="list-none cursor-pointer">
                      <%= profile_chip(
                            current_profile,
                            size: :sm,
                            wrapper_class: "text-sm font-semibold"
                          ) %>
                    </summary>

                    <!-- ドロップダウンメニュー -->
                    <div class="absolute mt-2 left-0 w-40 bg-white border border-gray-300 rounded shadow text-sm z-50">
                      <%= button_to t('layouts.application.menu.logout'),
                        destroy_user_session_path,
                        method: :delete,
                        form: { data: { turbo_confirm: t('layouts.application.menu.confirm_logout') } }, 
                        class: "block w-full text-left px-3 py-2 text-gray-700 hover:bg-gray-100 bg-transparent border-0" %>
                    </div>
                  </details>

                  <!-- プロフィール切り替えセレクト -->
                  <div>
                    <%= form_with url: switch_profiles_path, method: :post, local: true do |f| %>
                      <%= f.select :profile_id,
                                  options_from_collection_for_select(
                                    current_user.profiles,
                                    :id,
                                    :label,
                                    current_profile&.id
                                  ),
                                  {},
                                  class: "border border-gray-300 rounded px-3 py-1 text-sm text-gray-700 bg-white",
                                  onchange: "this.form.submit();" %>
                    <% end %>
                  </div>
                <% end %>
              </div>

              <!-- プロフィールの右に少し空けて、左詰めでナビ -->
              <% if user_signed_in? %>
                <nav class="flex items-center gap-3">
                  <!-- タスク -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "beaver_icon.png",
                                  alt: "Task",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.task') %></span>
                  <% end %>

                  <!-- ワークス -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "owl_icon.png",
                                  alt: "Works",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.works') %></span>
                  <% end %>

                  <!-- チャット -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "wolf_icon.png",
                                  alt: "Chat",
                                  class: "block",
                                  style: "height: 27px; width: auto;" %>
                    <span><%= t('layouts.application.nav.chat') %></span>
                  <% end %>

                  <!-- ソーシャル -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "rabbit_icon.png",
                                  alt: "Social",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.social') %></span>
                  <% end %>                  
                  
                  <!-- プロフィール -->
                  <%= link_to edit_profile_path(current_profile),
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "butterfly_icon.png",
                                  alt: "Profile",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.profile') %></span>
                  <% end %>

                  <!-- チーム -->
                  <% if @team.present? && @team.persisted? %>
                    <%= link_to edit_team_path(@team),
                                class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                      <%= image_tag "elephant_icon.png", alt: "Team", class: "w-5 h-5" %>
                      <span class="truncate max-w-[150px]"><%= @team.name %></span>
                    <% end %>
                  <% else %>
                    <%# チームが未選択、または新規作成画面などの場合の表示 %>
                    <div class="text-lg font-semibold px-3 py-1 flex items-center gap-1 opacity-50">
                      <%= image_tag "elephant_icon.png", alt: "Team", class: "w-5 h-5" %>
                      <span>Team</span>
                    </div>
                  <% end %>
              

                  <% if controller_name == "tasks" %>
                    <div class="ml-4">
                      <%= form_with url: tasks_path, method: :get, local: true,
                                    class: "flex items-center gap-1" do %>

                        <!-- 今の検索・フィルタ状態を引き継ぐ -->
                        <%= hidden_field_tag :q, params[:q] if params[:q].present? %>
                        <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>
                        <%= hidden_field_tag :sort, params[:sort] if params[:sort].present? %>
                        <%= hidden_field_tag :direction, params[:direction] if params[:direction].present? %>
                        <%= hidden_field_tag :view, params[:view] if params[:view].present? %>

                        <label class="flex items-center gap-1 text-xs">
                          <%= check_box_tag :all_profiles,
                                            "1",
                                            params[:all_profiles] == "1",
                                            onchange: "this.form.submit();" %>
                          <span><%= t('layouts.application.nav.all_profiles_tasks') %></span>
                        </label>
                      <% end %>
                    </div>
                  <% end %>
                </nav>
                <% end %>
            </div>

            <!-- 右側：ロゴ（イラスト） -->
            <div class="flex items-center">
              <%= link_to root_path, class: "flex items-center gap-2" do %>
                <%= image_tag "forestly_logo.png",
                              alt: "forestly",
                              class: "block",
                              style: "height: 45px; width: auto;" %>
              <% end %>
            </div>
          </div>
        </div>
      </header>

    <!-- メインコンテンツ -->
    <main class="<%= submit_mode? ? 'pt-24' : 'pt-16' %> pb-0">
      <% if notice %>
        <div class="mb-4 bg-green-100 text-green-800 px-4 py-2 rounded">
          <%= notice %>
        </div>
      <% end %>
      <% if alert %>
        <div class="mb-4 bg-red-100 text-red-800 px-4 py-2 rounded">
          <%= alert %>
        </div>
      <% end %>

      <div
        class="flex gap-0 min-h-[calc(100vh-4rem)]"
        data-controller="side-panel"
        data-side-panel-initial-width-value="480"
      >
        <% if content_for?(:sidebar) %>
          <aside class="w-60 shrink-0 px-4 pt-3 pb-6 self-stretch <%= sidebar_theme_class %>">
            <%= yield :sidebar %>
          </aside>

          <section class="flex-1 bg-white px-6 pt-3 pb-6 overflow-auto">
            <%= yield %>
          </section>
        <% else %>
          <section class="flex-1 bg-white px-6 pt-3 pb-6">
            <%= yield %>
          </section>
        <% end %>

      <!-- 共通サイドパネルを描画 -->
      <%= render "shared/side_panel" %>
      </div>
    </main>

    <!-- Tailwind に yellow系クラスを認識させるためのダミー要素（画面には表示されません） -->
    <span class="hidden
      bg-slate-800 bg-slate-900
      bg-indigo-700 bg-indigo-800
      bg-emerald-700 bg-emerald-800
      bg-rose-700 bg-rose-800
      bg-amber-700 bg-amber-800
      text-white
      bg-white/10 text-white/80 hover:bg-white/10 hover:text-white
    "></span>

  </body>
</html>

-e \n--- END OF FILE ---\n
app/views/layouts/mailer.html.erb
--- START OF FILE ---
<!-- app/views/layouts/miler.html.erb -->
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
      /* Email styles need to be inline */
    </style>
  </head>

  <body>
    <%= yield %>
  </body>
</html>
-e \n--- END OF FILE ---\n
app/views/layouts/mailer.text.erb
--- START OF FILE ---
<%= yield %>
-e \n--- END OF FILE ---\n
app/views/users/confirmations/confirm_change_email.html.erb
--- START OF FILE ---
<!-- app/views/users/confirmations/confirm_change_email.html.erb -->
<h1 class="text-xl font-bold mb-4">
  <%= t('users.confirmations.edit_email_title') %>
</h1>

<p class="mb-4">
  <%= t('users.confirmations.new_email_label') %>：
  <span class="font-semibold"><%= resource.unconfirmed_email %></span>
</p>

<%= form_with url: user_confirmation_path, method: :post, local: true do %>
  <%= hidden_field_tag :confirmation_token, @confirmation_token %>
  <%= submit_tag t('users.confirmations.submit_confirm'),
                 class: "px-4 py-2 rounded bg-blue-600 text-white" %>
<% end %>
-e \n--- END OF FILE ---\n
app/views/pwa/manifest.json.erb
--- START OF FILE ---
{
  "name": "TodoBeaver",
  "icons": [
    {
      "src": "/icon.png",
      "type": "image/png",
      "sizes": "512x512"
    },
    {
      "src": "/icon.png",
      "type": "image/png",
      "sizes": "512x512",
      "purpose": "maskable"
    }
  ],
  "start_url": "/",
  "display": "standalone",
  "scope": "/",
  "description": "TodoBeaver.",
  "theme_color": "red",
  "background_color": "red"
}
-e \n--- END OF FILE ---\n
app/views/teams/index.html.erb
--- START OF FILE ---
<!-- app/views/teams/index.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4"><%= t('teams.index.title') %></h1>

<div class="mb-4">
  <%= link_to t('teams.index.new_team'),
              new_team_path,
              class: "text-sm px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" %>
</div>

<table class="w-full text-sm">
  <thead>
    <tr class="border-b">
      <th class="text-left py-2"><%= t('activerecord.attributes.team.name') %></th>
      <th class="text-left py-2"><%= t('common.created_at') %></th>
      <th class="text-left py-2"></th>
    </tr>
  </thead>
  <tbody>
    <% @teams.each do |team| %>
      <tr class="border-b">
        <td class="py-2">
          <%= link_to team_path(team), class: "inline-block" do %>
            <%= team_chip(
                  team,
                  size: :xs,
                  wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                ) %>
          <% end %>
        </td>
        <td class="py-2"><%= t(team.created_at.to_date) %></td>
        <td class="py-2">
          <%= link_to t('common.edit'), edit_team_path(team), class: "text-xs text-gray-600 underline mr-2" %>
        <%= button_to t('common.delete'),
          team_path(team),
          method: :delete,
          form: { data: { turbo_confirm: t('common.confirm_delete') } },
          class: "text-xs text-red-600 underline bg-transparent border-0 p-0 inline" %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
-e \n--- END OF FILE ---\n
app/views/teams/manage.html.erb
--- START OF FILE ---
<!-- app/views/teams/manage.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4"><%= t('teams.members.title') %></h1>

<div class="flex items-center mb-6">
  <%= team_chip(
        @team,
        size: :sm,
        wrapper_class: "px-2 py-1 rounded bg-gray-100 text-sm"
      ) %>
  <span class="ml-2 text-sm text-gray-500"><%= t('teams.members.suffix_of_team') %></span>
</div>

<% if @memberships.any? %>
  <table class="w-full text-sm mb-4">
    <thead>
      <tr class="border-b">
        <th class="text-left py-2"><%= t('activerecord.models.profile') %></th>
        <th class="text-left py-2"><%= t('teams.members.role') %></th>
        <th class="text-left py-2"></th>
      </tr>
    </thead>
    <tbody>
      <% @memberships.each do |membership| %>
        <tr>
          <td class="py-1">
            <%= profile_chip(
              membership.profile,
              size: :xs,
              wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
            ) %>
          </td>

          <td class="py-2">
            <% if @can_manage_members %>
              <%= form_with model: membership,
                            url: team_membership_path(membership),
                            method: :patch,
                            local: true,
                            class: "inline-block" do |f| %>
                <%= f.select :role,
                            options_for_select(
                              [
                                [t('teams.members.roles.admin'), TeamMembership::ADMIN_ROLE],
                                [t('teams.members.roles.member'), ""]
                              ],
                              membership.admin? ? TeamMembership::ADMIN_ROLE : ""
                            ),
                            {},
                            class: "border border-gray-300 rounded px-2 py-1 text-xs",
                            onchange: "this.form.submit();" %>
              <% end %>
            <% else %>
              <%= membership.admin? ? t('teams.members.roles.admin') : t('teams.members.roles.member') %>
            <% end %>
          </td>

          <td class="py-2 text-right">
            <% if @can_manage_members %>
              <%= button_to t('common.delete'),
                            team_membership_path(membership),
                            method: :delete,
                            form: { data: { turbo_confirm: t('teams.members.confirm_remove') }},
                            class: "text-xs px-3 py-1 bg-red-50 text-red-700 rounded border border-red-200 hover:bg-red-100" %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p class="text-sm text-gray-500 mb-4">
    <%= t('teams.members.no_members') %>
  </p>
<% end %>

<div class="mt-6 border-t pt-4">
  <h3 class="text-sm font-semibold mb-2"><%= t('teams.members.invite_section_title') %></h3>

  <%# 送信先を manage_team_path(@team) に変更 %>
  <%= form_with url: manage_team_path(@team), method: :get, local: true, class: "flex items-end gap-2 mb-3" do %>
    <div>
      <label class="block text-xs mb-1"><%= t('teams.members.invite_id_label') %></label>
      <%= text_field_tag :profile_invite_token, @profile_invite_token, 
                        class: "border rounded px-2 py-1 text-sm", placeholder: "個人のIDを入力" %>
    </div>
    <div class="mb-1">
      <%= submit_tag t('common.search'), class: "px-3 py-2 text-xs bg-gray-100 rounded border hover:bg-gray-200" %>
    </div>
  <% end %>

  <% if @found_profile %>
    <div class="p-3 bg-blue-50 border border-blue-200 rounded flex items-center justify-between">
      <div class="flex items-center gap-2">
        <%= profile_chip(@found_profile, size: :xs) %>
        <span class="text-xs text-gray-600"><%= t('teams.members.invite_confirm_msg') %></span>
      </div>
      <%= form_with url: membership_requests_path, method: :post, local: true do %>
        <%= hidden_field_tag :direction, "team_to_profile" %>
        <%= hidden_field_tag :team_id, @team.id %>
        <%= hidden_field_tag :target_profile_id, @found_profile.id %>

        <label class="inline-flex items-center gap-1 cursor-pointer">
          <%= check_box_tag :admin, "1", false, class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
          <span class="text-xs text-gray-700 font-medium"><%= t('teams.members.invite_as_admin') %></span>
        </label>

        <%= submit_tag t('teams.members.send_invite'), class: "px-4 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700" %>
      <% end %>
    </div>
  <% end %>
</div>

<div class="mt-6 border-t pt-4">
  <h3 class="text-sm font-semibold mb-2"><%= t('teams.members.join_requests_title') %></h3>

  <% if @incoming_join_requests.any? %>
    <table class="w-full text-xs">
      <thead>
        <tr class="border-b">
          <th class="text-left py-1"><%= t('teams.members.requester') %></th>
          <th class="text-left py-1"></th>
        </tr>
      </thead>
      <tbody>
        <% @incoming_join_requests.each do |req| %>
          <tr class="border-b">
            <td class="py-1">
              <% if req.requester_profile %>
                <%= profile_chip(
                      req.requester_profile,
                      size: :xs,
                      wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                    ) %>
              <% else %>
                <span class="text-xs text-gray-400"><%= t('common.unknown') %></span>
              <% end %>
            </td>
            <td class="py-1 text-right">
              <%= button_to t('common.approve'),
                            approve_membership_request_path(req),
                            method: :patch,
                            class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-xs text-gray-500 mt-2"><%= t('teams.members.no_requests') %></p>
  <% end %>
</div>-e \n--- END OF FILE ---\n
app/views/teams/_sidebar.html.erb
--- START OF FILE ---
<!-- app/views/teams/_sidebar.html.erb -->
<h2 class="font-semibold text-sm mb-3"><%= t('teams.settings.sidebar.title') %></h2>
<nav class="space-y-1">
  <%# チームのトップページ（show） %>
  <%= link_to t('teams.settings.sidebar.show'), 
              team_path(@team), 
              class: nav_class(team_path(@team)) %>

  <%# メンバー管理（manage） %>
  <%= link_to t('teams.settings.sidebar.manage'), 
              manage_team_path(@team), 
              class: nav_class(manage_team_path(@team)) %>

  <%# チーム編集（edit） %>
  <%= link_to t('teams.settings.sidebar.edit'), 
              edit_team_path(@team), 
              class: nav_class(edit_team_path(@team)) %>

  <div class="pt-4 border-t border-gray-100 mt-4">
    <%= link_to t('teams.index.new_team'), 
                new_team_path, 
                class: nav_class(new_team_path) %>
  </div>
</nav>-e \n--- END OF FILE ---\n
app/views/teams/edit.html.erb
--- START OF FILE ---
<!-- app/views/teams/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">チーム編集</h1>
<%= render "form", team: @team %>-e \n--- END OF FILE ---\n
app/views/teams/home.html.erb
--- START OF FILE ---
<!-- app/views/teams/home.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">チーム設定ホーム</h1>

<p class="text-sm text-gray-600">
  所属チームの一覧や設定への入口をここに配置していく想定です。
</p>-e \n--- END OF FILE ---\n
app/views/teams/show.html.erb
--- START OF FILE ---
<!-- app/views/teams/show.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4"><%= @team.name %></h1>

<p class="text-sm text-gray-600 mb-4">
  <%= t('common.created_at') %>：<%= l(@team.created_at.to_date) %>
</p>

<div class="flex gap-3 text-sm">
  <%= link_to t('common.edit'), edit_team_path(@team), class: "px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" %>
  <%= link_to t('common.back'), teams_path, class: "px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" %>
</div>-e \n--- END OF FILE ---\n
app/views/teams/_form.html.erb
--- START OF FILE ---
<!-- app/views/teams/_form.html.erb -->
<%= form_with model: @team, local: true do |f| %>
  <% if @team.errors.any? %>
    <div class="mb-4 text-sm text-red-700 bg-red-50 px-3 py-2 rounded border border-red-200">
      <p class="font-semibold mb-1">
        <%= t('errors.template.header', count: @team.errors.count, model: t('activerecord.models.team')) %>
      </p>
      <ul class="list-disc list-inside">
        <% @team.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-6 max-w-md">
    <%= f.label :name, class: "block text-sm font-medium mb-1" %>
    <%= f.text_field :name,
                     class: "w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500",
                     placeholder: t('activerecord.placeholders.team.name') %>
  </div>

  <div class="mb-6">
    <%= f.label :avatar, class: "block text-sm font-medium mb-1" %>

    <% if @team.avatar.attached? %>
      <div class="mb-3">
        <%= team_avatar(@team, size: :md) %>
      </div>
    <% end %>

    <div class="flex items-center gap-3">
      <%= f.label :avatar,
                  class: "px-3 py-1.5 border border-gray-300 rounded text-sm bg-white cursor-pointer hover:bg-gray-50 transition" do %>
        <%= t('profiles.form.choose_file') %>
      <% end %>

      <span id="team-avatar-filename" class="text-xs text-gray-500">
        <%= t('profiles.form.no_file_selected') %>
      </span>

      <%= f.file_field :avatar,
                       accept: "image/*",
                       class: "hidden",
                       onchange: "document.getElementById('team-avatar-filename').textContent = this.files[0]?.name || '#{t('profiles.form.no_file_selected')}';" %>
    </div>

    <% if @team.avatar.attached? %>
      <label class="mt-3 inline-flex items-center text-xs text-red-600 cursor-pointer">
        <%= f.check_box :remove_avatar, class: "mr-1 rounded border-gray-300 text-red-600 focus:ring-red-500" %>
        <%= t('common.remove_image') %>
      </label>
    <% end %>
  </div>
  
  <div class="pt-2">
    <%= f.submit t("helpers.submit.#{@team.new_record? ? 'create' : 'update'}", model: t('activerecord.models.team')),
                 class: "px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded shadow-sm hover:bg-blue-700 transition cursor-pointer" %>
  </div>
<% end %>
-e \n--- END OF FILE ---\n
app/views/teams/new.html.erb
--- START OF FILE ---
<!-- app/views/teams/new.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4"><%= t('teams.new.title') %></h1>
<%= render "form", team: @team %>
-e \n--- END OF FILE ---\n
app/views/profiles/index.html.erb
--- START OF FILE ---
<!-- app/views/profiles/index.html.erb -->
<div class="p-8">
  <h1 class="text-2xl font-bold mb-4"><%= t('profiles.index.title') %></h1>

  <div class="mb-4">
    <%= link_to t('profiles.index.new_link'), new_profile_path,
                class: "inline-block px-3 py-1 bg-blue-600 text-white rounded" %>
  </div>

  <% if @profiles.any? %>
    <table class="min-w-full text-sm">
      <thead>
        <tr>
          <th class="text-left p-2"><%= t('profiles.index.column_name') %></th>
          <th class="text-left p-2"><%= t('profiles.index.column_theme') %></th>
          <th class="text-left p-2"><%= t('profiles.index.column_actions') %></th>
        </tr>
      </thead>
      <tbody>
        <% @profiles.each do |profile| %>
          <tr class="border-t">
            <td class="p-2"><%= link_to profile.label, profile %></td>
            <td class="p-2"><%= profile.theme.presence || "-" %></td>
            <td class="p-2 space-x-2">
              <%= link_to t('common.edit'), edit_profile_path(profile),
                          class: "text-blue-600 underline" %>
              <%= button_to t('common.delete'),
                profile_path(profile),
                method: :delete,
                form: { data: { turbo_confirm: t('common.confirm_delete') } },
                class: "text-red-600 underline text-xs bg-transparent border-0 p-0 inline" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p><%= t('profiles.index.no_profiles') %></p>
  <% end %>
</div>-e \n--- END OF FILE ---\n
app/views/profiles/_sidebar.html.erb
--- START OF FILE ---
<!-- app/views/profiles/_sidebar.html.erb -->
<h2 class="font-semibold text-sm mb-3"><%= t('profile_settings.sidebar.title') %></h2>
<nav class="space-y-1">

<%= link_to t('profile_settings.sidebar.home'),
            edit_profile_path(@profile),
            class: nav_class(edit_profile_path(@profile)) %>

<%= link_to t('profile_settings.sidebar.edit'),
            edit_profile_path(@profile),
            class: nav_class(edit_profile_path(@profile)) %>

<%= link_to t('profile_settings.sidebar.new'),
            new_profile_path,
            class: nav_class(new_profile_path) %>

<%= link_to t('profile_settings.sidebar.auth'),
            edit_user_registration_path,
            class: nav_class(edit_user_registration_path) %>
</nav>-e \n--- END OF FILE ---\n
app/views/profiles/edit.html.erb
--- START OF FILE ---
<!-- app/views/profiles/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render "profiles/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4"><%= t('profile_settings.edit.title') %></h1>

<% if @profile %>
  <%= render "profiles/form", profile: @profile %>

  <!-- ▼ チームIDでチームに参加申請する ▼ -->
  <div class="mt-6 border-t pt-4">
    <h3 class="text-sm font-semibold mb-2"><%= t('profile_settings.edit.search_team_title') %></h3>

    <%= form_with url: edit_profile_path(current_profile), method: :get, local: true,
                  class: "flex flex-wrap items-end gap-2 mb-3" do %>
      <div>
        <label class="block text-xs mb-1"><%= t('profile_settings.edit.team_invite_token') %></label>
        <%= text_field_tag :team_invite_token,
                          @team_invite_token,
                          class: "border rounded px-2 py-1 text-sm",
                          placeholder: "例）AB12CD34" %>
      </div>
      <div class="mb-1">
        <%= submit_tag t('profile_settings.edit.search_button'),
                      class: "px-3 py-2 text-xs bg-gray-100 rounded border hover:bg-gray-200" %>
      </div>
    <% end %>

    <% if @team_invite_token.present? %>
      <% if @invite_teams.any? %>
        <div class="p-3 bg-blue-50 border border-blue-200 rounded">
          <% @invite_teams.each do |team| %>
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div class="flex items-center gap-2">
                <%= team_chip(team, size: :xs) %>
                <span class="text-xs text-gray-600 font-medium">
                  <%= t('profile_settings.edit.ask_membership_request') %>
                </span>
              </div>

              <%= form_with url: membership_requests_path, method: :post, local: true, class: "flex items-center gap-4" do %>
                <%= hidden_field_tag :direction, "profile_to_team" %>
                <%= hidden_field_tag :team_id, team.id %>
                
                <label class="inline-flex items-center gap-1 cursor-pointer">
                  <%= check_box_tag :admin, "1", false, class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
                  <span class="text-xs text-gray-700">
                    <%= t('profile_settings.edit.apply_as_admin') %>
                  </span>
                </label>

                <%= submit_tag t('common.filter_apply'),
                              class: "px-4 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm" %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-xs text-red-500 mt-2">
          <%= t('profile_settings.edit.team_not_found') %>
        </p>
      <% end %>
    <% end %>
  </div>
 

  <%# ---- 招待一覧 ---- %>
  <% if @incoming_team_invites.present? && @incoming_team_invites.any? %>
    <div class="mt-6 border-t pt-4">
      <h2 class="text-sm font-semibold mb-2"><%= t('profile_settings.edit.incoming_invites_title') %></h2>

      <table class="w-full text-xs">
        <thead>
          <tr class="border-b">
            <th class="text-left py-1"><%= t('profile_settings.edit.column_team_name') %></th>
            <th class="text-left py-1"><%= t('profile_settings.edit.column_requester') %></th>
            <th class="text-left py-1"></th>
          </tr>
        </thead>
        <tbody>
          <% @incoming_team_invites.each do |req| %>
            <tr class="border-b">
              <td class="py-1">
                <%= team_chip(
                      req.team,
                      size: :xs,
                      wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                      ) %>
              </td>
              <td class="py-1">
                <% if req.requester_profile.present? %>
                  <%= profile_chip(
                    req.requester_profile,
                    size: :xs,
                    wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                    ) %>
                <% else %>
                  <span class="text-s text-gray-400">不明</span>
                <% end %>
              </td>
              <td class="py-1 text-right">
                <%= button_to t('common.approve'),
                              approve_membership_request_path(req),
                              method: :patch,
                              class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-xs text-gray-500 mt-4">
     <%= t('profile_settings.edit.no_invites') %>
    </p>
  <% end %>

<% else %>
  <p class="text-sm text-red-600">
    <%= t('profile_settings.edit.not_found') %>
  </p>
<% end %>

-e \n--- END OF FILE ---\n
app/views/profiles/show.html.erb
--- START OF FILE ---
<!-- app/views/profiles/show.html.erb -->
<% content_for :sidebar do %>
  <%= render "profiles/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">
  <%= t('profiles.show.title') %>
</h1>

<div class="space-y-3 text-sm">
  <div>
    <dt class="text-gray-500"><%= t('profiles.show.label_title') %></dt>
    <dd class="font-semibold"><%= @profile.label %></dd>
  </div>

  <div>
    <dt class="text-gray-500"><%= t('profiles.show.display_name_title') %></dt>
    <dd class="font-semibold"><%= @profile.display_name %></dd>
  </div>

  <div>
    <dt class="text-gray-500"><%= t('profiles.show.theme_title') %></dt>
    <dd><%= @profile.theme.presence || t('common.not_set') %></dd>
  </div>

  <div class="pt-3">
    <%= link_to t('common.edit'), edit_profile_path(@profile),
                class: "px-3 py-2 bg-blue-600 text-white rounded" %>
  </div>
</div>

-e \n--- END OF FILE ---\n
app/views/profiles/_form.html.erb
--- START OF FILE ---
<!-- app/views/profiles/_form.html.erb -->
<%= form_with model: @profile, local: true do |f| %>
  <% if @profile.errors.any? %>
    <div class="mb-4 p-3 bg-red-50 text-red-700 rounded">
      <p>
        <%= t('errors.template.header', count: @profile.errors.count, model: Profile.model_name.human) %>
      </p>
      <ul class="list-disc list-inside">
        <% @profile.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-4">
    <%= f.label :label, t('profiles.form.label_title'), class: "block mb-1 text-sm" %>
    <%= f.text_field :label,
                     class: "border border-gray-300 rounded px-2 py-1 w-full",
                     placeholder: t('profiles.form.label_placeholder') %>
  </div>

  <div class="mb-4">
    <%= f.label :display_name, t('profiles.form.display_name_title'), class: "block mb-1 text-sm" %>
    <%= f.text_field :display_name,
                    class: "border border-gray-300 rounded px-2 py-1 w-full",
                    placeholder: t('profiles.form.display_name_placeholder') %>
  </div>

  <div class="mb-4">
    <%= f.label :avatar, t('profiles.form.avatar_title'), class: "block text-sm mb-1" %>

    <% if @profile.avatar.attached? %>
        <div class="mb-2">
        <%= profile_avatar(@profile, size: :md) %>
        </div>
    <% end %>

    <div class="flex items-center gap-2">
      <!-- 見た目用のボタン（label） -->
      <%= f.label :avatar,
                  class: "px-3 py-1 border border-gray-300 rounded text-sm bg-white cursor-pointer hover:bg-gray-50" do %>
        <%= t('profiles.form.choose_file') %>
      <% end %>

      <!-- 選択されたファイル名を表示する所 -->
      <span id="avatar-filename" class="text-xs text-gray-500">
        <%= t('profiles.form.no_file_selected') %>
      </span>

      <!-- 本体の file input は隠す -->
      <%= f.file_field :avatar,
                       accept: "image/*",
                       class: "hidden",
                       onchange: "document.getElementById('avatar-filename').textContent = this.files[0]?.name || '選択されていません';" %>
    </div>


    <% if @profile.avatar.attached? %>
        <label class="mt-2 inline-flex items-center text-xs text-red-600">
        <%= f.check_box :remove_avatar, class: "mr-1" %>
        <%= t('profiles.form.remove_avatar') %>
        </label>
    <% end %>
    </div>

  <% if @profile.persisted? && @profile.join_token.present? %>
    <div class="mb-4">
      <label class="block text-xs mb-1 text-gray-500">
        <%= t('profiles.form.profile_id') %>
      </label>

      <input type="text"
             value="<%= @profile.join_token %>"
             readonly
             class="border border-gray-300 rounded px-2 py-1 w-full bg-gray-50 text-gray-600 text-sm" />

      <p class="text-[11px] text-gray-400 mt-1">
        <%= t('profiles.form.profile_id_immutable_hint') %>
      </p>
    </div>
  <% end %>

  <div class="mb-4">
    <p class="block mb-2 text-sm"><%= t('profiles.form.theme_title') %></p>

    <div class="flex flex-wrap gap-2">
      <% Profile::THEMES.each do |key| %>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded border border-gray-300 bg-white cursor-pointer">
          <%= f.radio_button :theme, key, class: "mr-1" %>
          <span class="text-sm"><%= key %></span>
        </label>
      <% end %>
    </div>

    <p class="text-[11px] text-gray-500 mt-2">
      <%= t('profiles.form.theme_hint') %>
    </p>
  </div>

  <div class="mb-4">
    <%= f.label :locale, t('profiles.form.locale_title'), class: "block text-sm font-medium text-gray-700" %>
    <%= f.select :locale, 
        [
          [t('profiles.locales.ja_en'), "ja_en"],
          [t('profiles.locales.ja'), "ja"],
          [t('profiles.locales.en'), "en"]
        ], 
        {}, 
        class: "mt-1 block w-full  border border-gray-200 rounded-md px-3 py-2 text-sm" %>
  </div>

  <%= f.submit(@profile.persisted? ? t('profiles.form.submit_update') : t('profiles.form.submit_create'),
             class: "px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700") %>
<% end %>
-e \n--- END OF FILE ---\n
app/views/profiles/new.html.erb
--- START OF FILE ---
<!-- app/views/profiles/new.html.erb -->

<% if user_signed_in? && current_user.profiles.any? %>
  <% content_for :sidebar do %>
    <%= render "profiles/sidebar" %>
  <% end %>
<% end %>

<h1 class="text-xl font-bold mb-4">
  <%= t('profiles.new.title') %>
</h1>

<%= render "form", profile: @profile %>
-e \n--- END OF FILE ---\n
app/helpers/team_settings_helper.rb
--- START OF FILE ---
# app/helpers/team_settings_hepler.rb
module TeamSettingsHelper
end
-e \n--- END OF FILE ---\n
app/helpers/avatars_helper.rb
--- START OF FILE ---
# app/helpers/avatars_helper.rb
module AvatarsHelper
end
-e \n--- END OF FILE ---\n
app/helpers/tasks_helper.rb
--- START OF FILE ---
# app/helper/tasks_helper.rb
module TasksHelper
  def status_badge(task)
    base_class = "inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold"

    color_class =
      case task.status
      when "todo"
        # 淡い赤
        "bg-red-100 text-red-700"
      when "in_progress"
        # 淡い青
        "bg-blue-100 text-blue-700"
      when "done"
        # 淡い緑
        "bg-green-100 text-green-700"
      when "archived"
        # 淡い黄色
        "bg-yellow-100 text-yellow-800"
      else
        "bg-gray-100 text-gray-600"
      end

    label =
      case task.status
      when "todo"        then "todo"
      when "in_progress" then "in_progress"
      when "done"        then "done"
      when "archived"    then "archived"
      else task.status
      end

    content_tag :span, label, class: "#{base_class} #{color_class}"
  end

  # ここから 期限バッジ
  def due_badge(task)
    base_class = "inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold"

    # 期限未設定
    return content_tag(:span, "未設定", class: "#{base_class} bg-gray-100 text-gray-500") if task.due_at.blank?

    now = Time.zone.now
    due = task.due_at.in_time_zone(Time.zone)

    label = due.strftime("%m/%d %H:%M")

    color_class =
      if due < now
        # 期限切れ
        "bg-red-100 text-red-700"
      elsif due.to_date == now.to_date
        # 今日が期限
        "bg-blue-100 text-blue-700"
      else
        # 未来
        "bg-green-100 text-green-700"
      end

    content_tag :span, label, class: "#{base_class} #{color_class}"
  end

  # カラム名クリックでソートするリンク
  # 1回目クリック → 降順
  # 同じカラムをもう1回クリック → 昇順
  def sort_link(label, column)
    current_sort      = params[:sort]
    current_direction = params[:direction]

    # 次の direction を決める
    next_direction =
      if current_sort == column && current_direction == "desc"
        "asc"   # 今が desc で同じカラム → 昇順に切り替え
      else
        "desc"  # それ以外（初回 or 別カラム）→ 降順スタート
      end

    # 今の状態に応じて矢印アイコン
    icon =
      if current_sort == column
        current_direction == "desc" ? "▼" : "▲"
      else
        ""
      end

    link_to(
      safe_join([ label, icon ].reject(&:blank?), " "),
      tasks_path(
        # いまの検索/フィルタ/カラムフィルタのパラメータを維持しつつ
        request.query_parameters.merge(sort: column, direction: next_direction)
      ),
      class: "inline-flex items-center gap-1 text-xs text-gray-700 hover:underline"
    )
  end
end
-e \n--- END OF FILE ---\n
app/helpers/team_memberships_helper.rb
--- START OF FILE ---
# app/helpers/team_memberships_helper.rb
module TeamMembershipsHelper
end
-e \n--- END OF FILE ---\n
app/helpers/home_helper.rb
--- START OF FILE ---
# app/helper/home_helper.rb
module HomeHelper
end
-e \n--- END OF FILE ---\n
app/helpers/profile_settings_helper.rb
--- START OF FILE ---
# app/helpers/profile_settings/helper.rb
module ProfileSettingsHelper
end
-e \n--- END OF FILE ---\n
app/helpers/teams_helper.rb
--- START OF FILE ---
# app/helpers/team_helper.rb
module TeamsHelper
end
-e \n--- END OF FILE ---\n
app/helpers/profiles_helper.rb
--- START OF FILE ---
# app/helpers/profiles_helper.rb
module ProfilesHelper
end
-e \n--- END OF FILE ---\n
app/helpers/application_helper.rb
--- START OF FILE ---
# app/helpers/application_helper.rb
module ApplicationHelper
  # ナビ用クラス（前と同じ役割）
  THEME_CLASSES = {
    "default" => { header: "bg-gray-50 text-gray-800", nav: "bg-white text-gray-800 border-r border-gray-300" },

    # 濃い背景 + 白文字（ヘッダー/左ナビ）
    "slate"   => { header: "bg-slate-800 text-white",  nav: "bg-slate-900 text-white" },
    "indigo"  => { header: "bg-indigo-700 text-white", nav: "bg-indigo-800 text-white" },
    "emerald" => { header: "bg-emerald-700 text-white", nav: "bg-emerald-800 text-white" },
    "rose"    => { header: "bg-rose-700 text-white",   nav: "bg-rose-800 text-white" },
    "amber"   => { header: "bg-amber-700 text-white",  nav: "bg-amber-800 text-white" }
  }.freeze

  def submit_mode?
    ENV.fetch("DELIVER_EMAILS", "false") != "true"
  end

  def current_theme_key
    key = current_profile&.theme.presence || "default"
    THEME_CLASSES.key?(key) ? key : "default"
  end

  def header_theme_class
    THEME_CLASSES[current_theme_key][:header]
  end

  def sidebar_theme_class
    THEME_CLASSES[current_theme_key][:nav]
  end

  def dark_theme?
    current_theme_key != "default"
  end

  def nav_class(path)
    base = "block px-3 py-1 rounded text-sm"

    if dark_theme?
      if current_page?(path)
        "#{base} bg-white/10 text-white font-semibold"
      else
        "#{base} text-white/80 hover:bg-white/10 hover:text-white"
      end
    else
      if current_page?(path)
        "#{base} bg-blue-50 text-blue-700 font-semibold"
      else
        "#{base} text-gray-700 hover:bg-gray-50"
      end
    end
  end


  def profile_chip(profile, size: :xs, wrapper_class: "", show_label_fallback: true)
    return "" if profile.nil?

    name =
      profile.display_name.presence ||
      (show_label_fallback ? profile.label : "")

    content_tag :span,
                class: [ "inline-flex items-center space-x-1", wrapper_class ].reject(&:blank?).join(" ") do
      concat profile_avatar(profile, size: size)
      concat content_tag(:span, name, class: "truncate")
    end
  end

  # プロフィールアイコン
  def profile_avatar(profile, size: :md)
    sizes = {
      xs: 24,
      sm: 32,
      md: 40,
      lg: 64
    }

    dimension = sizes[size] || sizes[:md]

    if profile&.avatar&.attached?
      # ✅ vips / variant を使わず、そのまま表示して CSS でサイズ調整
      image_tag profile.avatar,
                class: "object-cover rounded",
                style: "width: #{dimension}px; height: #{dimension}px;",
                alt: profile.display_name || profile.label
    else
      initials = profile.display_initials

      content_tag :div,
                  initials,
                  class: "inline-flex items-center justify-center bg-gray-400 text-white font-semibold rounded",
                  style: "width: #{dimension}px; height: #{dimension}px; font-size: #{(dimension * 0.4).round}px;"
    end
  end

  def team_avatar(team, size: :md)
    return "" if team.nil?

    sizes = {
      xs: 24,
      sm: 32,
      md: 40,
      lg: 64
    }

    dimension = sizes[size] || sizes[:md]

    if team.avatar.attached?
      # ✅ variant をやめて、直接表示 + CSS でサイズ調整
      image_tag team.avatar,
                class: "rounded object-cover",
                style: "width: #{dimension}px; height: #{dimension}px;",
                alt: team.name
    else
      # アイコンが無いときのイニシャル表示とか
      initial = team.name.to_s[0].presence || "T"

      content_tag :div,
                  initial,
                  class: "inline-flex items-center justify-center rounded bg-blue-400 text-white font-semibold",
                  style: "width: #{dimension}px; height: #{dimension}px; font-size: #{(dimension * 0.5).round}px;"
    end
  end

  def team_chip(team, size: :xs, wrapper_class: "")
    return "" if team.nil?

    content_tag :span,
                class: [ "inline-flex items-center space-x-1", wrapper_class ].reject(&:blank?).join(" ") do
      concat team_avatar(team, size: size)
      concat content_tag(:span, team.name, class: "truncate")
    end
  end
end
-e \n--- END OF FILE ---\n
app/channels/application_cable/connection.rb
--- START OF FILE ---
module ApplicationCable
  class Connection < ActionCable::Connection::Base
  end
end
-e \n--- END OF FILE ---\n
app/channels/application_cable/channel.rb
--- START OF FILE ---
module ApplicationCable
  class Channel < ActionCable::Channel::Base
  end
end
-e \n--- END OF FILE ---\n
config/locales/ja_en.yml
--- START OF FILE ---
# config/locales/ja_en.yml
ja_en:
  common:
    app_name: "Forestly"
    tagline: "多様なあなたのTaskアプリ"
    edit: "Edit"
    delete: "Delete"
    confirm_delete: "本当に削除しますか？"
    approve: "Approve"
    unknown: "Unknown"
    not_set: "Not set"
    search: "Search"
    clear: "Clear"
    filter_apply: "Apply Filter"
    filter_clear: "Clear Filter"
    more: "More"
    today: "Today"
    prev_week: "＜ Prev Week"
    next_week: "Next Week ＞"
    time: "Time"
    load_more: "Load More"
    created_at: "Created at"
    remove_image: "Remove image"
    back: "Back"
  error:
    template:
      header: "%{count}件のエラーがあります。"
  devise:
    sessions:
      new:
        title: "Log in"
        sign_up_link: "新規ユーザー登録"
        send_sign_up_email: "登録用メールの送信"
        demo_mode:
          header: "【提出モード】Demo Accounts"
          common: "Common"
          note: "※メール送信は無効です。ログイン後にMVP機能をご確認ください。"
    mailer:
      confirmation_instructions:
        subject: "Confirmation: Email Change"
        instruction_title: "メールアドレス変更の確認です。"
        instruction_body: "以下のリンクを開いて、メールアドレスの変更を確定してください。"
        action_link: "Confirm Email Change"
      reset_password_instructions:
        subject: "Reset Password Instructions"
        instruction_title: "パスワード変更のご案内です。"
        instruction_body: "以下のリンクを開いて、新しいパスワードを設定してください。"
        action_link: "Change Password"
    registrations:
      edit:
        title: "Account Settings"
        current_email: "現在のメールアドレス"
        unconfirmed_email_msg: "変更申請中： %{email}（確認待ち）"
        change_email_title: "Change Email"
        send_email_change_instructions: "新しいメールアドレスに変更用メールを送信する"
        change_password_title: "Change Password"
        send_password_reset_instructions: "パスワードの変更用メールを送信する"
  date:
    formats:
      default: "%Y/%m/%d"
      short: "%Y/%m/%d"
      md: "%m/%d"
  time:
      formats:
        default: "%Y/%m/%d %H:%M:%S"
        ja_short: "%m/%d %H:%M"
  activerecord:
    attributes:
      user:
        email: "Email"
        password: "Password"
        new_email: "New Email Address"
      team:
        name: "Team Name"
        join_token: "Team ID"
        avatar: "Team Icon"
      comment:
        body: "Body"
        pinned: "Pin this comment"
    errors:
      template:
        header: "%{count}件のエラーがあります："
    models:
      team: "Team"
      profile: "Profile"
      membership_request:
        attributes:
          team_id:
            taken: "このプロフィールへの招待はすでに送信済み・承認待ちです。"
      comment: "Comment"
    placeholders:
      team:
        name: "チーム名を入力してください"
      comment:
        body: "コメントを入力..."
  users:
    confirmations:
      edit_email_title: "Confirm Email Change"
      new_email_label: "新しいメールアドレス（確認用）"
      submit_confirm: "Confirm"
  helpers:
    submit:
      create: "Create %{model}"
      update: "Update %{model}"
      comment:
        create: "Post Comment"
  time:
    formats:
      ja_short: "%m/%d %H:%M" 
  layouts:
    application:
      nav:
        task: "Tasks"
        works: "Works"
        chat: "Chat"
        social: "Social"
        profile: "Profiles"
        team: "Teams"
        all_profiles_tasks: "全てのプロフィールのタスクを表示"
      menu:
        logout: "Log out"
        confirm_logout: "ログアウトしますか？"
      submit_mode: "【提出モード】メール送信は無効です"
  profiles:
    form:
      label_title: "Profile Management Name（切り替えに利用する名前）"
      label_placeholder: "e.g. Company / Side Project / Private"
      display_name_title: "Display Name（他ユーザーに表示される名前）"
      display_name_placeholder: "e.g. John Doe"
      avatar_title: "Avatar Image"
      choose_file: "Choose file"
      no_file_selected: "選択されていません"
      remove_avatar: "Remove avatar"
      avatar_hint: "正方形の画像が推奨です（例: 400×400）。"
      profile_id: "Profile ID"
      profile_id_immutable_hint: "このIDは編集できません。"
      theme_title: "Theme（ヘッダー・左ナビの色）"
      theme_hint: "メイン画面は白のまま、ヘッダーと左ナビの色が変わります。"
      locale_title: "Language"
      submit_create: "Create Profile"
      submit_update: "Update Profile"
    index:
      title: "Profiles"
      new_link: "Create New Profile"
      column_name: "Name"
      column_theme: "Theme"
      column_actions: "Actions"
      no_profiles: "まだプロフィールがありません。"
    show:
      title: "Profile Details"
      label_title: "Profile Name（管理用）"
      display_name_title: "Display Name（公開用）"
      theme_title: "Theme Color"
    new:
      title: "Create Profile"
    edit:
      title: "Edit Profile"
    locales:
      ja: "日本語 (Full Japanese)"
      en: "English (Full English)"
      ja_en: "主に日本語 キーワードのみ英語 (Japanese with English Keywords)"
  profile_settings:
    sidebar:
      title: "Profile Settings"
      home: "Home"
      edit: "Edit Profile"
      new: "New Profile"
      auth: "Auth Settings"
    edit:
      title: "Edit Profile"
      search_team_title: "Join Team"
      search_button: "Search Team"
      team_invite_token: "Team ID"
      ask_membership_request: "へ参加申請を送りますか？"
      apply_as_admin: "Apply as Admin"
      team_not_found: "該当するチームが見つかりませんでした。"
      column_team_name: "Team Name"
      column_requester: "Inviter"
      incoming_invites_title: "Incoming Invitations"
      no_invites: "招待はありません。"
      not_found: "プロフィールが見つかりませんでした。"
  teams:
    index:
      title: "Teams"
      edit_settings_title: "Edit Team"
      new_team: "Create Team"
      no_teams_html: "まだチームがありません。"
    new:
      title: "New Team"
    members:
      title: "Members"
      select_team: "管理するチームを選択:"
      suffix_of_team: "のメンバー"
      role: "Role"
      roles:
        admin: "Admin"
        member: "Member"
      confirm_remove: "このメンバーをチームから削除しますか？"
      no_members: "メンバーがいません。"
      invite_section_title: "Invite Member"
      invite_id_label: "Profile ID"
      invite_confirm_msg: "さんを招待しますか？"
      invite_as_admin: "Admin権限を付与"
      send_invite: "Send Invite"
      join_requests_title: "Join Requests"
      requester: "Requester"
      no_requests: "未承認の申請はありません。"
  forms:
    avatar_hint: "正方形の画像が推奨です（例: 400×400）。"
  tasks:
    status:
      todo: "To Do"
      in_progress: "In Progress"
      done: "Done"
      archived: "Archived"
    sidebar:
      title: "Tasks"
      list: "List"
      calendar: "Calendar"
      view_list: "List"
      view_calendar: "Calendar"
      new_task: "New Task"
      all_tasks: "All Tasks"
      today_tasks: "Today"
      week_tasks: "This Week"
      incomplete_tasks: "Incomplete"
      done_tasks: "Done"
    index:
      search_placeholder: "Search by title, description, or tags"
      filter_title: "Filter"
      filter_placeholder_status: "todo / prog / done"
      filter_assignee: "Assignee name"
      filter_owner: "Owner name"
      filter_placeholder_partial: "Partial match"
      filter_placeholder_assignee: "Assignee"
      filter_placeholder_owner: "Owner"
      column_title: "Title"
      column_due_at: "Due Date"
      column_status: "Status"
      column_assignee: "Assignee"
      column_owner: "Owner"
      no_tasks: "まだタスクがありません。"
      confirm_delete: "このタスクを削除しますか？"
    form:
      title: "Title"
      due_date: "Due Date"
      due_time: "Time"
      due_hint: "例）09:00, 13:30 (30分単位)。空の場合は期限なしになります。"
      assignee: "Assignee"
      assignee_hint: "クリックで選択／解除（複数可）。"
      description: "Description"
      tags: "Tags"
      tag_placeholder: "e.g. Project, Rails, Bug"
      tag_hint: "カンマ（,）区切りで複数入力できます。"
      status: "Status"
      submit_create: "Create Task"
      submit_update: "Update Task"
    new:
      title: "New Task"
    show:
      due_date: "Due"
      assignee: "Assignee"
      owner: "Owner"
      status: "Status"
      pin: "Pin"
      title: "Task Details"
      edit_title: "Edit Task"
      comment_title: "Comments"
      no_comments: "まだコメントはありません。"
      new_comment: "Add Comment"
    edit:
      title: "Edit Task"
    calendar:
      slot_time_header: "Schedule for %{date} %{time}"
      slot_title: "Tasks for %{date} %{time}"
      slot_title_list: "Task List"
      view_detail: "View Detail"
      no_tasks_in_slot: "この時間帯のタスクはありません。"-e \n--- END OF FILE ---\n
config/locales/en.yml
--- START OF FILE ---
# config/locales/en.yml
en:
  common:
    app_name: "Forestly"
    tagline: "Task app for your diverse life"
    edit: "Edit"
    delete: "Delete"
    confirm_delete: "Are you sure you want to delete this?"
    approve: "Approve"
    unknown: "Unknown"
    not_set: "Not set"
    search: "Search"
    clear: "Clear"
    filter_apply: "Apply Filter"
    filter_clear: "Clear Filter"
    more: "More"
    today: "Today"
    prev_week: "＜ Prev Week"
    next_week: "Next Week ＞"
    time: "Time"
    load_more: "Load More"
    created_at: "Created at"
    remove_image: "Remove image"
    back: "Back"
  error:
    template:
      header: "%{count} error(s) occurred."
  devise:
    sessions:
      new:
        title: "Log in"
        sign_up_link: "Sign up"
        send_sign_up_email: "Send sign-up email"
        demo_mode:
          header: "[Submission Mode] Demo Accounts"
          common: "Common"
          note: "*Email sending is disabled. Please check MVP features after logging in."
    mailer:
      confirmation_instructions:
        subject: "Confirmation of Email Change"
        instruction_title: "Confirm your email change."
        instruction_body: "Click the link below to confirm your new email address."
        action_link: "Confirm Email Change"
      reset_password_instructions:
        subject: "Reset Password Instructions"
        instruction_title: "Instructions to change your password."
        instruction_body: "Click the link below to set a new password."
        action_link: "Change Password"
    registrations:
      edit:
        title: "Account Settings"
        current_email: "Current Email"
        unconfirmed_email_msg: "Pending change: %{email} (waiting for confirmation)"
        change_email_title: "Change Email Address"
        send_email_change_instructions: "Send confirmation email to new address"
        change_password_title: "Change Password"
        send_password_reset_instructions: "Send password reset email"
  date:
    formats:
      default: "%Y/%m/%d"
      short: "%Y/%m/%d"
      md: "%m/%d"
  time:
      formats:
        default: "%Y/%m/%d %H:%M:%S"
        ja_short: "%m/%d %H:%M"
  activerecord:
    attributes:
      user:
        email: "Email"
        password: "Password"
        new_email: "New Email Address"
      team:
        name: "Team Name"
        join_token: "Team ID"
        avatar: "Team Icon"
      comment:
        body: "Body"
        pinned: "Pin this comment"
    errors:
      template:
        header: "%{count} error(s) prohibited this %{model} from being saved:"
    models:
      team: "Team"
      profile: "Profile"
      membership_request:
        attributes:
          team_id:
            taken: "An invitation to this profile has already been sent or is pending."
      comment: "Comment"
    placeholders:
      team:
        name: "Enter team name"
      comment:
        body: "Enter comment..."
  users:
    confirmations:
      edit_email_title: "Confirm Email Change"
      new_email_label: "New Email Address (for confirmation)"
      submit_confirm: "Confirm and update email"
  helpers:
    submit:
      create: "Create %{model}"
      update: "Update %{model}"
      comment:
        create: "Post Comment"
  time:
    formats:
      ja_short: "%m/%d %H:%M" 
  layouts:
    application:
      nav:
        task: "Tasks"
        works: "Works"
        chat: "Chat"
        social: "Social"
        profile: "Profiles"
        team: "Teams"
        all_profiles_tasks: "Show all profiles' tasks"
      menu:
        logout: "Log out"
        confirm_logout: "Are you sure you want to log out?"
      submit_mode: "[Submission Mode] Email sending is disabled"
  profiles:
    form:
      label_title: "Profile Management Name (Used for switching profiles)"
      label_placeholder: "e.g., Company A / Side Project / Private"
      display_name_title: "Display Name (Visible to other users)"
      display_name_placeholder: "e.g., John Doe"
      avatar_title: "Avatar Image"
      choose_file: "Choose file"
      no_file_selected: "No file selected"
      remove_avatar: "Remove avatar"
      avatar_hint: "Square images are recommended (e.g., 400x400)."
      profile_id: "Profile ID"
      profile_id_immutable_hint: "This ID cannot be edited."
      theme_title: "Theme (Header & Sidebar color)"
      theme_hint: "Only the header and sidebar colors will change."
      locale_title: "Language"
      submit_create: "Create Profile"
      submit_update: "Update Profile Settings"
    index:
      title: "Profiles"
      new_link: "Create New Profile"
      column_name: "Name"
      column_theme: "Theme"
      column_actions: "Actions"
      no_profiles: "No profiles found."
    show:
      title: "Profile Details"
      label_title: "Profile Name (Internal)"
      display_name_title: "Display Name (Public)"
      theme_title: "Theme Color"
    new:
      title: "Create Profile"
    edit:
      title: "Edit Profile"
    locales:
      ja: "Japanese (日本語)"
      en: "English"
      ja_en: "Japanese with English Keywords"
  profile_settings:
    sidebar:
      title: "Profile Settings"
      home: "Home"
      edit: "Edit Profile"
      new: "Create New Profile"
      auth: "Email & Password"
    edit:
      title: "Edit Profile"
      search_team_title: "Search & Join Team by ID"
      search_button: "Search Team"
      team_invite_token: "Team ID"
      ask_membership_request: "Would you like to request to join?"
      apply_as_admin: "Apply as Admin"
      team_not_found: "No team found with the provided ID."
      column_team_name: "Team Name"
      column_requester: "Inviting Profile"
      incoming_invites_title: "Invitations for this Profile"
      no_invites: "No team invitations for this profile."
      not_found: "Profile not found."
  teams:
    index:
      title: "Teams"
      edit_settings_title: "Edit Team Settings"
      new_team: "Create Team"
      no_teams_html: "No teams found."
    new:
      title: "Create New Team"
    members:
      title: "Member Management"
      select_team: "Select team to manage:"
      suffix_of_team: "'s Members"
      role: "Role"
      roles:
        admin: "Admin"
        member: "Member"
      confirm_remove: "Remove this member from the team?"
      no_members: "No members found."
      invite_section_title: "Invite New Member"
      invite_id_label: "Profile ID to invite"
      invite_confirm_msg: "Do you want to invite this user?"
      invite_as_admin: "Grant Admin Privileges"
      send_invite: "Send Invitation"
      join_requests_title: "Incoming Join Requests"
      requester: "Requester"
      no_requests: "No pending requests."
  forms:
    avatar_hint: "Square images are recommended (e.g., 400x400)."
  tasks:
    status:
      todo: "To Do"
      in_progress: "In Progress"
      done: "Done"
      archived: "Archived"
    sidebar:
      title: "Tasks"
      list: "List"
      calendar: "Calendar"
      view_list: "List"
      view_calendar: "Calendar"
      new_task: "Create New Task"
      all_tasks: "All Tasks"
      today_tasks: "Today's Tasks"
      week_tasks: "This Week's Tasks"
      incomplete_tasks: "Incomplete Tasks"
      done_tasks: "Done Tasks"
    index:
      search_placeholder: "Search by title, description, or tags (AND search with spaces)"
      filter_title: "Partial Match"
      filter_placeholder_status: "todo / prog / done"
      filter_assignee: "Assignee name"
      filter_owner: "Owner name"
      filter_placeholder_partial: "Partial match"
      filter_placeholder_assignee: "Assignee name"
      filter_placeholder_owner: "Owner name"
      column_title: "Title"
      column_due_at: "Due Date"
      column_status: "Status"
      column_assignee: "Assignee"
      column_owner: "Owner"
      no_tasks: "No tasks found."
      confirm_delete: "Delete this task?"
    form:
      title: "Title"
      due_date: "Due Date"
      due_time: "Time"
      due_hint: "e.g., 09:00, 13:30 (30-minute intervals). Leave blank for no due time."
      assignee: "Assignee"
      assignee_hint: "Click to select/deselect assignees (multiple allowed)."
      description: "Description"
      tags: "Tags"
      tag_placeholder: "e.g., Project A, Bug, High Priority"
      tag_hint: "Separate multiple tags with commas (,)."
      status: "Status"
      submit_create: "Create Task"
      submit_update: "Update Task"
    new:
      title: "New Task"
    show:
      due_date: "Due"
      assignee: "Assignee"
      owner: "Owner"
      status: "Status"
      pin: "Pin"
      title: "Task Details"
      edit_title: "Edit Task"
      comment_title: "Comments"
      no_comments: "No comments yet."
      new_comment: "New Comment"
    edit:
      title: "Edit Task"
    calendar:
      slot_time_header: "Schedule for %{date} %{time}"
      slot_title: "Tasks for %{date} %{time}"
      slot_title_list: "Tasks in this slot"
      view_detail: "View Details"
      no_tasks_in_slot: "No tasks in this slot."-e \n--- END OF FILE ---\n
config/locales/ja.yml
--- START OF FILE ---
# config/locals/ja.yml
ja:
  common:
    app_name: "Forestly"
    tagline: "多様なあなたのTaskアプリ"
    edit: "編集"
    delete: "削除"
    confirm_delete: "本当に削除しますか？"
    approve: "承認"
    unknown: "不明"
    not_set: "未設定"
    search: "検索"
    clear: "クリア"
    filter_apply: "フィルタ適用"
    filter_clear: "フィルタクリア"
    more: "もっと見る"
    today: "今日"
    prev_week: "＜ 前の週"
    next_week: "次の週 ＞"
    time: "時間"
    load_more: "もっと見る"
    created_at: "作成日"
    remove_image: "画像を削除する"
    back: "戻る"
  error:
    template:
      header: "%{count}件のエラーがあります。"
  devise:
    sessions:
      new:
        title: "ログイン"
        sign_up_link: "新規ユーザー登録"
        send_sign_up_email: "登録用メールの送信"
        demo_mode:
          header: "【提出モード】デモアカウント"
          common: "共通"
          note: "※メール送信は無効です。ログイン後にMVP機能をご確認ください。"
    mailer:
      confirmation_instructions:
        subject: "メールアドレス変更の確認"
        instruction_title: "メールアドレス変更の確認です。"
        instruction_body: "以下のリンクを開いて、メールアドレスの変更を確定してください。"
        action_link: "メールアドレス変更を進める"
      reset_password_instructions:
        subject: "パスワード再設定のご案内"
        instruction_title: "パスワード変更のご案内です。"
        instruction_body: "以下のリンクを開いて、新しいパスワードを設定してください。"
        action_link: "パスワード変更を進める"
    registrations:
      edit:
        title: "アカウント設定"
        current_email: "現在のメールアドレス"
        unconfirmed_email_msg: "変更申請中： %{email}（確認待ち）"
        change_email_title: "メールアドレスの変更"
        send_email_change_instructions: "新しいメールアドレスに変更用メールを送信する"
        change_password_title: "パスワードの変更"
        send_password_reset_instructions: "パスワードの変更用メールを送信する"
  date:
    formats:
      default: "%Y/%m/%d"
      short: "%Y/%m/%d"
      md: "%m/%d"
  time:
      formats:
        default: "%Y/%m/%d %H:%M:%S"
        ja_short: "%m/%d %H:%M"
  activerecord:
    attributes:
      user:
        email: "メール"
        password: "パスワード"
        new_email: "新しいメールアドレス"
      team:
        name: "チーム名"
        join_token: "チームID"
        avatar: "チームアイコン"
      comment:
        body: "本文"
        pinned: "このコメントをピン留めする"
    errors:
      template:
        header: "%{count}件のエラーがあります："
    models:
      team: "チーム"
      membership_request:
        attributes:
          team_id:
            taken: "このプロフィールへの招待はすでに送信済み・承認待ちです。"
      comment: "コメント"
    placeholders:
      team:
        name: "チーム名を入力してください"
      comment:
        body: "コメントを入力..."
  users:
    confirmations:
          edit_email_title: "メールアドレスの変更"
          new_email_label: "新しいメールアドレス（確認用）"
          submit_confirm: "上記のメールアドレスで確定する"
  helpers:
    submit:
      create: "%{model}を作成する"
      update: "%{model}を更新する"
      comment:
        create: "コメント送信"
  time:
    formats:
      ja_short: "%m/%d %H:%M" 
  layouts:
    application:
      nav:
        task: "タスク"
        works: "ワークス"
        chat: "チャット"
        social: "ソーシャル"
        profile: "プロフィール"
        team: "チーム"
        all_profiles_tasks: "全てのプロフィールのタスクを表示"
      menu:
        logout: "ログアウト"
        confirm_logout: "ログアウトしますか？"
      submit_mode: "【提出モード】メール送信は無効です"
  profiles:
    form:
      label_title: "プロフィール管理名（プロフィール切り替えに利用する名前）"
      label_placeholder: "株式会社〇〇 / 副業 / プライベート など"
      display_name_title: "表示名（他のユーザーに表示される名前）"
      display_name_placeholder: "例）田中太郎 / Tanaka Taro など"
      avatar_title: "アイコン画像"
      choose_file: "ファイルを選択"
      no_file_selected: "選択されていません"
      remove_avatar: "画像を削除する"
      avatar_hint: "正方形の画像が推奨です（例: 400×400）。"
      profile_id: "プロフィールID"
      profile_id_immutable_hint: "このIDは編集できません。"
      theme_title: "テーマ（ヘッダー・左ナビの色）"
      theme_hint: "メイン画面とライトパネルは白のまま、ヘッダーと左ナビだけ色が変わります。"
      locale_title: "表示言語 / Language"
      submit_create: "プロフィールを作成する"
      submit_update: "プロフィール設定を更新する"
    index:
      title: "プロフィール一覧"
      new_link: "新規プロフィール作成"
      column_name: "名前"
      column_theme: "テーマ"
      column_actions: "操作"
      no_profiles: "まだプロフィールがありません。"
    show:
      title: "プロフィール詳細"
      label_title: "プロフィール名（管理用）"
      display_name_title: "表示名（他ユーザーに見せる名前）"
      theme_title: "テーマカラー"
    new:
      title: "プロフィール作成"
    edit:
      title: "プロフィール編集"
    locales:
      ja: "日本語 (Full Japanese)"
      en: "English (Full English)"
      ja_en: "主に日本語 キーワードのみ英語 (Japanese with English Keywords)"
  profile_settings:
    sidebar:
      title: "プロフィール設定"
      home: "ホーム"
      edit: "プロフィール編集"
      new: "新規プロフィール作成"
      auth: "メール・パスワード変更"
    edit:
      title: "プロフィール編集"
      search_team_title: "チームIDでチームを検索して参加申請"
      search_button: "チームを検索"
      team_invite_token: "チームID"
      ask_membership_request: "へ参加申請を送りますか？"
      apply_as_admin: "管理者として申請"
      team_not_found: "入力された参加IDに該当するチームが見つかりませんでした。"
      column_team_name: "チーム名"
      column_requester: "招待元プロフィール"
      incoming_invites_title: "このプロフィール宛のチーム招待"
      no_invites: "このプロフィール宛のチーム招待はありません。"
      not_found: "編集対象のプロフィールが見つかりませんでした。"
  teams:
    index:
      title: "チーム一覧"
      edit_settings_title: "チーム編集"
      new_team: "チームを作成する"
      no_teams_heml: "まだチームがありません。"
    settings:
      sidebar:
       title: "チーム管理"
       show: "チーム詳細"
       manage: "メンバー・招待管理"
       edit: "チーム情報の編集"
    new:
      title: "新規チーム作成"
    members:
      title: "メンバー管理"
      select_team: "管理するチームを選択:"
      suffix_of_team: "のメンバー"
      role: "権限"
      roles:
        admin: "管理者"
        member: "メンバー"
      confirm_remove: "このメンバーをチームから削除しますか？"
      no_members: "メンバーがいません。"
      invite_section_title: "新しいメンバーを招待"
      invite_id_label: "招待したいユーザーのプロフィールID"
      invite_confirm_msg: "さんをこのチームに招待しますか？"
      invite_as_admin: "管理者権限を付与する"
      send_invite: "招待を送る"
      join_requests_title: "届いている参加申請"
      requester: "申請者"
      no_requests: "現在、未承認の申請はありません。"
  forms:
    avatar_hint: "正方形の画像が推奨です（例: 400×400）。"
  tasks:
    status:
      todo: "未着手"
      in_progress: "進行中"
      done: "完了"
      archived: "アーカイブ"
    sidebar:
      title: "タスク"
      list: "リスト"
      calendar: "カレンダー"
      view_list: "リスト"
      view_calendar: "カレンダー"
      new_task: "新規タスク作成"
      all_tasks: "すべてのタスク"
      today_tasks: "今日のタスク"
      week_tasks: "今週のタスク"
      incomplete_tasks: "未完了タスク"
      done_tasks: "完了タスク"
    index:
      search_placeholder: "タイトル・詳細・タグで検索（スペース区切りでAND検索）"
      filter_title: "部分一致"
      filter_placeholder_status: "todo / prog / done"
      filter_assignee: "担当者名の一部"
      filter_owner: "作成者名の一部"
      filter_placeholder_partial: "部分一致"
      filter_placeholder_status: "todo / prog / done"
      filter_placeholder_assignee: "担当者名の一部"
      filter_placeholder_owner: "作成者名の一部"
      column_title: "タイトル"
      column_due_at: "期限"
      column_status: "ステータス"
      column_assignee: "担当者"
      column_owner: "作成者"
      no_tasks: "まだタスクがありません。"
      confirm_delete: "このタスクを削除しますか？"
    form:
      title: "タイトル"
      due_date: "期限"
      due_time: "時間"
      due_hint: "例）09:00, 13:30 のように 30分単位で入力してください。空の場合は期限なしになります。"
      assignee: "担当者"
      assignee_hint: "担当者をクリックすると選択／解除できます（複数選択可）。"
      description: "詳細"
      tags: "タグ"
      tag_placeholder: "例）RUNTEQ, Rails, バグ修正"
      tag_hint: "カンマ（,）区切りで複数タグを入力できます。"
      status: "ステータス"
      submit_create: "タスクを作成"
      submit_update: "タスクを更新"
    new:
      title: "タスク新規作成"
    show:
      due_date: "期限"
      assignee: "担当者"
      owner: "作成者"
      status: "ステータス"
      pin: "ピン"
      title: "タスクの詳細"
      edit_title: "タスク編集"
      comment_title: "コメント"
      no_comments: "まだコメントはありません。"
      new_comment: "新規コメント"
    edit:
      title: "タスク編集"
    calendar:
      slot_time_header: "%{date} %{time} の予定"
      slot_title: "%{date} %{time} のタスク"
      slot_title_list: "この時間帯のタスク一覧"
      view_detail: "詳細を見る"
      no_tasks_in_slot: "この時間帯のタスクはありません。"
-e \n--- END OF FILE ---\n
config/locales/devise.en.yml
--- START OF FILE ---
# Additional translations at https://github.com/heartcombo/devise/wiki/I18n

en:
  devise:
    confirmations:
      confirmed: "Your email address has been successfully confirmed."
      send_instructions: "You will receive an email with instructions for how to confirm your email address in a few minutes."
      send_paranoid_instructions: "If your email address exists in our database, you will receive an email with instructions for how to confirm your email address in a few minutes."
    failure:
      already_authenticated: "You are already signed in."
      inactive: "Your account is not activated yet."
      invalid: "Invalid %{authentication_keys} or password."
      locked: "Your account is locked."
      last_attempt: "You have one more attempt before your account is locked."
      not_found_in_database: "Invalid %{authentication_keys} or password."
      timeout: "Your session expired. Please sign in again to continue."
      unauthenticated: "You need to sign in or sign up before continuing."
      unconfirmed: "You have to confirm your email address before continuing."
    mailer:
      confirmation_instructions:
        subject: "Confirmation instructions"
      reset_password_instructions:
        subject: "Reset password instructions"
      unlock_instructions:
        subject: "Unlock instructions"
      email_changed:
        subject: "Email Changed"
      password_change:
        subject: "Password Changed"
    omniauth_callbacks:
      failure: "Could not authenticate you from %{kind} because \"%{reason}\"."
      success: "Successfully authenticated from %{kind} account."
    passwords:
      no_token: "You can't access this page without coming from a password reset email. If you do come from a password reset email, please make sure you used the full URL provided."
      send_instructions: "You will receive an email with instructions on how to reset your password in a few minutes."
      send_paranoid_instructions: "If your email address exists in our database, you will receive a password recovery link at your email address in a few minutes."
      updated: "Your password has been changed successfully. You are now signed in."
      updated_not_active: "Your password has been changed successfully."
    registrations:
      destroyed: "Bye! Your account has been successfully cancelled. We hope to see you again soon."
      signed_up: "Welcome! You have signed up successfully."
      signed_up_but_inactive: "You have signed up successfully. However, we could not sign you in because your account is not yet activated."
      signed_up_but_locked: "You have signed up successfully. However, we could not sign you in because your account is locked."
      signed_up_but_unconfirmed: "A message with a confirmation link has been sent to your email address. Please follow the link to activate your account."
      update_needs_confirmation: "You updated your account successfully, but we need to verify your new email address. Please check your email and follow the confirmation link to confirm your new email address."
      updated: "Your account has been updated successfully."
      updated_but_not_signed_in: "Your account has been updated successfully, but since your password was changed, you need to sign in again."
    sessions:
      signed_in: "Signed in successfully."
      signed_out: "Signed out successfully."
      already_signed_out: "Signed out successfully."
    unlocks:
      send_instructions: "You will receive an email with instructions for how to unlock your account in a few minutes."
      send_paranoid_instructions: "If your account exists, you will receive an email with instructions for how to unlock it in a few minutes."
      unlocked: "Your account has been unlocked successfully. Please sign in to continue."
  errors:
    messages:
      already_confirmed: "was already confirmed, please try signing in"
      confirmation_period_expired: "needs to be confirmed within %{period}, please request a new one"
      expired: "has expired, please request a new one"
      not_found: "not found"
      not_locked: "was not locked"
      not_saved:
        one: "1 error prohibited this %{resource} from being saved:"
        other: "%{count} errors prohibited this %{resource} from being saved:"
-e \n--- END OF FILE ---\n
config/routes.rb
--- START OF FILE ---
# config/routes.rb
Rails.application.routes.draw do
  root "tasks#index"

  devise_for :users, controllers: {
    confirmations: "users/confirmations",
    passwords: "users/passwords"
  }

  post "/account/send_change_email", to: "account_settings#send_change_email", as: :send_change_email
  post "/account/send_password_reset", to: "account_settings#send_password_reset", as: :send_password_reset

  resources :profiles do
    collection { post :switch }
    member do
      get :settings
    end
  end

  get "up" => "rails/health#show", as: :rails_health_check

  resources :teams do
    member do
      get :manage
    end
  end

  get "tasks/slot_tasks", to: "tasks#slot_tasks", as: :slot_tasks

  resources :tasks do
    resources :comments, only: %i[create edit update destroy] do
      resources :reactions, only: :create
    end
  end

  resources :team_memberships, only: %i[create destroy update]

  resources :membership_requests, only: %i[create] do
    member { patch :approve }
  end

  if Rails.env.development?
    mount LetterOpenerWeb::Engine, at: "/letter_opener"
  end
end
-e \n--- END OF FILE ---\n
