<!-- app/views/profile_settings/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render "profile_settings/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">プロフィール編集</h1>

<% if @profile %>
  <%= render "profiles/form", profile: @profile %>

  <!-- ▼ 参加IDでチームに参加申請する ▼ -->
  <div class="mt-6 border-t pt-4">
    <h3 class="text-sm font-semibold mb-2">プロフィール参加IDでチームに参加申請</h3>

    <!-- 1) 参加IDでチーム検索（GET） -->
    <%= form_with url: edit_profile_settings_path, method: :get, local: true,
                  class: "flex flex-wrap items-end gap-2 mb-3" do %>
      <div>
        <label class="block text-xs mb-1">参加ID</label>
        <%= text_field_tag :team_invite_token,
                           @team_invite_token,
                           class: "border rounded px-2 py-1 text-sm",
                           placeholder: "例）AB12CD34" %>
      </div>

      <div class="mb-1">
        <%= submit_tag "チームを検索",
                       class: "px-3 py-2 text-xs bg-gray-100 rounded border hover:bg-gray-200" %>
      </div>
    <% end %>

    <% if @team_invite_token.present? %>
      <% if @invite_teams.any? %>
        <!-- 2) 検索結果から参加申請（POST） -->
        <%= form_with url: membership_requests_path, method: :post, local: true,
                      class: "flex flex-wrap items-end gap-2" do %>
          <%= hidden_field_tag :direction, "profile_to_team" %>

          <div>
            <label class="block text-xs mb-1">参加申請するチーム</label>
            <%= select_tag :team_id,
                           options_from_collection_for_select(@invite_teams, :id, :name),
                           class: "border rounded px-2 py-1 text-sm" %>
          </div>

          <div class="mb-1">
            <%= submit_tag "参加申請を送る",
                           class: "px-4 py-2 text-xs bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
          </div>
        <% end %>
      <% else %>
        <p class="text-xs text-red-500 mt-2">入力された参加IDに該当するチームが見つかりませんでした。</p>
      <% end %>
    <% end %>
  </div>
 

  <%# ---- 招待一覧 ---- %>
  <% if @incoming_team_invites.present? && @incoming_team_invites.any? %>
    <div class="mt-6 border-t pt-4">
      <h2 class="text-sm font-semibold mb-2">このプロフィール宛のチーム招待</h2>

      <table class="w-full text-xs">
        <thead>
          <tr class="border-b">
            <th class="text-left py-1">チーム名</th>
            <th class="text-left py-1">招待元プロフィール</th>
            <th class="text-left py-1"></th>
          </tr>
        </thead>
        <tbody>
          <% @incoming_team_invites.each do |req| %>
            <tr class="border-b">
              <td class="py-1">
                <%= team_chip(
                      req.team,
                      size: :xs,
                      wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                      ) %>
              </td>
              <td class="py-1">
                <% if req.requester_profile.present? %>
                  <%= profile_chip(
                    req.requester_profile,
                    size: :xs,
                    wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                    ) %>
                <% else %>
                  <span class="text-s text-gray-400">不明</span>
                <% end %>
              </td>
              <td class="py-1 text-right">
                <%= button_to "承認",
                              approve_membership_request_path(req),
                              method: :patch,
                              class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-xs text-gray-500 mt-4">このプロフィール宛のチーム招待はありません。</p>
  <% end %>

<% else %>
  <p class="text-sm text-red-600">
    編集対象のプロフィールが見つかりませんでした。
  </p>
<% end %>

