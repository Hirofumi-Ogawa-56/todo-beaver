<!-- app/views/profiles/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render "profiles/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4"><%= t('profile_settings.edit.title') %></h1>

<% if @profile %>
  <%= render "profiles/form", profile: @profile %>

  <!-- ▼ チームIDでチームに参加申請する ▼ -->
  <div class="mt-6 border-t pt-4">
    <h3 class="text-sm font-semibold mb-2"><%= t('profile_settings.edit.search_team_title') %></h3>

    <%= form_with url: edit_profile_path(current_profile), method: :get, local: true,
                  class: "flex flex-wrap items-end gap-2 mb-3" do %>
      <div>
        <label class="block text-xs mb-1"><%= t('profile_settings.edit.team_invite_token') %></label>
        <%= text_field_tag :team_invite_token,
                          @team_invite_token,
                          class: "border rounded px-2 py-1 text-sm",
                          placeholder: "例）AB12CD34" %>
      </div>
      <div class="mb-1">
        <%= submit_tag t('profile_settings.edit.search_button'),
                      class: "px-3 py-2 text-xs bg-gray-100 rounded border hover:bg-gray-200" %>
      </div>
    <% end %>

    <% if @team_invite_token.present? %>
      <% if @invite_teams.any? %>
        <div class="p-3 bg-blue-50 border border-blue-200 rounded">
          <% @invite_teams.each do |team| %>
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div class="flex items-center gap-2">
                <%= team_chip(team, size: :xs) %>
                <span class="text-xs text-gray-600 font-medium">
                  <%= t('profile_settings.edit.ask_membership_request') %>
                </span>
              </div>

              <%= form_with url: membership_requests_path, method: :post, local: true, class: "flex items-center gap-4" do %>
                <%= hidden_field_tag :direction, "profile_to_team" %>
                <%= hidden_field_tag :team_id, team.id %>
                
                <label class="inline-flex items-center gap-1 cursor-pointer">
                  <%= check_box_tag :admin, "1", false, class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
                  <span class="text-xs text-gray-700">
                    <%= t('profile_settings.edit.apply_as_admin') %>
                  </span>
                </label>

                <%= submit_tag t('common.filter_apply'),
                              class: "px-4 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm" %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-xs text-red-500 mt-2">
          <%= t('profile_settings.edit.team_not_found') %>
        </p>
      <% end %>
    <% end %>
  </div>
 

  <%# ---- 招待一覧 ---- %>
  <% if @incoming_team_invites.present? && @incoming_team_invites.any? %>
    <div class="mt-6 border-t pt-4">
      <h2 class="text-sm font-semibold mb-2"><%= t('profile_settings.edit.incoming_invites_title') %></h2>

      <table class="w-full text-xs">
        <thead>
          <tr class="border-b">
            <th class="text-left py-1"><%= t('profile_settings.edit.column_team_name') %></th>
            <th class="text-left py-1"><%= t('profile_settings.edit.column_requester') %></th>
            <th class="text-left py-1"></th>
          </tr>
        </thead>
        <tbody>
          <% @incoming_team_invites.each do |req| %>
            <tr class="border-b">
              <td class="py-1">
                <%= team_chip(
                      req.team,
                      size: :xs,
                      wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                      ) %>
              </td>
              <td class="py-1">
                <% if req.requester_profile.present? %>
                  <%= profile_chip(
                    req.requester_profile,
                    size: :xs,
                    wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                    ) %>
                <% else %>
                  <span class="text-s text-gray-400">不明</span>
                <% end %>
              </td>
              <td class="py-1 text-right">
                <%= button_to t('common.approve'),
                              approve_membership_request_path(req),
                              method: :patch,
                              class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-xs text-gray-500 mt-4">
     <%= t('profile_settings.edit.no_invites') %>
    </p>
  <% end %>

<% else %>
  <p class="text-sm text-red-600">
    <%= t('profile_settings.edit.not_found') %>
  </p>
<% end %>

