<!-- app/views/tasks/show.html.erb -->

<turbo-frame id="side-panel-frame">
  <% unless turbo_frame_request? %>
    <% content_for :sidebar do %>
      <%= render "tasks/sidebar" %>
    <% end %>
  <% end %>

  <!-- 1行目：タイトル -->
  <h1 class="text-xl font-bold mb-2"><%= @task.title %></h1>

  <!-- 2行目：期限 ｜ 担当者 ｜ 作成者 -->
  <div class="flex flex-wrap items-center text-sm text-gray-700 mb-1">
    <!-- 期限 -->
      <div class="flex items-center gap-1">
        <span class="text-gray-500"><%= t('tasks.show.due_date') %></span>
        <span>
          <%= due_badge(@task) %>
        </span>
      </div>

    <!-- 区切り：薄いグレーの ｜ -->
    <span class="mx-2 text-gray-300">｜</span>

    <!-- 担当者 -->
    <div class="flex items-center gap-1 flex-wrap">
      <span class="text-gray-500"><%= t('tasks.show.assignee') %></span>
      <% if @task.assignees.any? %>
        <% @task.assignees.each do |profile| %>
          <%= profile_chip(
                profile,
                size: :xs,
                wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-xs mr-1 mb-1"
              ) %>
        <% end %>
      <% else %>
        <span class="text-xs text-gray-400"><%= t('common.not_set') %></span>
      <% end %>
    </div>

    <!-- 区切り -->
    <span class="mx-2 text-gray-300">｜</span>

    <!-- 作成者 -->
    <div class="flex items-center gap-1">
      <span class="text-gray-500"><%= t('tasks.show.owner') %></span>
      <% if @task.owner_profile %>
        <%= profile_chip(
              @task.owner_profile,
              size: :xs,
              wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-xs"
            ) %>
      <% else %>
        <span class="text-xs text-gray-400"><%= t('common.unknown') %></span>
      <% end %>
    </div>
  </div>

  <!-- 3行目：ステータス ＋ ピン留めコメント概要 -->
  <div class="flex flex-wrap items-center gap-4 text-sm text-gray-700 mb-3">
    <!-- ステータス -->
      <div class="flex items-center gap-1">
        <span class="text-gray-500"><%= t('tasks.show.status') %></span>
        <span class="ml-1">
          <%= status_badge(@task) %>
        </span>
        <!-- 即時変更用プルダウン -->
        <%= form_with model: @task,
                      url: task_path(@task),
                      method: :patch,
                      data: { turbo_frame: "side-panel-frame" },
                      class: "inline-block" do |f_task| %>
          <%= f_task.select :status,
                            Task.statuses.keys.map { |k| [k, k] },
                            { selected: @task.status },
                            class: "border border-gray-300 rounded px-2 py-1",
                            onchange: "this.form.submit();" %>
        <% end %>
      </div>

    <% if @task.pinned_comments.any? %>
      <!-- 区切り：薄いグレーの ｜ -->
      <span class="text-gray-300">｜</span>

      <% main_pinned = @task.pinned_comments.first %>

      <!-- ピン留めコメント概要 -->
      <div class="flex items-center gap-1 min-w-0">
        <span class="text-gray-500 text-[11px]">
          ピン
          <% if @task.pinned_comments.size > 1 %>
            (<%= @task.pinned_comments.size %>)
          <% end %>
        </span>

        <%= profile_chip(
              main_pinned.author_profile,
              size: :xs,
              wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-[11px]"
            ) %>

        <!-- コメント本文は1行だけ、省略表示 -->
        <span class="text-[11px] text-gray-600 truncate max-w-xs">
          <%= h(main_pinned.body) %>
        </span>
      </div>
    <% end %>
  </div>


  <!-- 操作ボタン -->
  <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
    <%= link_to t('common.edit'),
                edit_task_path(@task),
                class: "px-2 py-1 bg-gray-50 border border-gray-300 rounded hover:bg-gray-100",
                data: {
                  turbo_frame: "side-panel-frame",
                  action: "click->side-panel#open",
                  side_panel_title_param: t('tasks.show.edit_title')
                } %>

    <%= button_to "削除",
                task_path(@task),
                method: :delete,
                form: {data: { turbo_confirm: t('tasks.index.confirm_delete') }},
                class: "ml-auto px-2 py-1 bg-red-50 text-red-700 border border-red-200 rounded hover:bg-red-100" %>
  </div>

  <!-- コメント一覧 -->
  <div class="mt-4 pt-3 border-t border-gray-300">
    <h2 class="text-sm font-semibold mb-2"><%= t('tasks.show.comment_title') %></h2>

    <div class="space-y-3 mb-3">
      <%= render partial: "comments/comment",
                  collection: @task.comments.includes(:author_profile).order(:created_at),
                  as: :comment %>

      <% if @task.comments.empty? %>
        <p class="text-xs text-gray-400"><%= t('tasks.show.no_comments') %></p>
      <% end %>
    </div>

    <!-- 新規コメントフォーム -->
    <div class="mt-3">
      <h3 class="text-xs text-gray-500 mb-1"><%= t('tasks.show.new_comment') %></h3>
      <%= render "comments/form", task: @task, comment: @task.comments.build %>
    </div>
  </div>
</turbo-frame>
