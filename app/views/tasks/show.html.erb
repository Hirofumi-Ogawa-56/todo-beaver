<!-- app/views/tasks/show.html.erb -->

<turbo-frame id="side-panel-frame">
  <% unless turbo_frame_request? %>
    <% content_for :sidebar do %>
      <%= render "tasks/sidebar" %>
    <% end %>
  <% end %>

  <h1 class="text-xl font-bold mb-4"><%= @task.title %></h1>

  <div class="space-y-3 text-sm">
    <div>
      <span class="text-gray-500">チーム：</span>
      <%= team_chip(
            @task.team,
            size: :xs,
            wrapper_class: "px-2 py-1 inline-flex items-center rounded bg-gray-100 text-xs ml-1"
          ) %>
    </div>


    <div>
      <span class="text-gray-500">ステータス：</span>
      <span><%= @task.status %></span>
    </div>

    <div>
      <span class="text-gray-500">期限：</span>
      <span>
        <% if @task.due_at.present? %>
          <%= @task.due_at.strftime("%m/%d %H:%M") %>
        <% else %>
          未設定
        <% end %>
      </span>
    </div>

    <!-- 担当者（複数） -->
    <div>
      <span class="text-gray-500">担当：</span>
      <% if @task.assignees.any? %>
        <% @task.assignees.each do |profile| %>
          <%= profile_chip(
                profile,
                size: :xs,
                wrapper_class: "px-2 py-1 mr-1 mb-1 rounded bg-gray-100 text-xs"
              ) %>
        <% end %>
      <% else %>
        <span class="text-xs text-gray-400">未設定</span>
      <% end %>
    </div>

    <div>
      <span class="text-gray-500">作成者：</span>
      <% if @task.owner_profile %>
        <%= profile_chip(
              @task.owner_profile,
              size: :xs,
              wrapper_class: "px-2 py-1 inline-flex items-center rounded bg-gray-100 text-xs ml-1"
            ) %>
      <% else %>
        <span class="text-xs text-gray-400 ml-1">不明</span>
      <% end %>
    </div>

    <!-- タグ表示 -->
    <div>
      <span class="text-gray-500">タグ：</span>
      <% if @task.tags.any? %>
        <% @task.tags.each do |tag| %>
          <span class="inline-flex items-center px-2 py-1 mr-1 mb-1 rounded-full bg-blue-50 text-xs text-blue-700 border border-blue-200">
            <%= tag.name %>
          </span>
        <% end %>
      <% else %>
        <span class="text-xs text-gray-400">なし</span>
      <% end %>
    </div>

    <div class="pt-3 border-t">
      <span class="block text-gray-500 mb-1">詳細</span>
      <p class="whitespace-pre-wrap"><%= @task.description.presence || "（なし）" %></p>
    </div>

    <div class="pt-4 flex gap-3">
      <%= link_to "編集",
                  edit_task_path(@task),
                  class: "px-3 py-1 bg-gray-100 rounded hover:bg-gray-200",
                  data: {
                    turbo_frame: "side-panel-frame",
                    action: "click->side-panel#open",
                    side_panel_title_param: "タスク編集"
                  } %>

      <%= link_to "一覧に戻る",
                  tasks_path,
                  class: "px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" %>

      <%= link_to "削除",
                  task_path(@task),
                  data: { turbo_method: :delete, turbo_confirm: "このタスクを削除しますか？" },
                  class: "ml-auto px-3 py-1 bg-red-50 text-red-700 rounded border border-red-200 hover:bg-red-100 text-xs" %>
    </div>

    <!-- コメント一覧 -->
    <div class="mt-4 pt-3 border-t">
      <h2 class="text-sm font-semibold mb-2">コメント</h2>

      <div class="space-y-3 mb-3">
        <%= render partial: "comments/comment",
                   collection: @task.comments.includes(:author_profile).order(:created_at),
                   as: :comment %>

        <% if @task.comments.empty? %>
          <p class="text-xs text-gray-400">まだコメントはありません。</p>
        <% end %>
      </div>

      <!-- 新規コメントフォーム -->
      <div class="mt-3">
        <h3 class="text-xs text-gray-500 mb-1">新規コメント</h3>
        <%= render "comments/form", task: @task, comment: @task.comments.build %>
      </div>
    </div>

  </div>
</turbo-frame>
