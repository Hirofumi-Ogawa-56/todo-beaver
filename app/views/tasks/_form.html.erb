<!-- app/views/tasks/_form.html.erb -->
<%= form_with model: @task,
              local: true,
              data: (@task.new_record? ? { turbo_frame: "_top" } : {}) do |f| %>
  <% if @task.errors.any? %>
    <div class="mb-4 p-3 bg-red-50 text-red-700 rounded text-sm">
      <p class="font-semibold"><%= @task.errors.count %>件のエラーがあります。</p>
      <ul class="list-disc list-inside">
        <% @task.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- タイトル -->
  <div class="mb-4">
    <%= f.label :title, "タイトル", class: "block text-sm mb-1" %>
    <%= f.text_field :title,
                     class: "border border-gray-300 rounded px-2 py-1 w-full text-sm",
                     placeholder: "タイトル" %>
  </div>

  <!-- 期限 -->
  <div class="mb-4">
    <%= f.label :due_date, "期限", class: "block text-sm mb-1" %>

    <div class="flex items-center gap-2">
      <!-- 日付：カレンダーで選ぶ -->
      <%= f.date_field :due_date,
                       value: (@task.due_date || @task.due_at&.to_date),
                       class: "border border-gray-300 rounded px-2 py-1 text-sm" %>

      <span class="text-sm text-gray-500">時間</span>

      <!-- 時刻：テキスト入力のみ（30分単位を想定） -->
      <%= f.text_field :due_time,
                       value: (@task.due_time || @task.due_at&.strftime("%H:%M")),
                       class: "border border-gray-300 rounded px-2 py-1 text-sm w-20",
                       placeholder: "23:30",
                       inputmode: "numeric",
                       pattern: "[0-2][0-9]:(00|30)" %>
    </div>

    <p class="text-[11px] text-gray-500 mt-1">
      例）09:00, 13:30 のように 30分単位で入力してください。空の場合は期限なしになります。
    </p>
  </div>

  <!-- 担当者 -->
    <div class="mb-4">
      <%= f.label :assignee_ids, "担当者", class: "block text-sm mb-1" %>

      <div class="flex flex-wrap gap-2">
        <%= f.collection_check_boxes :assignee_ids,
                                    @assignee_candidates,
                                    :id,
                                    :display_name do |b| %>
          <label class="inline-flex items-center px-2 py-1 rounded-full border border-gray-300 bg-gray-50 cursor-pointer text-xs">
            <!-- 実際のチェックボックス（地味でもOK） -->
            <%= b.check_box(class: "mr-1") %>

            <!-- アイコン＋名前 -->
            <%= profile_avatar(b.object, size: :xs) %>
            <span class="ml-1"><%= b.object.display_name %></span>
          </label>
        <% end %>
      </div>

      <p class="text-[11px] text-gray-500 mt-1">
        担当者をクリックすると選択／解除できます（複数選択可）。
      </p>
    </div>

  <!-- 詳細 -->
  <div class="mb-4">
    <%= f.label :description, "詳細", class: "block text-sm mb-1" %>
    <%= f.text_area :description,
                    rows: 4,
                    class: "border border-gray-300 rounded px-2 py-1 w-full text-sm" %>
  </div>

  <!-- タグ -->
  <div class="mb-4">
    <%= f.label :tag_list, "タグ", class: "block text-sm mb-1" %>
    <%= f.text_field :tag_list,
                     value: @task.tag_list,
                     class: "border border-gray-300 rounded px-2 py-1 w-full text-sm",
                     placeholder: "例）RUNTEQ, Rails, バグ修正" %>
    <p class="text-[11px] text-gray-500 mt-1">
      カンマ（,）区切りで複数タグを入力できます。
    </p>
  </div>

  <!-- ステータス -->
  <div class="mb-4">
    <%= f.label :status, "ステータス", class: "block text-sm mb-1" %>
    <%= f.select :status,
                 Task.statuses.keys.map { |k| [k, k] },
                 {},
                 class: "border border-gray-300 rounded px-2 py-1 w-full text-sm" %>
  </div>

  <%= f.submit (@task.new_record? ? "タスクを作成" : "タスクを更新"),
             class: "px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" %>
<% end %>