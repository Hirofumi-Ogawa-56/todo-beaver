<!-- app/views/tasks/index.html.erb -->
<% content_for :sidebar do %>
  <%= render "tasks/sidebar" %>
<% end %>

<div>
  <!-- ▼ 総合検索フォーム -->
  <div class="mb-1">
    <%= form_with url: tasks_path, method: :get, local: true,
                  class: "flex items-center gap-2 max-w-xl" do %>

      <!-- 今のクイックフィルタを維持 -->
      <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>

      <!-- all_profiles も維持 -->
      <%= hidden_field_tag :all_profiles, params[:all_profiles] if params[:all_profiles].present? %>

      <%= text_field_tag :q,
                        @query,
                        class: "flex-1 border border-gray-300 rounded px-3 py-1 text-sm",
                        placeholder: t('tasks.index.search_placeholder') %>

      <%= submit_tag t('common.search'),
                    class: "px-3 py-1 bg-gray-800 text-white text-sm rounded hover:bg-gray-900" %>

      <% if @query.present? %>
        <%= link_to t('common.clear'),
                    tasks_path(
                      filter:      params[:filter],
                      all_profiles: params[:all_profiles]  # ★ ここでモード維持
                    ),
                    class: "text-xs text-gray-500 underline ml-2" %>
      <% end %>
    <% end %>
  </div>

  <!-- ▼ カラムごとのフィルタ -->
  <div class="mb-1">
    <%= form_with url: tasks_path, method: :get, local: true do %>
      <%# 総合検索とクイックフィルタは維持 %>
      <%= hidden_field_tag :q, @query if @query.present? %>
      <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>
      <%= hidden_field_tag :all_profiles, params[:all_profiles] if params[:all_profiles].present? %>

      <table class="w-full text-xs">
        <tbody>
          <tr>
            <!-- タイトル -->
            <td class="py-1 px-2">
              <%= text_field_tag :title_contains,
                                 params[:title_contains],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: t('tasks.index.filter_title') %>
            </td>

            <!-- 期限（自由入力でもいいですが、UX的に date_field_tag おすすめ） -->
            <td class="py-1 px-2">
              <%= date_field_tag :due_on,
                                 params[:due_on],
                                 class: "w-full border border-gray-300 rounded px-2 py-1" %>
            </td>

            <!-- ステータス（todo / in / done など） -->
            <td class="py-1 px-2">
              <%= text_field_tag :status_keyword,
                                 params[:status_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: t('tasks.index.filter_placeholder_status') %>
            </td>

            <!-- 担当者 -->
            <td class="py-1 px-2">
              <%= text_field_tag :assignee_keyword,
                                 params[:assignee_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: t('tasks.index.filter_placeholder_assignee') %>
            </td>

            <!-- 作成者 -->
            <td class="py-1 px-2">
              <%= text_field_tag :owner_keyword,
                                 params[:owner_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: t('tasks.index.filter_placeholder_owner') %>
            </td>

            <!-- 右端：ボタン -->
            <td class="py-1 px-2">
              <div class="flex justify-end gap-2">
                <%= submit_tag t('common.filter_apply'),
                               class: "px-3 py-1 bg-gray-100 text-gray-700 text-xs rounded border border-gray-300 hover:bg-gray-200" %>

                <%= link_to t('common.filter_apply'),
                            tasks_path(
                              q:           @query,
                              filter:      params[:filter],
                              all_profiles: params[:all_profiles]
                            ),
                            class: "px-3 py-1 text-xs text-gray-500 underline" %>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    <% end %>
  </div>

<!-- タスク一覧 -->
<% if @tasks.any? %>
  <div class="overflow-y-auto max-h-[calc(100vh-260px)]">
    <table class="w-full text-sm">
      <thead class="sticky top-0 bg-gray-50 z-10">
        <tr class="border-b">
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_title'), "title") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_due_at'), "due_at") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_status'), "status") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_assignee'), "assignee") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link(t('tasks.index.column_owner'), "owner") %>
          </th>
          <th class="text-left py-2 px-2"></th>
        </tr>
      </thead>

      <tbody id="tasks-table-body">
        <%= render partial: "tasks/task_row", collection: @tasks, as: :task %>
      </tbody>
    </table>
  <!-- ▼ もっと見る（次のページへ） -->
  <% if @tasks.next_page.present? %>
    <div id="load-more-tasks" class="mt-2 flex justify-center">
      <%= link_to t('common.more'),
                  tasks_path(
                    request.query_parameters.merge(
                      page:   @tasks.next_page,
                      format: :turbo_stream
                    )
                  ),
                  class: "px-4 py-2 text-xs bg-gray-100 border border-gray-300 rounded hover:bg-gray-200" %>
    </div>
  <% end %>
  </div>



<% else %>
  <p class="text-sm text-gray-500">
    <%= t('tasks.index.no_tasks') %>
  </p>
<% end %>
</div>
