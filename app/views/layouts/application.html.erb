<!-- app/views/layouts/application.html.erb -->
<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Todo Beaver" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# <link rel="manifest" href="/manifest.json"> %>
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="bg-white">
    <% if submit_mode? %>
      <div class="fixed top-0 inset-x-0 z-20 text-xs px-3 py-2 bg-amber-50 text-amber-800 border-b border-amber-200">
        <%= t('layouts.application.submit_mode') %>
      </div>
    <% end %>
    <!-- ヘッダー -->
      <header class="fixed <%= submit_mode? ? 'top-8' : 'top-0' %> inset-x-0 shadow-sm z-10 <%= header_theme_class %>">
        <div class="w-full h-16 px-4 flex items-center">
          <!-- 1段：左 = プロフィール + ナビ / 右 = ロゴ -->
          <div class="flex items-center justify-between w-full">
            <!-- 左側：プロフィールブロック + ナビブロック -->
            <div class="flex items-center gap-8">
              <!-- プロフィール表示 + プロフィール切替 + ドロップダウン -->
              <div class="flex items-center gap-4">
                <% if user_signed_in? && current_user.profiles.any? && current_profile %>
                  <!-- プロフィールアイコン＋名前（クリックでメニュー） -->
                  <details class="relative">
                    <summary class="list-none cursor-pointer">
                      <%= profile_chip(
                            current_profile,
                            size: :sm,
                            wrapper_class: "text-sm font-semibold"
                          ) %>
                    </summary>

                    <!-- ドロップダウンメニュー -->
                    <div class="absolute mt-2 left-0 w-40 bg-white border border-gray-300 rounded shadow text-sm z-50">
                      <%= button_to t('layouts.application.menu.logout'),
                        destroy_user_session_path,
                        method: :delete,
                        form: { data: { turbo_confirm: t('layouts.application.menu.confirm_logout') } }, 
                        class: "block w-full text-left px-3 py-2 text-gray-700 hover:bg-gray-100 bg-transparent border-0" %>
                    </div>
                  </details>

                  <!-- プロフィール切り替えセレクト -->
                  <div>
                    <%= form_with url: switch_profiles_path, method: :post, local: true do |f| %>
                      <%= f.select :profile_id,
                                  options_from_collection_for_select(
                                    current_user.profiles,
                                    :id,
                                    :label,
                                    current_profile&.id
                                  ),
                                  {},
                                  class: "border border-gray-300 rounded px-3 py-1 text-sm text-gray-700 bg-white",
                                  onchange: "this.form.submit();" %>
                    <% end %>
                  </div>
                <% end %>
              </div>

              <!-- プロフィールの右に少し空けて、左詰めでナビ -->
              <% if user_signed_in? %>
                <nav class="flex items-center gap-3">
                  <!-- タスク -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "beaver_icon.png",
                                  alt: "Task",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.task') %></span>
                  <% end %>

                  <!-- ワークス -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "owl_icon.png",
                                  alt: "Works",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.works') %></span>
                  <% end %>

                  <!-- チャット -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "wolf_icon.png",
                                  alt: "Chat",
                                  class: "block",
                                  style: "height: 27px; width: auto;" %>
                    <span><%= t('layouts.application.nav.chat') %></span>
                  <% end %>

                  <!-- ソーシャル -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "rabbit_icon.png",
                                  alt: "Social",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.social') %></span>
                  <% end %>                  
                  
                  <!-- プロフィール -->
                  <%= link_to edit_profile_path(current_profile),
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "butterfly_icon.png",
                                  alt: "Profile",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.profile') %></span>
                  <% end %>

                  <!-- チーム -->
                  <%= link_to teams_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%= image_tag "elephant_icon.png",
                                  alt: "Team",
                                  class: "block",
                                  style: "height: 32px; width: auto;" %>
                    <span><%= t('layouts.application.nav.team') %></span>
                  <% end %>
              

                  <% if controller_name == "tasks" %>
                    <div class="ml-4">
                      <%= form_with url: tasks_path, method: :get, local: true,
                                    class: "flex items-center gap-1" do %>

                        <!-- 今の検索・フィルタ状態を引き継ぐ -->
                        <%= hidden_field_tag :q, params[:q] if params[:q].present? %>
                        <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>
                        <%= hidden_field_tag :sort, params[:sort] if params[:sort].present? %>
                        <%= hidden_field_tag :direction, params[:direction] if params[:direction].present? %>
                        <%= hidden_field_tag :view, params[:view] if params[:view].present? %>

                        <label class="flex items-center gap-1 text-xs">
                          <%= check_box_tag :all_profiles,
                                            "1",
                                            params[:all_profiles] == "1",
                                            onchange: "this.form.submit();" %>
                          <span><%= t('layouts.application.nav.all_profiles_tasks') %></span>
                        </label>
                      <% end %>
                    </div>
                  <% end %>
                </nav>
                <% end %>
            </div>

            <!-- 右側：ロゴ（イラスト） -->
            <div class="flex items-center">
              <%= link_to root_path, class: "flex items-center gap-2" do %>
                <%= image_tag "forestly_logo.png",
                              alt: "forestly",
                              class: "block",
                              style: "height: 45px; width: auto;" %>
              <% end %>
            </div>
          </div>
        </div>
      </header>

    <!-- メインコンテンツ -->
    <main class="<%= submit_mode? ? 'pt-24' : 'pt-16' %> pb-0">
      <% if notice %>
        <div class="mb-4 bg-green-100 text-green-800 px-4 py-2 rounded">
          <%= notice %>
        </div>
      <% end %>
      <% if alert %>
        <div class="mb-4 bg-red-100 text-red-800 px-4 py-2 rounded">
          <%= alert %>
        </div>
      <% end %>

      <div
        class="flex gap-0 min-h-[calc(100vh-4rem)]"
        data-controller="side-panel"
        data-side-panel-initial-width-value="480"
      >
        <% if content_for?(:sidebar) %>
          <aside class="w-60 shrink-0 px-4 pt-3 pb-6 self-stretch <%= sidebar_theme_class %>">
            <%= yield :sidebar %>
          </aside>

          <section class="flex-1 bg-white px-6 pt-3 pb-6 overflow-auto">
            <%= yield %>
          </section>
        <% else %>
          <section class="flex-1 bg-white px-6 pt-3 pb-6">
            <%= yield %>
          </section>
        <% end %>

      <!-- 共通サイドパネルを描画 -->
      <%= render "shared/side_panel" %>
      </div>
    </main>

    <!-- Tailwind に yellow系クラスを認識させるためのダミー要素（画面には表示されません） -->
    <span class="hidden
      bg-slate-800 bg-slate-900
      bg-indigo-700 bg-indigo-800
      bg-emerald-700 bg-emerald-800
      bg-rose-700 bg-rose-800
      bg-amber-700 bg-amber-800
      text-white
      bg-white/10 text-white/80 hover:bg-white/10 hover:text-white
    "></span>

  </body>
</html>

