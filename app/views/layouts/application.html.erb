<!-- app/views/layouts/application.html.erb -->
<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Todo Beaver" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# <link rel="manifest" href="/manifest.json"> %>
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="bg-white">
    <% if submit_mode? %>
      <div class="fixed top-0 inset-x-0 z-20 text-xs px-3 py-2 bg-amber-50 text-amber-800 border-b border-amber-200">
        <%= t('layouts.application.submit_mode') %>
      </div>
    <% end %>
    <!-- ヘッダー -->
      <header class="fixed <%= submit_mode? ? 'top-8' : 'top-0' %> inset-x-0 shadow-sm z-10 <%= header_theme_class %>">
        <div class="w-full h-16 px-4 flex items-center">
          <!-- 1段：左 = プロフィール + ナビ / 右 = ロゴ -->
          <div class="flex items-center justify-between w-full">
            <!-- 左側：プロフィールブロック + ナビブロック -->
            <div class="flex items-center gap-8">
              <!-- プロフィール表示 + プロフィール切替 + ドロップダウン -->
              <div class="flex items-center gap-4">
                <% if user_signed_in? && current_user.profiles.any? && current_profile %>
                  <!-- プロフィールアイコン＋名前（クリックでメニュー） -->
                    <div class="flex items-center">
                      <% if user_signed_in? && current_user.profiles.any? && current_profile %>
                        <details class="relative group" data-profile-dropdown>
                          <summary class="list-none cursor-pointer">
                            <div class="flex items-center gap-2">
                              <%# アイコン部分 %>
                              <div class="shrink-0">
                                <%= profile_avatar(current_profile, size: :lg) %>
                              </div>

                              <%# テキスト部分（4段構成） %>
                              <div class="flex flex-col items-start leading-[1.1]">
                                <%# 所属（一番控えめ） %>
                                <% if org_name = current_profile.organization_display_name %>
                                  <span class="text-[10px] opacity-60 font-normal truncate max-w-[140px]">
                                    <%= org_name %>
                                  </span>
                                <% end %>

                                <%# 表示名（名前） %>
                                <span class="text-[10px] opacity-60 font-normal truncate max-w-[140px]">
                                  <%= current_profile.display_name %>
                                </span>

                                <%# ラベル（一番目立つ：役割） %>
                                <span class="text-sm font-bold truncate max-w-[140px] text-gray-800">
                                  <%= current_profile.label %>
                                </span>

                                <%# 操作ガイド %>
                                <span class="text-[8px] text-blue-400 font-medium group-hover:underline mt-0.5">
                                  プロフィール切替／ログアウト
                                </span>
                              </div>
                            </div>
                          </summary>

                          <div class="absolute mt-2 left-0 w-56 bg-white border border-gray-200 rounded-lg shadow-xl z-50 overflow-hidden text-gray-700">
                            <div class="px-3 py-2 bg-gray-50 border-b border-gray-100">
                              <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">プロフィールを切り替える</span>
                            </div>

                            <%# 他のプロフィール一覧をリンクとして表示 %>
                            <div class="max-h-60 overflow-y-auto">
                              <% current_user.profiles.each do |p| %>
                                <%= button_to switch_profiles_path(profile_id: p.id), 
                                              method: :post, 
                                              data: { turbo: false },
                                              class: "w-full flex items-center gap-3 px-3 py-2 hover:bg-blue-50 transition-colors border-0 bg-transparent cursor-pointer" do %>
                                  <%= profile_avatar(p, size: :xs) %>
                                  <div class="flex flex-col items-start text-left">
                                    <span class="text-xs font-bold <%= 'text-blue-600' if p == current_profile %>"><%= p.label %></span>
                                    <span class="text-[9px] text-gray-400"><%= p.display_name %></span>
                                  </div>
                                  <% if p == current_profile %>
                                    <div class="ml-auto text-blue-600">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                      </svg>
                                    </div>
                                  <% end %>
                                <% end %>
                              <% end %>
                            </div>

                            <div class="border-t border-gray-100">
                              <%= button_to destroy_user_session_path,
                                method: :delete,
                                form: { data: { turbo_confirm: t('layouts.application.menu.confirm_logout') } }, 
                                class: "block w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 font-bold bg-transparent border-0 cursor-pointer" do %>
                                <div class="flex items-center gap-2">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                  </svg>
                                  <%= t('layouts.application.menu.logout') %>
                                </div>
                              <% end %>
                            </div>
                          </div>
                        </details>
                      <% end %>
                    </div>
                <% end %>
              </div>

              <!-- プロフィールの右に少し空けて、左詰めでナビ -->
              <% if user_signed_in? %>
                <nav class="flex items-center gap-3">
                  <!-- タスク -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "beaver_icon.png",
                                  alt: "Task",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.task') %></span>
                  <% end %>

                  <!-- ワークス -->
                  <%= link_to works_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "owl_icon.png",
                                  alt: "Works",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.works') %></span>
                  <% end %>

                  <!-- チャット -->
                  <%= link_to chat_rooms_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "wolf_icon.png",
                                  alt: "Chat",
                                  class: "block",
                                  style: "height: 27px; width: auto;" %>
                    <span><%= t('layouts.application.nav.chat') %></span>
                  <% end %>

                  <!-- ソーシャル -->
                  <%= link_to posts_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "rabbit_icon.png",
                                  alt: "Social",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.social') %></span>
                  <% end %>                  
                  
                  <!-- プロフィール -->
                  <%= link_to edit_profile_path(current_profile),
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "butterfly_icon.png",
                                  alt: "Profile",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span><%= t('layouts.application.nav.profile') %></span>
                  <% end %>

                  <!-- チーム -->
                  <%= link_to teams_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "elephant_icon.png",
                                  alt: "Team",
                                  class: "block",
                                  style: "height: 32px; width: auto;" %>
                    <span><%= t('layouts.application.nav.team') %></span>
                  <% end %>
              

                  <% if controller_name == "tasks" %>
                    <div class="ml-4">
                      <%= form_with url: tasks_path, method: :get, local: true,
                                    class: "flex items-center gap-1" do %>

                        <!-- 今の検索・フィルタ状態を引き継ぐ -->
                        <%= hidden_field_tag :q, params[:q] if params[:q].present? %>
                        <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>
                        <%= hidden_field_tag :sort, params[:sort] if params[:sort].present? %>
                        <%= hidden_field_tag :direction, params[:direction] if params[:direction].present? %>
                        <%= hidden_field_tag :view, params[:view] if params[:view].present? %>

                        <label class="flex items-center gap-1 text-xs">
                          <%= check_box_tag :all_profiles,
                                            "1",
                                            params[:all_profiles] == "1",
                                            onchange: "this.form.submit();" %>
                          <span><%= t('layouts.application.nav.all_profiles_tasks') %></span>
                        </label>
                      <% end %>
                    </div>
                  <% end %>
                </nav>
                <% end %>
            </div>

            <!-- 右側：ロゴ（イラスト） -->
            <div class="flex items-center">
              <%= link_to root_path, class: "flex items-center gap-2" do %>
                <%= image_tag "forestly_logo.png",
                              alt: "forestly",
                              class: "block",
                              style: "height: 45px; width: auto;" %>
              <% end %>
            </div>
          </div>
        </div>
      </header>

    <!-- メインコンテンツ -->
    <main class="<%= submit_mode? ? 'pt-24' : 'pt-16' %> h-screen overflow-hidden flex flex-col">
      <% if notice || alert %>
        <div class="flex-none px-6 mt-2">
          <% if notice %>
            <div class="bg-green-100 text-green-800 px-4 py-2 rounded text-sm"><%= notice %></div>
          <% end %>
          <% if alert %>
            <div class="bg-red-100 text-red-800 px-4 py-2 rounded text-sm"><%= alert %></div>
          <% end %>
        </div>
      <% end %>

      <div
        class="flex flex-1 overflow-hidden" 
        data-controller="side-panel"
        data-side-panel-initial-width-value="480"
      >
        <% if content_for?(:sidebar) %>
          <aside class="w-60 shrink-0 px-4 pt-3 pb-6 overflow-y-auto border-r <%= sidebar_theme_class %>">
            <%= yield :sidebar %>
          </aside>

          <section class="flex-1 bg-white px-6 pt-3 pb-6 overflow-y-auto border-r border-gray-100">
            <%= yield %>
          </section>
        <% else %>
          <section class="flex-1 bg-white px-6 pt-3 pb-6 overflow-y-auto border-r border-gray-100">
            <%= yield %>
          </section>
        <% end %>

        <%= render "shared/side_panel" %>
      </div>
    </main>

    <!-- Tailwind に yellow系クラスを認識させるためのダミー要素（画面には表示されません） -->
    <span class="hidden
      bg-slate-800 bg-slate-900
      bg-indigo-700 bg-indigo-800
      bg-emerald-700 bg-emerald-800
      bg-rose-700 bg-rose-800
      bg-amber-700 bg-amber-800
      text-white
      bg-white/10 text-white/80 hover:bg-white/10 hover:text-white
    "></span>

  </body>
</html>

<script>
  document.addEventListener('turbo:load', () => { // Railsの画面遷移に対応
    const closeDropdown = (e) => {
      const dropdown = document.querySelector('[data-profile-dropdown]');
      if (dropdown && !dropdown.contains(e.target)) {
        dropdown.removeAttribute('open');
      }
    };

    // 一度削除してから登録することで二重登録を防止
    document.removeEventListener('click', closeDropdown);
    document.addEventListener('click', closeDropdown);
  });
</script>