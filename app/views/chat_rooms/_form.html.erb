<!-- app/views/chat_rooms/_form.html.erb -->
<%= turbo_frame_tag "side-panel-frame" do %>
  <div class="p-4 bg-white h-full space-y-8">

    <%# --- メインフォーム開始 --- %>
    <%= form_with(model: chat_room, id: "main-room-form", class: "space-y-6") do |f| %>
      
      <%# ルーム名 %>
      <div>
        <%= f.label :name, "ルーム名", class: "block text-sm font-bold text-gray-700 mb-1" %>
        <%= f.text_field :name, class: "w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" %>
      </div>

      <%# ルームアイコン %>
      <div>
        <%= f.label :avatar, "ルームアイコン", class: "block text-sm font-bold text-gray-700 mb-1" %>
        <div class="flex items-center gap-2">
          <%= f.label :avatar, class: "px-3 py-1 border border-gray-300 rounded text-[11px] bg-white cursor-pointer" do %>
            画像をアップロード
          <% end %>
          <%= f.file_field :avatar, accept: "image/*", class: "hidden" %>
        </div>
      </div>

    <%# 共通の検索入力（両方のリストを同時に絞り込む） %>
        <div class="mb-4">
        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">メンバーを絞り込む</label>
        <input type="text" 
                placeholder="名前やチーム名で検索..." 
                class="w-full p-2 text-xs border border-gray-200 rounded-lg focus:ring-1 focus:ring-blue-400 outline-none shadow-sm"
                onkeyup="let v=this.value.toLowerCase(); document.querySelectorAll('.member-label').forEach(l => l.style.display = l.innerText.toLowerCase().includes(v) ? 'flex' : 'none')">
        </div>

    <%# 候補者｜チームメンバー %>
    <div class="space-y-2">
        <label class="block text-sm font-bold text-gray-700 flex justify-between items-center">
            <span>チームメンバーから招待</span>
        </label>
        
        <div class="border rounded-xl overflow-hidden bg-gray-50/50 resize-y" style="height: 120px; min-height: 80px; max-height: 400px;">
            <div class="h-full overflow-y-auto divide-y divide-gray-100">
            <%= f.collection_check_boxes :profile_ids, @team_members, :id, :display_name do |b| %>
                <label class="member-label flex items-center gap-2 py-1 px-3 hover:bg-white transition cursor-pointer group">
                    <div class="relative flex items-center">
                        <%= b.check_box class: "w-3.5 h-3.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" %>
                    </div>
                    <div class="shrink-0 scale-75 origin-left">
                        <%= profile_avatar(b.object, size: :sm) %>
                    </div>
                    <div class="flex-1 min-w-0 flex items-baseline gap-1.5">
                        <span class="text-xs font-bold text-gray-800 truncate"><%= b.object.display_name %></span>
                        <% if b.object.primary_team %>
                        <span class="text-[9px] text-gray-400 truncate italic">
                            - <%= b.object.primary_team.full_hierarchical_name %>
                        </span>
                        <% end %>
                    </div>
                </label>
            <% end %>
            </div>
        </div>
        </div>

    <%# 候補者｜コンタクト済みプロフィール %>
        <div class="space-y-2">
        <label class="block text-sm font-bold text-gray-700">過去のコンタクトから招待</label>
        <div class="border rounded-xl overflow-hidden bg-gray-50/50 resize-y" style="height: 120px; min-height: 80px; max-height: 400px;">
            <div class="h-full overflow-y-auto divide-y divide-gray-100">
            <%= f.collection_check_boxes :profile_ids, @past_contacts || [], :id, :display_name do |b| %>
                <label class="member-label flex items-center gap-2 py-1 px-3 hover:bg-white transition cursor-pointer group">
                    <div class="relative flex items-center">
                        <%= b.check_box class: "w-3.5 h-3.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
                    </div>
                    <div class="shrink-0 scale-75 origin-left">
                        <%= profile_avatar(b.object, size: :sm) %>
                    </div>
                    <div class="flex-1 min-w-0 flex items-baseline gap-1.5">
                        <span class="text-xs font-bold text-gray-800 truncate"><%= b.object.display_name %></span>
                        <% if b.object.primary_team %>
                        <span class="text-[9px] text-gray-400 truncate italic">
                            - <%= b.object.primary_team.full_hierarchical_name %>
                        </span>
                        <% end %>
                    </div>
                </label>
            <% end %>
            </div>
        </div>
        </div>

      <%# ID検索で追加されたチップが表示される場所 %>
      <div id="added-profiles-list" class="flex flex-wrap gap-2 p-2 bg-gray-50 rounded-lg border border-dotted border-gray-300">
        <p id="no-added-hint" class="text-[10px] text-gray-400 italic">検索から追加するとここに表示されます</p>
      </div>

      <%# ★重要：ここで一旦メインフォームを「終わらせる」 %>
      <div class="pt-4 border-t">
        <%= f.submit chat_room.new_record? ? "ルームを作成する" : "更新する", 
                     class: "w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg cursor-pointer" %>
      </div>
    <% end %>
    <%# --- メインフォーム終了 --- %>

    <hr class="border-dashed border-gray-200">

    <%# 5. 新規コンタクトユーザー（検索&追加）を一番下に配置 %>
    <label class="block text-sm font-bold text-gray-700">コンタクトがないプロフィールを招待</label>
    <div class="p-4 bg-blue-50/50 border border-blue-100 rounded-xl">
      <label class="block text-xs font-bold text-blue-800 mb-2 uppercase tracking-wider">IDで新規ユーザーを検索</label>
      
      <%# 独立した検索フォーム %>
      <%= form_with url: new_chat_room_path, method: :get, class: "flex gap-2" do %>
        <%= text_field_tag :invite_token, params[:invite_token], placeholder: "IDを入力", class: "flex-1 p-2 border border-blue-200 rounded-lg text-sm" %>
        <%= submit_tag "検索", class: "px-4 py-2 bg-blue-500 text-white text-sm font-bold rounded-lg cursor-pointer" %>
      <% end %>

    <% if @found_profile %>
        <div class="mt-3 p-2 bg-white border border-blue-200 rounded-lg flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-2">
            <%# A. 表示用のチップ %>
            <%= profile_chip(@found_profile, size: :xs) %>
            <span class="text-xs font-medium text-gray-700">さん</span>
            </div>

            <%# B. JSでコピーするための「種」を隠して持っておく %>
            <div id="found-profile-seed" class="hidden">
            <%= profile_chip(@found_profile, size: :xs) %>
            </div>

            <button type="button" 
                    class="px-3 py-1.5 bg-blue-600 text-white text-[10px] font-bold rounded-md hover:bg-blue-700 transition"
                    data-id="<%= @found_profile.id %>"
                    data-name="<%= @found_profile.display_name %>"
                    onclick="addProfileFromSeed(this)">
            追加する
            </button>
        </div>
    <% end %>
    </div>
  </div>

    <script>
    function addProfileFromSeed(button) {
        const id = button.dataset.id;
        const name = button.dataset.name;
        
        // 隠してある「種」要素からHTMLを取得する（ここならクォート問題が起きない）
        const avatarHtml = document.getElementById('found-profile-seed').innerHTML;
        
        addProfileToSelection(id, name, avatarHtml);
    }

    function addProfileToSelection(id, name, avatarHtml) {
        const list = document.getElementById('added-profiles-list');
        const hint = document.getElementById('no-added-hint');
        
        if (document.getElementById(`searched-profile-${id}`)) {
        alert("既に追加されています");
        return;
        }

        if (hint) hint.remove();

        const wrapper = document.createElement('div');
        wrapper.id = `searched-profile-${id}`;
        wrapper.className = "flex items-center gap-2 px-3 py-1.5 border rounded-full bg-blue-600 text-white text-xs font-medium animate-in zoom-in duration-200";
        
        wrapper.innerHTML = `
        ${avatarHtml} 
        <span>${name}</span>
        <input type="hidden" name="searched_profile_ids[]" value="${id}" form="main-room-form">
        <button type="button" onclick="this.parentElement.remove()" class="ml-1 hover:text-red-200">✕</button>
        `;
        
        list.appendChild(wrapper);
    }
    </script>
<% end %>