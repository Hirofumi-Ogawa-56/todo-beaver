<!-- app/views/team_settings/members.html.erb -->
<% content_for :sidebar do %>
  <%= render "team_settings/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">メンバー管理</h1>

<% if @teams.any? %>
  <!-- チーム選択 -->
  <div class="mb-4">
    <%= form_with url: members_team_settings_path, method: :get, local: true, class: "inline-block" do |f| %>
      <label class="text-sm mr-2">チームを選択：</label>
      <%= f.select :team_id,
                   options_from_collection_for_select(@teams, :id, :name, @selected_team&.id),
                   {},
                   class: "border border-gray-300 rounded px-2 py-1 text-sm",
                   onchange: "this.form.submit();" %>
    <% end %>
  </div>

  <% if @selected_team %>
    <div class="flex items-center mb-2">
      <%= team_chip(
            @selected_team,
            size: :sm,
            wrapper_class: "px-2 py-1 rounded bg-gray-100 text-sm"
          ) %>
      <span class="ml-2 text-sm text-gray-500">のメンバー</span>
    </div>

    <!-- メンバー一覧 -->
    <% if @memberships.any? %>
      <table class="w-full text-sm mb-4">
        <thead>
          <tr class="border-b">
            <th class="text-left py-2">プロフィール名</th>
            <th class="text-left py-2">役割</th>
            <th class="text-left py-2"></th>
          </tr>
        </thead>
        <tbody>
          <% @memberships.each do |membership| %>
            <tr>
              <td class="py-1">
                <%= profile_chip(
                  membership.profile,
                  size: :xs,
                  wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                ) %>
              </td>

              <td class="py-2">
                <% if @can_manage_members %>
                  <!-- ✅ 管理者の場合だけ、プルダウンで変更できる -->
                  <%= form_with model: membership,
                                url: team_membership_path(membership),
                                method: :patch,
                                local: true,
                                class: "inline-block" do |f| %>
                    <%= f.select :role,
                                options_for_select(
                                  [
                                    ["管理者", TeamMembership::ADMIN_ROLE],
                                    ["メンバー", ""]
                                  ],
                                  membership.admin? ? TeamMembership::ADMIN_ROLE : ""
                                ),
                                {},
                                class: "border border-gray-300 rounded px-2 py-1 text-xs",
                                onchange: "this.form.submit();" %>
                  <% end %>
                <% else %>
                  <!-- ✅ メンバーは「表示だけ」 -->
                  <% if membership.admin? %>
                    管理者
                  <% else %>
                    メンバー
                  <% end %>
                <% end %>
              </td>

              <td class="py-2 text-right">
                <% if @can_manage_members %>
                  <%= button_to "削除",
                                team_membership_path(membership),
                                method: :delete,
                                data: { turbo_confirm: "このメンバーを削除しますか？" },
                                class: "text-xs px-3 py-1 bg-red-50 text-red-700 rounded border border-red-200 hover:bg-red-100" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      
    <% else %>
      <p class="text-sm text-gray-500 mb-4">
        まだこのチームにはメンバーがいません。
      </p>
    <% end %>

    <!-- ▼ 申請IDでプロフィールを招待するセクション ▼ -->
      <div class="mt-6 border-t pt-4">
        <h3 class="text-sm font-semibold mb-2">参加申請一覧</h3>

        <% if @incoming_join_requests.any? %>
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b">
                <th class="text-left py-1">申請プロフィール</th>
                <th class="text-left py-1"></th>
              </tr>
            </thead>
            <tbody>
              <% @incoming_join_requests.each do |req| %>
                <tr class="border-b">
                  <td class="py-1">
                    <% if req.requester_profile %>
                      <%= profile_chip(
                            req.requester_profile,
                            size: :xs,
                            wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                          ) %>
                    <% else %>
                      <span class="text-xs text-gray-400">不明</span>
                    <% end %>
                  </td>
                  <td class="py-1 text-right">
                    <%= button_to "承認",
                                  approve_membership_request_path(req),
                                  method: :patch,
                                  class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p class="text-xs text-gray-500 mt-2">参加申請はありません。</p>
        <% end %>
      </div>


  <% end %>
<% else %>
  <p class="text-sm text-gray-500">
    まだチームがありません。「チームを作成する」から追加してください。
  </p>
<% end %>
