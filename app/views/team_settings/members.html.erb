<!-- app/views/team_settings/members.html.erb -->
<% content_for :sidebar do %>
  <%= render "team_settings/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">メンバー管理</h1>

<% if @teams.any? %>
  <!-- チーム選択 -->
  <div class="mb-4">
    <%= form_with url: members_team_settings_path, method: :get, local: true, class: "inline-block" do |f| %>
      <label class="text-sm mr-2">チームを選択：</label>
      <%= f.select :team_id,
                   options_from_collection_for_select(@teams, :id, :name, @selected_team&.id),
                   {},
                   class: "border border-gray-200 rounded px-2 py-1 text-sm",
                   onchange: "this.form.submit();" %>
    <% end %>
  </div>

  <% if @selected_team %>
    <div class="flex items-center mb-2">
      <%= team_chip(
            @selected_team,
            size: :sm,
            wrapper_class: "px-2 py-1 rounded bg-gray-100 text-sm"
          ) %>
      <span class="ml-2 text-sm text-gray-500">のメンバー</span>
    </div>

    <!-- メンバー一覧 -->
    <% if @memberships.any? %>
      <table class="w-full text-sm mb-4">
        <thead>
          <tr class="border-b">
            <th class="text-left py-2">プロフィール名</th>
            <th class="text-left py-2">役割</th>
            <th class="text-left py-2"></th>
          </tr>
        </thead>
        <tbody>
          <% @memberships.each do |membership| %>
            <tr>
              <td class="py-1">
                <%= profile_chip(
                  membership.profile,
                  size: :xs,
                  wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                ) %>
              </td>

              <td class="py-2">
                <% if @can_manage_members %>
                  <!-- ✅ 管理者の場合だけ、プルダウンで変更できる -->
                  <%= form_with model: membership,
                                url: team_membership_path(membership),
                                method: :patch,
                                local: true,
                                class: "inline-block" do |f| %>
                    <%= f.select :role,
                                options_for_select(
                                  [
                                    ["管理者", TeamMembership::ADMIN_ROLE],
                                    ["メンバー", ""]
                                  ],
                                  membership.admin? ? TeamMembership::ADMIN_ROLE : ""
                                ),
                                {},
                                class: "border border-gray-200 rounded px-2 py-1 text-xs",
                                onchange: "this.form.submit();" %>
                  <% end %>
                <% else %>
                  <!-- ✅ メンバーは「表示だけ」 -->
                  <% if membership.admin? %>
                    管理者
                  <% else %>
                    メンバー
                  <% end %>
                <% end %>
              </td>

              <td class="py-2 text-right">
                <% if @can_manage_members %>
                  <%= button_to "削除",
                                team_membership_path(membership),
                                method: :delete,
                                data: { turbo_confirm: "このメンバーを削除しますか？" },
                                class: "text-xs px-3 py-1 bg-red-50 text-red-700 rounded border border-red-200 hover:bg-red-100" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      
    <% else %>
      <p class="text-sm text-gray-500 mb-4">
        まだこのチームにはメンバーがいません。
      </p>
    <% end %>

    <!-- ▼ 申請IDでプロフィールを招待するセクション ▼ -->
    <div class="mt-6 border-t pt-4">
      <h3 class="text-sm font-semibold mb-2">チーム招待IDでプロフィールを招待</h3>

      <!-- 1. チーム招待IDでプロフィールを検索するフォーム（GET） -->
      <%= form_with url: members_team_settings_path, method: :get, local: true, class: "flex flex-wrap items-end gap-2 mb-3" do |f| %>
        <%= hidden_field_tag :team_id, @selected_team.id %>

        <div>
          <label class="block text-xs mb-1">申請ID</label>
          <%= text_field_tag :invite_token,
                             @invite_token,
                             class: "border rounded px-2 py-1 text-sm",
                             placeholder: "例）AB12CD34" %>
        </div>

        <div class="mb-1">
          <%= f.submit "プロフィールを検索",
                       class: "px-3 py-2 text-xs bg-gray-100 rounded border hover:bg-gray-200" %>
        </div>
      <% end %>

      <% if @invite_token.present? %>
        <% if @invite_profiles.any? %>
          <!-- 2. 検索結果から招待を送るフォーム（POST） -->
          <div class="mt-2">
            <%= form_with url: membership_requests_path, method: :post, local: true, class: "flex flex-wrap items-end gap-2" do |f| %>
              <%= hidden_field_tag :direction, "team_to_profile" %>
              <%= hidden_field_tag :team_id, @selected_team.id %>

              <div>
                <label class="block text-xs mb-1">招待するプロフィール</label>
                <%= select_tag :target_profile_id,
                               options_from_collection_for_select(@invite_profiles, :id, :display_name),
                               class: "border rounded px-2 py-1 text-sm" %>
              </div>

              <div>
                <label class="block text-xs mb-1">管理者として招待</label>
                <%= check_box_tag :admin, "1", false, class: "mr-1" %>
                <span class="text-xs">このプロフィールを管理者として追加する</span>
              </div>

              <div class="mb-1">
                <%= f.submit "招待を送る",
                             class: "px-4 py-2 text-xs bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-xs text-red-500 mt-2">
            入力されたチーム招待IDに該当するプロフィールが見つかりませんでした。
          </p>
        <% end %>
      <% end %>
    </div>
    <!-- ▲ チーム招待IDでプロフィールを招待するセクション ここまで ▲ -->

  <% end %>
<% else %>
  <p class="text-sm text-gray-500">
    まだチームがありません。「チームを作成する」から追加してください。
  </p>
<% end %>
