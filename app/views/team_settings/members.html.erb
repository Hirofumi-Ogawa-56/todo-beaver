<!-- app/views/team_settings/members.html.erb -->
<% content_for :sidebar do %>
  <%= render "team_settings/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4"><%= t('teams.members.title') %></h1>

<% if @teams.any? %>
  <!-- チーム選択 -->
  <div class="mb-4">
    <%= form_with url: members_team_settings_path, method: :get, local: true, class: "inline-block" do |f| %>
      <label class="text-sm mr-2"><%= t('teams.members.select_team') %></label>
      <%= f.select :team_id,
                   options_from_collection_for_select(@teams, :id, :name, @selected_team&.id),
                   {},
                   class: "border border-gray-300 rounded px-2 py-1 text-sm",
                   onchange: "this.form.submit();" %>
    <% end %>
  </div>

  <% if @selected_team %>
    <div class="flex items-center mb-2">
      <%= team_chip(
            @selected_team,
            size: :sm,
            wrapper_class: "px-2 py-1 rounded bg-gray-100 text-sm"
          ) %>
      <span class="ml-2 text-sm text-gray-500"><%= t('teams.members.suffix_of_team') %></span>
    </div>

    <!-- メンバー一覧 -->
    <% if @memberships.any? %>
      <table class="w-full text-sm mb-4">
        <thead>
          <tr class="border-b">
            <th class="text-left py-2"><%= t('activerecord.models.profile') %></th>
            <th class="text-left py-2"><%= t('teams.members.role') %></th>
            <th class="text-left py-2"></th>
          </tr>
        </thead>
        <tbody>
          <% @memberships.each do |membership| %>
            <tr>
              <td class="py-1">
                <%= profile_chip(
                  membership.profile,
                  size: :xs,
                  wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                ) %>
              </td>

              <td class="py-2">
                <% if @can_manage_members %>
                  <!-- ✅ 管理者の場合だけ、プルダウンで変更できる -->
                  <%= form_with model: membership,
                                url: team_membership_path(membership),
                                method: :patch,
                                local: true,
                                class: "inline-block" do |f| %>
                    <%= f.select :role,
                                options_for_select(
                                  [
                                    [t('teams.members.roles.admin'), TeamMembership::ADMIN_ROLE],
                                    [t('teams.members.roles.member'), ""]
                                  ],
                                  membership.admin? ? TeamMembership::ADMIN_ROLE : ""
                                ),
                                {},
                                class: "border border-gray-300 rounded px-2 py-1 text-xs",
                                onchange: "this.form.submit();" %>
                  <% end %>
                <% else %>
                  <!-- ✅ メンバーは「表示だけ」 -->
                  <%= membership.admin? ? t('teams.members.roles.admin') : t('teams.members.roles.member') %>
                <% end %>
              </td>

              <td class="py-2 text-right">
                <% if @can_manage_members %>
                  <%= button_to t('common.delete'),
                                team_membership_path(membership),
                                method: :delete,
                                form: { data: { turbo_confirm: t('teams.members.confirm_remove') }},
                                class: "text-xs px-3 py-1 bg-red-50 text-red-700 rounded border border-red-200 hover:bg-red-100" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      
    <% else %>
      <p class="text-sm text-gray-500 mb-4">
        <%= t('teams.members.no_members') %>
      </p>
    <% end %>

    <!-- プロフィールへ招待を送る項目 -->
    <div class="mt-6 border-t pt-4">
      <h3 class="text-sm font-semibold mb-2"><%= t('teams.members.invite_section_title') %></h3>

      <%= form_with url: members_team_settings_path, method: :get, local: true, class: "flex items-end gap-2 mb-3" do %>
        <%= hidden_field_tag :team_id, @selected_team.id %>
        <div>
          <label class="block text-xs mb-1"><%= t('teams.members.invite_id_label') %></label>
          <%= text_field_tag :profile_invite_token, @profile_invite_token, 
                            class: "border rounded px-2 py-1 text-sm", placeholder: "個人のIDを入力" %>
        </div>
        <div class="mb-1">
          <%= submit_tag t('common.search'), class: "px-3 py-2 text-xs bg-gray-100 rounded border hover:bg-gray-200" %>
        </div>
      <% end %>

      <% if @found_profile %>
        <div class="p-3 bg-blue-50 border border-blue-200 rounded flex items-center justify-between">
          <div class="flex items-center gap-2">
            <%= profile_chip(@found_profile, size: :xs) %>
            <span class="text-xs text-gray-600"><%= t('teams.members.invite_confirm_msg') %></span>
          </div>
          <%= form_with url: membership_requests_path, method: :post, local: true do %>
            <%= hidden_field_tag :direction, "team_to_profile" %>
            <%= hidden_field_tag :team_id, @selected_team.id %>
            <%= hidden_field_tag :target_profile_id, @found_profile.id %>

            <label class="inline-flex items-center gap-1 cursor-pointer">
              <%= check_box_tag :admin, "1", false, class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
              <span class="text-xs text-gray-700 font-medium"><%= t('teams.members.invite_as_admin') %></span>
            </label>

            <%= submit_tag t('teams.members.send_invite'), class: "px-4 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700" %>
          <% end %>
        </div>
      <% end %>
    </div>



    <!-- 参加申請を確認する項目 -->
      <div class="mt-6 border-t pt-4">
        <h3 class="text-sm font-semibold mb-2"><%= t('teams.members.join_requests_title') %></h3>

        <% if @incoming_join_requests.any? %>
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b">
                <th class="text-left py-1"><%= t('teams.members.requester') %></th>
                <th class="text-left py-1"></th>
              </tr>
            </thead>
            <tbody>
              <% @incoming_join_requests.each do |req| %>
                <tr class="border-b">
                  <td class="py-1">
                    <% if req.requester_profile %>
                      <%= profile_chip(
                            req.requester_profile,
                            size: :xs,
                            wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                          ) %>
                    <% else %>
                      <span class="text-xs text-gray-400"><%= t('common.unknown') %></span>
                    <% end %>
                  </td>
                  <td class="py-1 text-right">
                    <%= button_to t('common.approve'),
                                  approve_membership_request_path(req),
                                  method: :patch,
                                  class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p class="text-xs text-gray-500 mt-2"><%= t('teams.members.no_requests') %></p>
        <% end %>
      </div>


  <% end %>
<% else %>
  <p class="text-sm text-gray-500"><%= t('teams.index.no_teams_html') %></p>
<% end %>
