--- FILE: app/mailers/application_mailer.rb ---
class ApplicationMailer < ActionMailer::Base
  default from: "from@example.com"
  layout "mailer"
end


--- FILE: app/models/reaction.rb ---
# app/models/reaction.rb
class Reaction < ApplicationRecord
  belongs_to :comment
  belongs_to :profile

  KINDS = %w[heart].freeze  # 将来ここに "smile", "thumbs_up" など足せる

  validates :kind,
            presence: true,
            inclusion: { in: KINDS }
end


--- FILE: app/models/tag.rb ---
# app/models/tag.rb
class Tag < ApplicationRecord
  has_many :task_tags, dependent: :destroy
  has_many :tasks, through: :task_tags

  validates :name, presence: true, uniqueness: true, length: { maximum: 20 }
end


--- FILE: app/models/task_tag.rb ---
# app/models/task_tag.rb
class TaskTag < ApplicationRecord
  belongs_to :task
  belongs_to :tag

  validates :tag_id, uniqueness: { scope: :task_id }
end


--- FILE: app/models/membership_request.rb ---
# app/models/membership_request.rb
class MembershipRequest < ApplicationRecord
  # 関連
  belongs_to :requester_profile, class_name: "Profile"
  belongs_to :target_profile, class_name: "Profile", optional: true
  belongs_to :team

  # 方向
  enum :direction, { profile_to_team: 0, team_to_profile: 1 }

  # 状態
  enum :status, { pending: 0, approved: 1, rejected: 2, canceled: 3 }

  # バリデーション
  validates :direction, presence: true
  validates :status, presence: true

  # 同じ内容の pending 申請を重複させない
  validates :requester_profile_id,
            uniqueness: {
              scope: [ :target_profile_id, :team_id, :direction ],
              conditions: -> { where(status: statuses[:pending]) },
              message: "同じ申請がすでに送信されており、承認待ちです。"
            }

  validate :target_presence

  private

  # direction に応じて、team or target_profile が必須
  def target_presence
    case direction&.to_sym
    when :profile_to_team
      errors.add(:team, "を指定してください") if team.nil?
    when :team_to_profile
      errors.add(:team, "を指定してください") if team.nil?
      errors.add(:target_profile, "を指定してください") if target_profile.nil?
    end
  end
end


--- FILE: app/models/task_assignment.rb ---
# app/models/task_assignment.rb
class TaskAssignment < ApplicationRecord
  belongs_to :task
  belongs_to :profile

  validates :profile_id, uniqueness: { scope: :task_id }
end


--- FILE: app/models/team.rb ---
# app/models/team.rb
class Team < ApplicationRecord
  has_many :team_memberships, dependent: :destroy
  has_many :profiles, through: :team_memberships
  has_many :membership_requests, dependent: :destroy

  has_one_attached :avatar

  validates :name, presence: true, length: { maximum: 30 }
  validates :join_token, uniqueness: true, allow_nil: true

  before_create :set_join_token

  def display_initials
    base = name.presence || "?"
    base.split(/\s+/).map { |part| part[0] }.join[0, 2].upcase
  end

  attr_accessor :remove_avatar

  before_save :purge_avatar_if_requested

  private

  def set_join_token
    self.join_token ||= generate_unique_join_token
  end

  def generate_unique_join_token
    loop do
      token = SecureRandom.alphanumeric(8).upcase
      break token unless self.class.exists?(join_token: token)
    end
  end

  def purge_avatar_if_requested
    return if remove_avatar.blank?

    # "0" / "1" が来るので boolean キャスト
    flag = ActiveModel::Type::Boolean.new.cast(remove_avatar)
    avatar.purge if flag && avatar.attached?
  end
end


--- FILE: app/models/team_membership.rb ---
# app/models/team_membership.rb
class TeamMembership < ApplicationRecord
  belongs_to :team
  belongs_to :profile

  validates :profile_id, uniqueness: { scope: :team_id }

  ADMIN_ROLE = "admin"

  scope :admins, -> { where(role: ADMIN_ROLE) }

  def admin?
    role == ADMIN_ROLE
  end

  # 管理者がゼロになったら、全員を管理者にする
  after_destroy :ensure_at_least_one_admin
  after_update :ensure_at_least_one_admin, if: :saved_change_to_role?

  private

  def ensure_at_least_one_admin
    # まだこのチームに管理者がいれば何もしない
    return if team.team_memberships.admins.exists?

    # いなければ、このチームのメンバー全員を管理者に昇格
    team.team_memberships.update_all(role: ADMIN_ROLE)
  end
end


--- FILE: app/models/profile.rb ---
# app/models/profile.rb
class Profile < ApplicationRecord
  belongs_to :user

  validates :label, presence: true, length: { maximum: 25 }
  validates :display_name, presence: true, length: { maximum: 30 }

  validates :join_token, uniqueness: true, allow_nil: true

  has_many :team_memberships, dependent: :destroy
  has_many :teams, through: :team_memberships

  has_many :task_assignments, dependent: :destroy
  has_many :assigned_tasks, through: :task_assignments, source: :task
  has_many :comments, foreign_key: :author_profile_id, dependent: :nullify
  has_many :reactions, dependent: :destroy

  has_many :sent_membership_requests,
           class_name: "MembershipRequest",
           foreign_key: :requester_profile_id,
           dependent: :destroy

  has_many :received_membership_requests,
           class_name: "MembershipRequest",
           foreign_key: :target_profile_id,
           dependent: :destroy

  has_one_attached :avatar

  attr_accessor :remove_avatar

  before_create :set_join_token
  before_save :purge_avatar_if_needed

    THEMES = %w[
    default
    slate
    indigo
    emerald
    rose
    amber
    ].freeze

  validates :theme, inclusion: { in: THEMES }, allow_blank: true

  before_validation :set_default_theme, on: :create


  def display_initials
    base = display_name.presence || label.presence || "?"
    base.split(/\s+/).map { |part| part[0] }.join[0, 2].upcase
  end

  private

  def set_join_token
    self.join_token ||= generate_unique_join_token
  end

  def purge_avatar_if_needed
    if ActiveModel::Type::Boolean.new.cast(remove_avatar)
      avatar.purge
    end
  end

  def generate_unique_join_token
    loop do
      token = SecureRandom.alphanumeric(8).upcase # 例: "A9B3ZK1Q"
      break token unless self.class.exists?(join_token: token)
    end
  end

  def purge_avatar_if_requested
    return unless ActiveModel::Type::Boolean.new.cast(remove_avatar)
    avatar.purge_later if avatar.attached?
  end

  def set_default_theme
    self.theme = "default" if theme.blank?
  end
end


--- FILE: app/models/comment.rb ---
# app/models/comment.rb
class Comment < ApplicationRecord
  belongs_to :task
  belongs_to :author_profile, class_name: "Profile"

  def pinned?
    pinned
  end

  has_many :reactions, dependent: :destroy
  has_many :heart_reactions,
           -> { where(kind: "heart") },
           class_name: "Reaction"

  validates :body, presence: true, length: { maximum: 2000 }
end


--- FILE: app/models/application_record.rb ---
class ApplicationRecord < ActiveRecord::Base
  primary_abstract_class
end


--- FILE: app/models/user.rb ---
# app/models/user.rb

# Userクラスの定義
class User < ApplicationRecord
  # Userの機能を定義
  devise :database_authenticatable,
        :registerable,
        :recoverable,
        :rememberable,
        :validatable,
        :confirmable

  # Userの関連を定義
  has_many :profiles, dependent: :destroy # 一人のUserはたくさんのProfileを持てる
end


--- FILE: app/models/task.rb ---
# app/models/task.rb
class Task < ApplicationRecord
  belongs_to :owner_profile,    class_name: "Profile"
  belongs_to :assignee_profile, class_name: "Profile", optional: true
  belongs_to :team, optional: true

  has_many :task_tags, dependent: :destroy
  has_many :tags, through: :task_tags
  has_many :task_assignments, dependent: :destroy
  has_many :assignees, through: :task_assignments, source: :profile
  has_many :comments, dependent: :destroy
  has_many :pinned_comments,
           -> { where(pinned: true).order(created_at: :asc) },
           class_name: "Comment"

  enum :status, { todo: 0, done: 1, in_progress: 2, archived: 3 }

  validates :title, presence: true, length: { maximum: 30 }
  validates :status, presence: true


  # フォーム用の「仮想」属性
  attr_accessor :due_date, :due_time, :tag_list

  # 検索スコープ
  scope :keyword_search, ->(query) do
    terms = query.to_s.strip.split(/\s+/)
    rel   = left_outer_joins(:tags).distinct

    terms.each do |term|
      next if term.blank?

      pattern = "%#{sanitize_sql_like(term)}%" # ← Task. は不要

      rel = rel.where(
        "tasks.title ILIKE :pattern OR tasks.description ILIKE :pattern OR tags.name ILIKE :pattern",
        pattern:
      )
    end

    rel
  end

  # フォーム表示用：既存タグ → カンマ区切り文字列
  def tag_list
    @tag_list || tags.pluck(:name).join(", ")
  end

  # カンマ区切り文字列から tags 関連を更新
  def update_tags_from_list!
    names =
      tag_list.to_s
              .split(/[,\n]/)
              .map { |n| n.strip }
              .reject(&:blank?)
              .uniq

    new_tags = names.map { |name| Tag.find_or_create_by!(name: name) }
    self.tags = new_tags
  end

  private

  def due_at_cannot_be_in_the_past
    return if due_at >= Time.current.beginning_of_day

    errors.add(:due_at, "は今日以降を指定してください")
  end
end


--- FILE: app/jobs/application_job.rb ---
class ApplicationJob < ActiveJob::Base
  # Automatically retry jobs that encountered a deadlock
  # retry_on ActiveRecord::Deadlocked

  # Most jobs are safe to ignore if the underlying records are no longer available
  # discard_on ActiveJob::DeserializationError
end


--- FILE: app/controllers/application_controller.rb ---
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  allow_browser versions: :modern
  before_action :authenticate_user!, unless: :devise_controller?
  before_action :set_current_profile
  helper_method :current_profile

  private

  def set_current_profile
    return unless user_signed_in?

    if session[:current_profile_id].present?
      @current_profile = current_user.profiles.find_by(id: session[:current_profile_id])
    end

    if @current_profile.nil?
      @current_profile = current_user.profiles.order(created_at: :asc).first
      session[:current_profile_id] = @current_profile.id if @current_profile
    end
  end

  def current_profile
    @current_profile
  end

  def switch_profile(profile)
    return unless user_signed_in?
    return unless profile.user_id == current_user.id

    session[:current_profile_id] = profile.id
    @current_profile = profile
  end

  def require_current_profile!
    return if current_profile

    redirect_to profiles_path,
                alert: "タスクを利用するにはプロフィールを選択してください。"
  end
end


--- FILE: app/controllers/profile_settings_controller.rb ---
# app/controllers/profile_settings_controller.rb
class ProfileSettingsController < ApplicationController
  before_action :authenticate_user!

  def home
    @profile = current_profile

    if @profile
      @incoming_team_invites =
        @profile.received_membership_requests
                .team_to_profile
                .pending
                .includes(:team, :requester_profile)
    else
      @incoming_team_invites = MembershipRequest.none
    end
  end

  def edit
    @profile = current_profile
    unless @profile
      redirect_to edit_profile_path(current_profile), alert: "編集中のプロフィールが選択されていません。"
      return
    end

    @incoming_team_invites =
      @profile.received_membership_requests
              .team_to_profile
              .pending
              .includes(:team, :requester_profile)

    # ▼ 参加IDでチーム検索（GET）
    @team_invite_token = params[:team_invite_token].to_s.strip.upcase
    @invite_teams = @team_invite_token.present? ? Team.where(join_token: @team_invite_token) : Team.none
  end

  def theme; end
end


--- FILE: app/controllers/reactions_controller.rb ---
# app/controllers/reaction_controller.rb
class ReactionsController < ApplicationController
  before_action :authenticate_user!
  before_action :require_current_profile!
  before_action :set_comment

  def create
    reaction = @comment.reactions.find_by(
      profile: current_profile,
      kind: "heart"
    )

    if reaction
      # すでに押している → 解除
      reaction.destroy
    else
      # まだ押していない → 付与
      @comment.reactions.create!(
        profile: current_profile,
        kind: "heart"
      )
    end

    redirect_to task_path(@comment.task)
  end

  private

  def set_comment
    @comment = Comment.find(params[:comment_id])
  end
end


--- FILE: app/controllers/teams_controller.rb ---
# app/controllers/teams_controller.rb
class TeamsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_team, only: %i[show edit update destroy]

  def index
    # いまは「自分が作ったチーム」という概念がないので、とりあえず全件
    # 後で TeamMembership や owner_profile ができたら絞り込む
    @teams = Team.order(created_at: :desc)
  end

  def show
  end

  def new
    @team = Team.new
  end

  def create
    @team = Team.new(team_params)

    if @team.save
      # 作成した人を自動的に管理者にする
      if current_profile
        TeamMembership.create!(
          team: @team,
          profile: current_profile,
          role: TeamMembership::ADMIN_ROLE
        )
      end
      redirect_to @team, notice: "チームを作成しました"
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @team.update(team_params)
      redirect_to @team, notice: "チームを更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def destroy
    @team.destroy
    redirect_to teams_path, notice: "チームを削除しました"
  end

  private

  def set_team
    @team = Team.find(params[:id])
  end

  def team_params
    params.require(:team).permit(
      :name,
      :avatar,
      :remove_avatar
      )
  end
end


--- FILE: app/controllers/account_settings_controller.rb ---
# app/controllers/account_settings_controller.rb
class AccountSettingsController < ApplicationController
  before_action :authenticate_user!

  def send_change_email
    new_email = params[:email].to_s.strip

    if new_email.blank?
      redirect_back fallback_location: edit_user_registration_path, alert: "新しいメールアドレスを入力してください"
      return
    end

    if current_user.update(email: new_email)
      redirect_back fallback_location: edit_user_registration_path,
                    notice: "確認メールを送信しました。メール内リンクから手続きを進めてください。"
    else
      redirect_back fallback_location: edit_user_registration_path,
                    alert: current_user.errors.full_messages.first
    end
  end

  def send_password_reset
    current_user.send_reset_password_instructions
    redirect_back fallback_location: edit_user_registration_path,
                  notice: "パスワード変更用のメールを送信しました。"
  end
end


--- FILE: app/controllers/tasks_controller.rb ---
# app/controllers/tasks_controller.rb
class TasksController < ApplicationController
  before_action :authenticate_user!
  before_action :require_current_profile!
  before_action :set_task, only: %i[show edit update destroy]
  before_action :set_collections, only: %i[new create edit update]

  def index
    @view_mode = params[:view] == "calendar" ? "calendar" : "list"
    @all_profiles_mode = (params[:all_profiles] == "1")

    if @all_profiles_mode
      profile_ids = current_user.profiles.pluck(:id)

      assigned_task_ids =
        TaskAssignment.where(profile_id: profile_ids).select(:task_id)

      base_scope =
        Task.where(owner_profile_id: profile_ids)
            .or(Task.where(id: assigned_task_ids))
    else
      assigned_task_ids =
        TaskAssignment.where(profile_id: current_profile.id).select(:task_id)

      base_scope =
        Task.where(owner_profile_id: current_profile.id)
            .or(Task.where(id: assigned_task_ids))
    end

    if @view_mode == "calendar"
      setup_calendar(base_scope)
      render :calendar
    else
      @query = params[:q].to_s

      rel = apply_filter(base_scope)
      rel = rel.keyword_search(@query) if @query.present?
      rel = apply_column_filters(rel)

      @tasks =
        rel
          .includes(:team, :owner_profile, :assignees)
          .order(build_order_clause)
          .page(params[:page])
          .per(50)

      respond_to do |format|
        format.html          # 初回表示 / 通常遷移
        format.turbo_stream  # もっと見る用（.turbo_stream を付けて叩く）
      end
    end
  end

  def slot_tasks
    # date と hour は +N バッジ側からパラメータでもらう想定
    date =
      begin
        Date.parse(params[:date])
      rescue ArgumentError
        Time.zone.today.to_date
      end

    hour = params[:hour].to_i

    assigned_task_ids =
      TaskAssignment.where(profile_id: current_profile.id).select(:task_id)

    base_scope =
      Task.where(owner_profile_id: current_profile.id)
          .or(Task.where(id: assigned_task_ids))

    # その日のタスクだけざっくり絞る
    day_start = date.beginning_of_day.in_time_zone
    day_end   = date.end_of_day.in_time_zone

    tasks_for_day =
      base_scope
        .where(due_at: day_start..day_end)
        .includes(:team, :owner_profile, :assignees)

    # カレンダーと同じルール:
    # display_time = due_at - 1.hour の「時」が指定 hour と一致するもの
    @tasks_in_slot =
      tasks_for_day.select do |task|
        next false if task.due_at.blank?

        display_time = task.due_at - 1.hour
        display_time.hour == hour
      end

    @slot_date = date
    @slot_hour = hour

    # side-panel の turbo_frame に埋め込む想定なので layout なしでOK
    render layout: false
  end

  def show
  end

  def new
    tomorrow = 1.day.from_now.to_date

    @task = Task.new(
      status: :todo
    )

    @task.due_date = tomorrow
    @task.due_time = "23:30"

    @task.assignee_ids = [ current_profile.id ]
  end

  def create
    @task = Task.new(task_params)
    @task.owner_profile = current_profile
    @task.team          ||= current_profile.teams.first

    build_due_at_from_virtual_fields(@task)

    if @task.errors.any?
      set_collections
      render :new, status: :unprocessable_entity
      return
    end

    Task.transaction do
      if @task.save
        @task.update_tags_from_list!
      end
    end

    if @task.errors.empty?
      # ★ ここを変更
      redirect_to tasks_path, notice: "タスクを作成しました。"
    else
      set_collections
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    if @task.due_at.present?
      @task.due_date ||= @task.due_at.to_date
      @task.due_time ||= @task.due_at.strftime("%H:%M")
    end
  end

  def update
    @task.assign_attributes(task_params)

    # 期限系のフィールドが送られてきたときだけ due_at を組み立てる
    if task_params.key?(:due_date) || task_params.key?(:due_time)
      build_due_at_from_virtual_fields(@task)

      if @task.errors.any?
        set_collections
        render :edit, status: :unprocessable_entity
        return
      end
    end

    Task.transaction do
      if @task.save
        # tag_list が送られてきたときだけタグ再作成（一覧からの status 更新では呼ばれない）
        @task.update_tags_from_list! if task_params.key?(:tag_list)
      end
    end

    if @task.errors.empty?
      # ★ ここで分岐させる
      if turbo_frame_request?
        # ライトパネルからの更新 → そのままタスク詳細をライトパネルに表示
        redirect_to task_path(@task), notice: "タスクを更新しました。"
      else
        # 通常のページ（一覧など）からの更新 → 一覧へ戻る
        redirect_to tasks_path, notice: "タスクを更新しました。"
      end
    else
      set_collections
      render :edit, status: :unprocessable_entity
    end
  end


  def destroy
    if @task.team_id.present?
      unless current_profile.teams.exists?(id: @task.team_id)
        redirect_to tasks_path, alert: "このタスクを削除する権限がありません。"
        return
      end
    else
      unless @task.owner_profile_id == current_profile.id
        redirect_to tasks_path, alert: "このタスクを削除する権限がありません。"
        return
      end
    end

    @task.destroy

    respond_to do |format|
      format.html { redirect_to tasks_path, notice: "タスクを削除しました。" }
      format.turbo_stream # ← destroy.turbo_stream.erb を探す
    end
  end


  private

  def set_task
    @task = Task.find(params[:id])
  end

  def set_collections
    @teams = current_profile.teams.order(:name)

    @assignee_candidates =
      if @teams.any?
        Profile.joins(:team_memberships)
              .where(team_memberships: { team_id: @teams.ids })
              .distinct
              .order(:display_name, :label)
      else
        Profile.where(id: current_profile.id)
      end
  end

  def task_params
    params.require(:task).permit(
      :title,
      :description,
      :status,
      :due_date,
      :due_time,
      :tag_list,
      assignee_ids: []
    )
  end

  def build_due_at_from_virtual_fields(task)
    date_str = task.due_date.presence
    time_str = task.due_time.presence

    if date_str.blank? && time_str.blank?
      task.due_at = nil
      return
    end

    if date_str.blank? || time_str.blank?
      task.errors.add(:base, "期限日と時間は両方入力するか、両方空にしてください")
      return
    end

    unless time_str =~ /\A\d{1,2}:(00|30)\z/
      task.errors.add(:due_time, "は 30分単位で HH:MM 形式で入力してください（例: 09:00, 13:30）")
      return
    end

    begin
      task.due_at = Time.zone.parse("#{date_str} #{time_str}")
    rescue ArgumentError
      task.errors.add(:base, "期限の形式が正しくありません")
    end
  end

  def apply_filter(scope)
    case params[:filter]
    when "today"
      scope.where(due_at: Time.current.all_day)
    when "this_week"
      scope.where(
        due_at: Time.current.beginning_of_week..Time.current.end_of_week
      )
    when "incomplete"
      scope.where.not(status: Task.statuses[:done])
    when "done"
      scope.done
    else
      scope
    end
  end

  def setup_calendar(scope)
    # ▼ 基準日（?date=YYYY-MM-DD があればそれ、なければ今日）
    @base_date =
      begin
        params[:date].present? ? Date.parse(params[:date]) : Time.zone.today.to_date
      rescue ArgumentError
        Time.zone.today.to_date
      end

    # ▼ 週の開始・終了（ここでは月曜はじまり）
    @week_start = @base_date.beginning_of_week(:monday)
    @week_end   = @week_start + 6.days

    # ビューで使う配列
    @calendar_days = (@week_start..@week_end).to_a

    # ▼ 時間軸（とりあえず 8:00〜23:00）
    @hours = (8..23).to_a

    # ▼ この週に「期限がある」タスクだけ取得
    @tasks_for_calendar =
      scope
        .where(due_at: @week_start.beginning_of_day..@week_end.end_of_day)
        .includes(:team, :owner_profile, :assignees)

    # ▼ [日付][時間] => [タスク...] なハッシュ
    slots = {}
    @calendar_days.each do |date|
      slots[date] = {}
      @hours.each { |h| slots[date][h] = [] }
    end

    @tasks_for_calendar.each do |task|
      next unless task.due_at

      date = task.due_at.to_date
      hour = task.due_at.hour

      next unless slots[date] && slots[date][hour]

      slots[date][hour] << task
    end

    @calendar_slots = slots
  end

  def apply_column_filters(scope)
    rel = scope

    # タイトルフィルタ
    if params[:title_contains].present?
      rel = rel.where("tasks.title ILIKE ?", "%#{params[:title_contains]}%")
    end

    # 期限フィルタ（特定の日付だけを表示）
    if params[:due_on].present?
      begin
        date = Date.parse(params[:due_on])
        rel = rel.where(due_at: date.beginning_of_day..date.end_of_day)
      rescue ArgumentError
        # 不正な日付は無視（何もしない）
      end
    end

    # ステータスフィルタ（自由記入：todo / in / done など部分一致）
    if params[:status_keyword].present?
      keyword = params[:status_keyword].to_s

      matched_keys =
        Task.statuses.keys.select { |k| k.include?(keyword) }

      if matched_keys.any?
        rel = rel.where(status: Task.statuses.values_at(*matched_keys))
      else
        # 何もマッチしない → 結果0件
        rel = rel.none
      end
    end

    # 担当者フィルタ（display_name 部分一致）
    if params[:assignee_keyword].present?
      profile_ids =
        Profile.where("display_name ILIKE ?", "%#{params[:assignee_keyword]}%")
               .pluck(:id)

      if profile_ids.any?
        task_ids =
          TaskAssignment.where(profile_id: profile_ids).select(:task_id)
        rel = rel.where(id: task_ids)
      else
        rel = rel.none
      end
    end

    # 作成者フィルタ（display_name 部分一致）
    if params[:owner_keyword].present?
      profile_ids =
        Profile.where("display_name ILIKE ?", "%#{params[:owner_keyword]}%")
               .pluck(:id)

      if profile_ids.any?
        rel = rel.where(owner_profile_id: profile_ids)
      else
        rel = rel.none
      end
    end

    rel
  end

  # ソート条件を組み立てる
  def build_order_clause
    # どのカラムでソートするか（許可リスト）
    column =
    case params[:sort]
    when "title"
        "tasks.title"
    when "due_at"
        "tasks.due_at"
    when "status"
        "tasks.status"
    when "owner"
        # 作成者（owner_profile の display_name）
        "(SELECT display_name FROM profiles " \
          "WHERE profiles.id = tasks.owner_profile_id LIMIT 1)"
    when "assignee"
        # 担当者（複数いる場合は一番小さい名前で代表させる）
        "(SELECT MIN(p.display_name) FROM task_assignments ta " \
          "JOIN profiles p ON p.id = ta.profile_id " \
          "WHERE ta.task_id = tasks.id)"
    else
        "tasks.due_at"  # デフォルト
    end

    # 昇順 or 降順（パラメータが変な値なら ASC に倒す）
    direction = params[:direction] == "desc" ? "DESC" : "ASC"

    # ついでに created_at も第2キーにしておくと安定
    Arel.sql("#{column} #{direction}, tasks.created_at ASC")
  end
end


--- FILE: app/controllers/comments_controller.rb ---
# app/controllers/comments_controller.rb
class CommentsController < ApplicationController
  before_action :authenticate_user!
  before_action :require_current_profile!
  before_action :set_task
  before_action :set_comment, only: %i[edit update destroy]

  def create
    @comment = @task.comments.build(comment_params)
    @comment.author_profile = current_profile

    ActiveRecord::Base.transaction do
      @comment.save!
      apply_task_status_change
    end

    redirect_to task_path(@task), notice: "コメントを追加しました。"
  rescue ActiveRecord::RecordInvalid
    @comments = @task.comments.includes(:author_profile).order(:created_at)
    render "tasks/show", status: :unprocessable_entity
  end

  def edit
  end

  def update
    ActiveRecord::Base.transaction do
      @comment.update!(comment_params)
      apply_task_status_change
    end

    redirect_to task_path(@task), notice: "コメントを更新しました。"
  rescue ActiveRecord::RecordInvalid
    render :edit, status: :unprocessable_entity
  end

  def destroy
    @comment.destroy
    redirect_to task_path(@task), notice: "コメントを削除しました。"
  end

  private

  def set_task
    @task = Task.find(params[:task_id])
  end

  def set_comment
    @comment = @task.comments.find(params[:id])
  end

  def comment_params
    params.require(:comment).permit(:body, :pinned)
  end

  def apply_task_status_change
    new_status = params.dig(:comment, :task_status).presence
    return unless new_status

    @task.update!(status: new_status)
  end
end


--- FILE: app/controllers/profiles_controller.rb ---
# app/controllers/profiles_controller.rb
class ProfilesController < ApplicationController
  before_action :authenticate_user!
  before_action :set_profile, only: %i[show edit update destroy]

  skip_before_action :verify_authenticity_token, only: :switch

  def index
    @profiles = current_user.profiles.order(created_at: :asc)
  end

  def show
  end

  def new
    @profile = current_user.profiles.build
  end

  def create
    @profile = current_user.profiles.build(profile_params)
    if @profile.save
      redirect_to @profile, notice: "プロフィールを作成しました"
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @profile.update(profile_params)
      redirect_to @profile, notice: "プロフィールを更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def destroy
    if current_user.profiles.count <= 1
      redirect_to profiles_path, alert: "最後のプロフィールは削除できません"
    else
      @profile.destroy
      redirect_to profiles_path, notice: "プロフィールを削除しました"
    end
  end

  def switch
    profile = current_user.profiles.find(params[:profile_id])
    session[:current_profile_id] = profile.id
    redirect_back fallback_location: profiles_path
  end

  private

  def set_profile
    @profile = current_user.profiles.find(params[:id])
  end

  def profile_params
    params.require(:profile).permit(:label,
      :display_name,
      :theme,
      :avatar,
      :remove_avatar
    )
  end
end


--- FILE: app/controllers/team_settings_controller.rb ---
# app/controllers/team_settings_controller.rb
class TeamSettingsController < ApplicationController
  before_action :authenticate_user!
  before_action :require_current_profile!
  before_action :set_my_teams, only: [ :edit, :members ]

  def home
  end

  def edit
    # @teams は set_my_teams で
    # 「自分が所属しているチームだけ」に絞られています
  end

  def members
    @selected_team =
      if params[:team_id].present?
        @teams.find_by(id: params[:team_id])   # ← 自分のチームの中からだけ探す
      else
        @teams.first
      end

    if @selected_team
      @memberships = @selected_team.team_memberships.includes(:profile)
      @members      = @memberships.map(&:profile)

      # ✅ 今のプロフィールがこのチームでどんな membership を持っているか
      @current_membership =
        @memberships.find { |m| m.profile_id == current_profile.id }

      # ✅ この画面を見ている人が管理者かどうか
      @can_manage_members = @current_membership&.admin?

      # ▼ ここから：申請IDでプロフィール検索用 ▼
      @invite_token = params[:invite_token].to_s.strip.upcase

      @invite_profiles =
        if @invite_token.present?
          Profile.where(join_token: @invite_token)
                 .where.not(id: @members.map(&:id)) # すでにメンバーなら候補から除外
        else
          Profile.none
        end
      # ▲ ここまで ▼

    else
      @memberships        = []
      @members            = []
      @invite_token       = nil
      @invite_profiles    = Profile.none
      @current_membership = nil
      @can_manage_members = false
    end

    @incoming_join_requests =
      if @selected_team
        MembershipRequest
          .where(team: @selected_team, direction: "profile_to_team", status: "pending")
          .includes(:requester_profile)
      else
        MembershipRequest.none
      end
  end

  # プロフィールが選択されていないユーザーはチーム設定を見せない
  def require_current_profile!
    return if current_profile

    redirect_to profiles_path,
                alert: "チーム設定を利用するにはプロフィールを選択してください。"
  end

  # 「自分が所属しているチーム」だけを取得
  def set_my_teams
    @teams = current_profile.teams.order(:name)
  end
end


--- FILE: app/controllers/team_memberships_controller.rb ---
# app/controllers/team_memberships_controller.rb
class TeamMembershipsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_team_membership, only: [ :destroy, :update ]
  before_action :require_team_admin!, only: [ :destroy, :update ]

  def create
    team    = Team.find(params[:team_id])
    profile = Profile.find(params[:profile_id])

    membership = TeamMembership.new(
      team: team,
      profile: profile,
      role: params[:role].presence # 入力なければ nil のまま
    )

    if membership.save
      redirect_back fallback_location: manage_team_path(team),
                    notice: "メンバーを追加しました"
    else
      redirect_back fallback_location: manage_team_path(team),
                   alert: "メンバーを追加できませんでした"
    end
  end

  # ★ 追加：役割変更
  def update
    team = @team_membership.team

    # selectから来る値（"admin" or ""）を受け取る
    new_role = params.require(:team_membership)[:role].presence

    if @team_membership.update(role: new_role)
      redirect_back fallback_location: manage_team_path(team),
                    notice: "メンバーの役割を更新しました"
    else
      redirect_back fallback_location: manage_team_path(team),
                    alert:  "役割を更新できませんでした"
    end
  end

  def destroy
    team = @team_membership.team
    @team_membership.destroy

    redirect_back fallback_location: manage_team_path(team),
                  notice: "メンバーを削除しました"
  end

  private

  def set_team_membership
    @team_membership = TeamMembership.find(params[:id])
  end

  # このチームの「管理者」だけが destroy / update できる
  def require_team_admin!
    team = @team_membership.team

    admin_membership = team.team_memberships.find_by(
      profile: current_profile,
      role: TeamMembership::ADMIN_ROLE
    )

    return if admin_membership

    redirect_to root_path,
                alert: "このチームのメンバー管理を行う権限がありません"
  end
end


--- FILE: app/controllers/users/passwords_controller.rb ---
# app/controllers/users/passwords_controller.rb
class Users::PasswordsController < Devise::PasswordsController
  skip_before_action :authenticate_user!, only: %i[new create edit update]
  before_action :sign_out_if_signed_in, only: %i[edit update]

  def create
    email = resource_params[:email].to_s.downcase.strip
    deliver_emails = ENV.fetch("DELIVER_EMAILS", "false") == "true"

    is_new_demo_creation = false

    # 提出モードの場合、許可リストを作成
    unless deliver_emails
      allowed_demo_emails = []
      allowed_demo_emails << ENV.fetch("DEMO_EMAIL", "demo@example.com").to_s.downcase
      # 2つ目のデモメールが環境変数に設定されていれば追加
      if ENV["DEMO_EMAIL_2"].present?
        allowed_demo_emails << ENV["DEMO_EMAIL_2"].to_s.downcase
      end
      allowed_demo_emails.compact!

      # 許可リストに含まれていなければ、スパム登録を防ぐためにリダイレクト
      unless allowed_demo_emails.include?(email)
        return redirect_to new_user_session_path, alert: "提出モードでは指定されたデモメールのみ使用できます。"
      end
    end

    user = User.find_by(email: email)

    if user.nil?
      is_new_demo_creation = true
      password =
        if deliver_emails
          Devise.friendly_token.first(20)
        else
          ENV.fetch("DEMO_PASSWORD", "password")
        end

      user = User.new(email: email, password: password, password_confirmation: password)

      # 提出モードは確認済みにしてログインできるようにする
      user.confirmed_at = Time.current unless deliver_emails

      unless user.save
        return redirect_to new_user_session_path, alert: user.errors.full_messages.first
      end

      # ★★★ 新しいユーザー作成時のプロフィール作成ロジックのみ実行 ★★★

      # 1. プロファイルを作成
      new_profile_label = email.split("@").first
      user.profiles.create!(
        display_name: new_profile_label.capitalize,
        label: new_profile_label,
        theme: "default"
      )

      # ★★★ チーム参加ロジックは削除 ★★★
    end

    if deliver_emails
      user.send_reset_password_instructions
      notice = "メールを送信しました。メールを確認し、リンクからパスワード設定（再設定）を完了してください。"
    else
      # ユーザーが今作成されたばかりの場合、その情報を通知
      if is_new_demo_creation
        notice = "テストユーザー**「#{email}」**を作成しました。パスワードは**「#{ENV.fetch("DEMO_PASSWORD", "password")}」**でログインしてください。"
      else
        # 既存のデモアカウントの場合
        notice = "デモアカウントを作成しました。画面上のデモID/パスワードでログインしてください。"
      end
    end

    redirect_to new_user_session_path, notice: notice
  end

  private

  def sign_out_if_signed_in
    sign_out(current_user) if user_signed_in?
  end
end


--- FILE: app/controllers/users/confirmations_controller.rb ---
# app/controllers/users/confirmations_controller.rb
class Users::ConfirmationsController < Devise::ConfirmationsController
  def create
    token = params[:confirmation_token].to_s

    # ✅ あなたの “メール変更確定” フロー
    if token.present?
      self.resource = resource_class.confirm_by_token(token)

      if resource.errors.empty?
        redirect_to edit_user_registration_path, notice: "メールアドレスを確定しました。"
      else
        redirect_to edit_user_registration_path, alert: resource.errors.full_messages.first
      end
      return
    end

    # ✅ Devise本来の “確認メール再送”
    super
  end
end


--- FILE: app/controllers/membership_requests_controller.rb ---
# app/controllers/membership_requests_controller.rb
class MembershipRequestsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_membership_request, only: [ :approve ]

  def create
    direction = params[:direction]

    case direction
    when "team_to_profile"
      create_team_to_profile_request

    when "profile_to_team"
      team = Team.find(params[:team_id])

      # すでにメンバーなら申請不要
      if team.profiles.exists?(id: current_profile.id)
        redirect_back fallback_location: edit_profile_path(current_profile),
                      alert: "すでにこのチームのメンバーです"
        return
      end

      req = MembershipRequest.new(
        direction: "profile_to_team",
        team: team,
        requester_profile: current_profile,
        status: :pending
      )

      if req.save
        redirect_back fallback_location: edit_profile_path(current_profile),
                      notice: "参加申請を送信しました。"
      else
        redirect_back fallback_location: edit_profile_path(current_profile),
                      alert: req.errors.full_messages.first
      end

    else
      redirect_back fallback_location: root_path, alert: "不正なリクエストです。"
    end
  end

  def approve
    req = @membership_request

    case req.direction
    when "team_to_profile"
      unless req.pending? && req.target_profile_id == current_profile&.id
        redirect_back fallback_location: edit_profile_path(current_profile),
                      alert: "この招待は承認できません"
        return
      end

      TeamMembership.transaction do
        role_value = req.admin? ? TeamMembership::ADMIN_ROLE : nil

        TeamMembership.find_or_create_by!(team: req.team, profile: current_profile) do |m|
          m.role = role_value
        end

        if role_value.present?
          membership = TeamMembership.find_by!(team: req.team, profile: current_profile)
          membership.update!(role: TeamMembership::ADMIN_ROLE) unless membership.admin?
        end

        req.update!(status: :approved)
      end

      redirect_back fallback_location: edit_profile_path(current_profile),
                    notice: "チーム招待を承認しました。"

    when "profile_to_team"
      team    = req.team
      profile = req.requester_profile

      admin_membership =
        team.team_memberships.find_by(profile: current_profile, role: TeamMembership::ADMIN_ROLE)

      unless admin_membership
        redirect_back fallback_location: manage_team_path(team),
                      alert: "このチームの申請を承認する権限がありません"
        return
      end

      TeamMembership.transaction do
        TeamMembership.find_or_create_by!(team: team, profile: profile)
        req.update!(status: :approved)
      end

      redirect_back fallback_location: manage_team_path(team),
                    notice: "参加申請を承認しました。"

    else
      redirect_back fallback_location: root_path, alert: "不正なリクエストです。"
    end
  end

  private

  def set_membership_request
    @membership_request = MembershipRequest.find(params[:id])
  end

  def create_team_to_profile_request
    team = Team.find(params[:team_id])
    target_profile = Profile.find(params[:target_profile_id])

    requester_profile = current_profile
    unless requester_profile
      redirect_back fallback_location: manage_team_path(team),
                    alert: "現在のプロフィールが選択されていません"
      return
    end

    # 管理者だけ招待できる
    admin_membership =
      team.team_memberships.find_by(profile: requester_profile, role: TeamMembership::ADMIN_ROLE)

    unless admin_membership
      redirect_back fallback_location: manage_team_path(team),
                    alert: "このチームの招待を送る権限がありません"
      return
    end

    # すでにメンバーなら招待不要（任意だけど親切）
    if team.profiles.exists?(id: target_profile.id)
      redirect_back fallback_location: manage_team_path(team),
                    alert: "このプロフィールはすでにチームメンバーです"
      return
    end

    membership_request = MembershipRequest.new(
      requester_profile: requester_profile,
      target_profile: target_profile,
      team: team,
      direction: :team_to_profile,
      status: :pending,
      admin: params[:admin] == "1"
    )

    if membership_request.save
      redirect_back fallback_location: manage_team_path(team),
                    notice: "招待を送信しました"
    else
      redirect_back fallback_location: manage_team_path(team),
                    alert: membership_request.errors.full_messages.first
    end
  end
end


--- FILE: app/views/comments/edit.html.erb ---
<!-- app/views/comments/edit.html.erb -->
<h1 class="text-sm font-semibold mb-3">コメント編集</h1>

<%= render "form", task: @task, comment: @comment %>

--- FILE: app/views/comments/_comment.html.erb ---
<!-- app/views/comments/_comment.html.erb -->
<% profile = comment.author_profile %>

<div class="py-2 border-b border-gray-100">
  <!-- 1行目：チップ + 日付 -->
  <div class="flex items-center justify-between text-[11px] text-gray-500">
    <%= profile_chip(
          profile,
          size: :xs,
          wrapper_class: "text-xs text-gray-700 font-semibold"
        ) %>

    <span><%= l comment.created_at, format: :ja_short %></span>
  </div>

  <!-- 2行目：本文（左）＋ PINバッジ＆ハート（右） -->
  <div class="mt-1 flex items-start justify-between gap-2">
    <!-- 本文（左側） -->
    <div class="flex-1 pl-6 text-sm">
      <%= simple_format(
            h(comment.body),
            {},               # pタグのクラスを追加したければここに
            wrapper_tag: "p"
          ) %>
    </div>

    <!-- 右側：PINバッジ + ハート（横並びで右寄せ） -->
    <div class="flex items-center gap-1 text-[11px] text-gray-500 pr-1">
      <% if comment.pinned? %>
        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-yellow-50 text-[10px] text-yellow-700 border border-yellow-200">
          PIN
        </span>
      <% end %>

      <% heart_reactions = comment.heart_reactions.includes(:profile) %>
      <% liked_by_current = heart_reactions.any? { |r| r.profile_id == current_profile.id } %>
      <% count = heart_reactions.size %>

      <%= button_to(
            task_comment_reactions_path(comment.task, comment),
            method: :post,
            class: "inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-[11px] " \
                   "hover:bg-pink-50 " \
                   "#{liked_by_current ? 'bg-pink-50 border-pink-300 text-pink-700' : 'bg-white border-gray-300 text-gray-500'}"
          ) do %>
        <span><%= liked_by_current ? "♥" : "♡" %></span>
        <% if count.positive? %>
          <span><%= count %></span>
        <% end %>
      <% end %>
    </div>
  </div>
</div>



--- FILE: app/views/comments/_form.html.erb ---
<!-- app/views/comments/_form.html.erb -->
<%= form_with model: [@task, comment], local: true do |f| %>
  <% if comment.errors.any? %>
    <div class="mb-2 p-2 bg-red-50 text-red-700 rounded text-xs">
      <p class="font-semibold"><%= comment.errors.count %>件のエラーがあります。</p>
      <ul class="list-disc list-inside">
        <% comment.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-2">
    <%= f.text_area :body,
                    rows: 3,
                    class: "w-full border rounded px-2 py-1 text-sm",
                    placeholder: "コメントを入力..." %>
  </div>

  <!-- ★ ピン留め + ステータス変更 -->
  <div class="mb-2 flex flex-wrap items-center gap-4 text-[11px] text-gray-600">
    <!-- ピン留め -->
    <label class="inline-flex items-center gap-1">
      <%= f.check_box :pinned %>
      <span>このコメントをピン留めする</span>
    </label>
  </div>

  <div class="flex justify-end">
    <%= f.submit "コメント送信",
                 class: "px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700" %>
  </div>
<% end %>


--- FILE: app/views/devise/unlocks/new.html.erb ---
<h2>Resend unlock instructions</h2>

<%= form_for(resource, as: resource_name, url: unlock_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <div class="actions">
    <%= f.submit "Resend unlock instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>


--- FILE: app/views/devise/passwords/edit.html.erb ---
<!-- app/views/devise/passwords/edit.html.erb -->
<div class="min-h-screen flex items-center justify-center bg-white px-4">
  <div class="w-full max-w-md">
    <!-- ロゴ -->
    <div class="flex flex-col items-center text-center mb-8">
      <%= image_tag "forestly_logo.png",
                    alt: "forestly",
                    class: "block",
                    style: "height: 128px; width: auto;" %>
      <p class="mt-0 text-sm text-gray-600">
        多様なあなたのTaskアプリ
      </p>
    </div>

    <% if flash[:alert].present? %>
      <div class="mb-4 rounded border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <% if flash[:notice].present? %>
      <div class="mb-4 rounded border border-green-200 bg-green-50 px-3 py-2 text-sm text-green-800">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- タイトル -->
    <h1 class="text-lg font-semibold text-center mb-4">
      パスワードを設定（再設定）
    </h1>

    <p class="text-sm text-gray-600 text-center mb-6">
      新しいパスワードを入力してください。
    </p>

    <%= form_for(resource,
                 as: resource_name,
                 url: user_password_path,
                 html: { method: :put, data: { turbo: false } }) do |f| %>

      <!-- reset token は必須 -->
      <%= f.hidden_field :reset_password_token %>

      <% if resource.errors.any? %>
        <div class="mb-4 rounded border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
          <ul class="list-disc list-inside">
            <% resource.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="space-y-3">
        <div class="flex items-center gap-3">
          <%= f.label :password, "パスワード", class: "w-28 text-sm text-gray-700" %>
          <%= f.password_field :password,
                               autocomplete: "new-password",
                               class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <div class="flex items-center gap-3">
          <%= f.label :password_confirmation, "パスワード再入力", class: "w-28 text-sm text-gray-700" %>
          <%= f.password_field :password_confirmation,
                               autocomplete: "new-password",
                               class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <div class="pt-2">
          <%= f.submit "確定する",
                      class: "w-full px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" %>
        </div>
      </div>
    <% end %>

    <div class="mt-6 text-center text-sm">
      <%= link_to "ログインへ戻る", new_user_session_path, class: "text-gray-600 underline" %>
    </div>
  </div>
</div>


--- FILE: app/views/devise/passwords/new.html.erb ---
<h2>Forgot your password?</h2>

<%= form_for(resource, as: resource_name, url: password_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <div class="actions">
    <%= f.submit "Send me reset password instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>


--- FILE: app/views/devise/mailer/confirmation_instructions.html.erb ---
<!-- app/views/devise/mailer/confirmation_instructions.html.erb -->
<p>Forestly</p>
<p>メールアドレス変更の確認です。</p>
<p>以下のリンクを開いて、メールアドレスの変更を確定してください。</p>

<p>
  <%= link_to "メールアドレス変更を進める", user_confirmation_url(confirmation_token: @token) %>
</p>


--- FILE: app/views/devise/mailer/reset_password_instructions.html.erb ---
<p>Forestly</p>
<p>パスワード変更のご案内です。</p>

<p>
  以下のリンクを開いて、新しいパスワードを設定してください。
</p>

<p>
  <%= link_to "パスワード変更を進める",
              edit_user_password_url(reset_password_token: @token) %>
</p>


--- FILE: app/views/devise/mailer/password_change.html.erb ---
<p>Hello <%= @resource.email %>!</p>

<p>We're contacting you to notify you that your password has been changed.</p>


--- FILE: app/views/devise/mailer/email_changed.html.erb ---
<p>Hello <%= @email %>!</p>

<% if @resource.try(:unconfirmed_email?) %>
  <p>We're contacting you to notify you that your email is being changed to <%= @resource.unconfirmed_email %>.</p>
<% else %>
  <p>We're contacting you to notify you that your email has been changed to <%= @resource.email %>.</p>
<% end %>


--- FILE: app/views/devise/mailer/unlock_instructions.html.erb ---
<p>Hello <%= @resource.email %>!</p>

<p>Your account has been locked due to an excessive number of unsuccessful sign in attempts.</p>

<p>Click the link below to unlock your account:</p>

<p><%= link_to 'Unlock my account', unlock_url(@resource, unlock_token: @token) %></p>


--- FILE: app/views/devise/shared/_error_messages.html.erb ---
<% if resource.errors.any? %>
  <div id="error_explanation" data-turbo-cache="false">
    <h2>
      <%= I18n.t("errors.messages.not_saved",
                 count: resource.errors.count,
                 resource: resource.class.model_name.human.downcase)
       %>
    </h2>
    <ul>
      <% resource.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>


--- FILE: app/views/devise/shared/_links.html.erb ---
<%- if controller_name != 'sessions' %>
  <%= link_to "Log in", new_session_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.registerable? && controller_name != 'registrations' %>
  <%= link_to "Sign up", new_registration_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.recoverable? && controller_name != 'passwords' && controller_name != 'registrations' %>
  <%= link_to "Forgot your password?", new_password_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.confirmable? && controller_name != 'confirmations' %>
  <%= link_to "Didn't receive confirmation instructions?", new_confirmation_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.lockable? && resource_class.unlock_strategy_enabled?(:email) && controller_name != 'unlocks' %>
  <%= link_to "Didn't receive unlock instructions?", new_unlock_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.omniauthable? %>
  <%- resource_class.omniauth_providers.each do |provider| %>
    <%= button_to "Sign in with #{OmniAuth::Utils.camelize(provider)}", omniauth_authorize_path(resource_name, provider), data: { turbo: false } %><br />
  <% end %>
<% end %>


--- FILE: app/views/devise/sessions/new.html.erb ---
<!-- app/views/devise/sessions/new.html.erb -->
<div class="min-h-screen flex items-center justify-center bg-white px-4">
  <div class="w-full max-w-md">
    <!-- ロゴ -->
    <div class="flex flex-col items-center text-center mb-8">
      <%= image_tag "forestly_logo.png",
                    alt: "forestly",
                    class: "block",
                    style: "height: 128px; width: auto;" %>
      <p class="mt-0 text-sm text-gray-600">
        多様なあなたのTaskアプリ
      </p>
    </div>

    <% if flash[:alert].present? %>
      <div class="mb-4 rounded border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
        <%= flash[:alert] %>
      </div>
    <% end %>

    <% if flash[:notice].present? %>
      <div class="mb-4 rounded border border-green-200 bg-green-50 px-3 py-2 text-sm text-green-800">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- ログイン -->
    <h1 class="text-lg font-semibold text-center mb-4">ログイン</h1>
    <% if submit_mode? %>
      <div class="mb-4 rounded border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
        <p class="font-semibold">【提出モード】デモアカウント</p>
        <p class="mt-1">
          Email (A):
          <code class="px-1 py-0.5 bg-white/60 rounded select-all"><%= ENV.fetch("DEMO_EMAIL", "demo@example.com") %></code>
          <br>
          Email (B):
          <code class="px-1 py-0.5 bg-white/60 rounded select-all"><%= ENV.fetch("DEMO_EMAIL_2", "demo2@example.com") %></code>
          <br>
          Password (共通):
          <code class="px-1 py-0.5 bg-white/60 rounded select-all"><%= ENV.fetch("DEMO_PASSWORD", "password") %></code>
        </p>
        <p class="mt-2 text-xs text-amber-800">
          ※メール送信は無効です。ログイン後にMVP機能をご確認ください。
        </p>
      </div>
    <% end %>

    <%= form_for(resource,
             as: resource_name,
             url: session_path(resource_name),
             html: { data: { turbo: false } }) do |f| %>
      <div class="space-y-3">
        <!-- Email 横並び -->
        <div class="flex items-center gap-3">
          <%= f.label :email, "メール", class: "w-28 text-sm text-gray-700" %>
          <%= f.email_field :email,
                            autofocus: true,
                            autocomplete: "email",
                            placeholder: "email@domain.com",
                            class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <!-- Password 横並び -->
        <div class="flex items-center gap-3">
          <%= f.label :password, "パスワード", class: "w-28 text-sm text-gray-700" %>
          <%= f.password_field :password,
                               autocomplete: "current-password",
                               class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <!-- ログインボタン -->
        <div class="pt-2">
          <%= f.submit "ログイン",
                       class: "w-full px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" %>
        </div>
      </div>
    <% end %>

    <!-- 区切り -->
    <div class="my-8 flex items-center gap-3">
      <div class="h-px flex-1 bg-gray-200"></div>
      <div class="text-xs text-gray-500 whitespace-nowrap">新規ユーザー登録</div>
      <div class="h-px flex-1 bg-gray-200"></div>
    </div>

    <!-- 登録用メール送信（パスワード設定メールを送る） -->
    <%= form_for(resource_class.new,
                as: resource_name,
                url: user_password_path,   # ←ここが重要
                method: :post,
                html: { data: { turbo: false } }) do |f| %>
      <div class="space-y-3">
        <div class="flex items-center gap-3">
          <%= f.label :email, "メール", class: "w-28 text-sm text-gray-700" %>
          <%= f.email_field :email,
                            autocomplete: "email",
                            placeholder: "email@domain.com",
                            class: "flex-1 border border-gray-200 rounded px-3 py-2 text-sm" %>
        </div>

        <div class="pt-2">
          <%= f.submit "登録用メールの送信",
                      class: "w-full px-4 py-2 bg-gray-900 text-white text-sm rounded hover:bg-gray-800" %>
        </div>
      </div>
    <% end %>

    <%# <p class="mt-6 text-[11px] text-gray-500 text-center leading-relaxed">
      続行することで、利用規約とプライバシーポリシーに同意したことになります。
    </p> %>
  </div>
</div>

--- FILE: app/views/devise/confirmations/new.html.erb ---
<h2>Resend confirmation instructions</h2>

<%= form_for(resource, as: resource_name, url: confirmation_path(resource_name), html: { method: :post }) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email", value: (resource.pending_reconfirmation? ? resource.unconfirmed_email : resource.email) %>
  </div>

  <div class="actions">
    <%= f.submit "Resend confirmation instructions" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>


--- FILE: app/views/devise/registrations/edit.html.erb ---
<!-- app/views/devise/registrations/edit.erb -->
<% if user_signed_in? && current_user.profiles.any? %>
  <% content_for :sidebar do %>
    <%= render "profiles/sidebar" %>
  <% end %>
<% end %>

<h1 class="text-xl font-bold mb-6">アカウント設定</h1>

<!-- 1) 現在のメール -->
<div class="mb-8 p-4 rounded">
  <h2 class="font-semibold mb-2">現在のメールアドレス</h2>
  <p class="text-sm text-gray-700"><%= current_user.email %></p>

  <% if current_user.respond_to?(:unconfirmed_email) && current_user.unconfirmed_email.present? %>
    <p class="text-xs text-amber-700 mt-2">
      変更申請中： <%= current_user.unconfirmed_email %>（確認待ち）
    </p>
  <% end %>
</div>

<!-- 2) メール変更申請（新しいメールに確認メールを送る） -->
<div class="mb-8 p-4 rounded" id="email">
  <h2 class="font-semibold mb-2">メールアドレスの変更</h2>

  <%= form_with url: send_change_email_path, method: :post, local: true do |f| %>
    <div class="mb-3">
      <%= label_tag :email, "新しいメールアドレス", class: "block text-sm mb-1" %>
      <%= email_field_tag :email, "", class: "w-full border border-gray-300 rounded px-3 py-2" %>
    </div>

    <%= submit_tag "新しいメールアドレスに変更用メールを送信する",
                   class: "px-4 py-2 rounded bg-blue-600 text-white" %>
  <% end %>
</div>

<!-- 3) パスワード変更メール送信（リセットメール） -->
<div class="p-4 rounded" id="password">
  <h2 class="font-semibold mb-2">パスワードの変更</h2>

  <%= button_to "パスワードの変更用メールを送信する",
                send_password_reset_path,
                method: :post,
                class: "px-4 py-2 rounded bg-blue-600 text-white" %>
</div>

--- FILE: app/views/devise/registrations/new.html.erb ---
<h2>Sign up</h2>

<%= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f| %>
  <%= render "devise/shared/error_messages", resource: resource %>

  <div class="field">
    <%= f.label :email %><br />
    <%= f.email_field :email, autofocus: true, autocomplete: "email" %>
  </div>

  <div class="field">
    <%= f.label :password %>
    <% if @minimum_password_length %>
    <em>(<%= @minimum_password_length %> characters minimum)</em>
    <% end %><br />
    <%= f.password_field :password, autocomplete: "new-password" %>
  </div>

  <div class="field">
    <%= f.label :password_confirmation %><br />
    <%= f.password_field :password_confirmation, autocomplete: "new-password" %>
  </div>

  <div class="actions">
    <%= f.submit "Sign up" %>
  </div>
<% end %>

<%= render "devise/shared/links" %>


--- FILE: app/views/tasks/index.html.erb ---
<!-- app/views/tasks/index.html.erb -->
<% content_for :sidebar do %>
  <%= render "tasks/sidebar" %>
<% end %>

<div>
  <!-- ▼ 総合検索フォーム -->
  <div class="mb-1">
    <%= form_with url: tasks_path, method: :get, local: true,
                  class: "flex items-center gap-2 max-w-xl" do %>

      <!-- 今のクイックフィルタを維持 -->
      <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>

      <!-- all_profiles も維持 -->
      <%= hidden_field_tag :all_profiles, params[:all_profiles] if params[:all_profiles].present? %>

      <%= text_field_tag :q,
                        @query,
                        class: "flex-1 border border-gray-300 rounded px-3 py-1 text-sm",
                        placeholder: "タイトル・詳細・タグで検索（スペース区切りでAND検索）" %>

      <%= submit_tag "検索",
                    class: "px-3 py-1 bg-gray-800 text-white text-sm rounded hover:bg-gray-900" %>

      <% if @query.present? %>
        <%= link_to "クリア",
                    tasks_path(
                      filter:      params[:filter],
                      all_profiles: params[:all_profiles]  # ★ ここでモード維持
                    ),
                    class: "text-xs text-gray-500 underline ml-2" %>
      <% end %>
    <% end %>
  </div>

  <!-- ▼ カラムごとのフィルタ -->
  <div class="mb-1">
    <%= form_with url: tasks_path, method: :get, local: true do %>
      <%# 総合検索とクイックフィルタは維持 %>
      <%= hidden_field_tag :q, @query if @query.present? %>
      <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>
      <%= hidden_field_tag :all_profiles, params[:all_profiles] if params[:all_profiles].present? %>

      <table class="w-full text-xs">
        <tbody>
          <tr>
            <!-- タイトル -->
            <td class="py-1 px-2">
              <%= text_field_tag :title_contains,
                                 params[:title_contains],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: "部分一致" %>
            </td>

            <!-- 期限（自由入力でもいいですが、UX的に date_field_tag おすすめ） -->
            <td class="py-1 px-2">
              <%= date_field_tag :due_on,
                                 params[:due_on],
                                 class: "w-full border border-gray-300 rounded px-2 py-1" %>
            </td>

            <!-- ステータス（todo / in / done など） -->
            <td class="py-1 px-2">
              <%= text_field_tag :status_keyword,
                                 params[:status_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: "todo / prog / done" %>
            </td>

            <!-- 担当者 -->
            <td class="py-1 px-2">
              <%= text_field_tag :assignee_keyword,
                                 params[:assignee_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: "担当者名の一部" %>
            </td>

            <!-- 作成者 -->
            <td class="py-1 px-2">
              <%= text_field_tag :owner_keyword,
                                 params[:owner_keyword],
                                 class: "w-full border border-gray-300 rounded px-2 py-1",
                                 placeholder: "作成者名の一部" %>
            </td>

            <!-- 右端：ボタン -->
            <td class="py-1 px-2">
              <div class="flex justify-end gap-2">
                <%= submit_tag "フィルタ適用",
                               class: "px-3 py-1 bg-gray-100 text-gray-700 text-xs rounded border border-gray-300 hover:bg-gray-200" %>

                <%= link_to "フィルタクリア",
                            tasks_path(
                              q:           @query,
                              filter:      params[:filter],
                              all_profiles: params[:all_profiles]
                            ),
                            class: "px-3 py-1 text-xs text-gray-500 underline" %>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    <% end %>
  </div>


<% if @tasks.any? %>
  <div class="overflow-y-auto max-h-[calc(100vh-260px)]">
    <table class="w-full text-sm">
      <thead class="sticky top-0 bg-gray-50 z-10">
        <tr class="border-b">
          <th class="text-left py-2 px-2">
            <%= sort_link("タイトル", "title") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link("期限", "due_at") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link("ステータス", "status") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link("担当者", "assignee") %>
          </th>
          <th class="text-left py-2 px-2">
            <%= sort_link("作成者", "owner") %>
          </th>
          <th class="text-left py-2 px-2"></th>
        </tr>
      </thead>

      <!-- ★ ここに id を付ける -->
      <tbody id="tasks-table-body">
        <% @tasks.each do |task| %>
          <tr id="<%= dom_id(task) %>" class="border-gray-50">
            <!-- Taskのタイトル -->
            <td class="py-2 px-2">
              <%= link_to task.title,
                          task_path(task),
                          class: "font-semibold text-gray-600 underline",
                          data: {
                            turbo_frame: "side-panel-frame",
                            action: "click->side-panel#open",
                            side_panel_title_param: "タスクの詳細"
                          } %>
            </td>

            <!-- Taskの期限 -->
            <td class="py-2 px-2">
              <%= due_badge(task) %>
            </td>

            <!-- Taskのステータス -->
            <td class="py-2 px-2">
              <div class="mb-1">
                <%= status_badge(task) %>
              </div>
            </td>

            <!-- Taskの担当者 -->
            <td class="py-2">
              <% if task.assignees.any? %>
                <% task.assignees.each do |profile| %>
                  <%= profile_chip(
                        profile,
                        size: :xs,
                        wrapper_class: "px-2 py-1 mr-1 mb-1 rounded bg-gray-100 text-xs font-semibold"
                      ) %>
                <% end %>
              <% else %>
                <span class="text-xs text-gray-400">未設定</span>
              <% end %>
            </td>

            <!-- Taskの作成者 -->
            <td class="py-2 px-2">
              <% if task.owner_profile %>
                <%= profile_chip(
                      task.owner_profile,
                      size: :xs,
                      wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                    ) %>
              <% else %>
                <span class="text-xs text-gray-400">不明</span>
              <% end %>
            </td>

            <!-- Taskのステータス変更 + 編集・削除 -->
            <td class="py-2 px-2 text-right">
              <div class="flex items-center justify-end gap-2">
                <!-- ステータス変更プルダウン -->
                <%= form_with model: task,
                              url: task_path(task),
                              method: :patch,
                              local: true do |f| %>
                  <%= f.select :status,
                               Task.statuses.keys.map { |k| [k, k] },
                               {},
                               class: "border border-gray-300 rounded px-2 py-1 text-xs",
                               onchange: "this.form.submit();" %>
                <% end %>

                <!-- 編集ボタン -->
                <%= link_to "編集",
                            edit_task_path(task),
                            class: "text-xs text-gray-600 underline",
                            data: {
                              turbo_frame: "side-panel-frame",
                              action: "click->side-panel#open",
                              side_panel_title_param: "タスク編集"
                            } %>

                <!-- 削除ボタン -->
                <%= button_to "削除",
                            task_path(task),
                            method: :delete,
                            form: { data: { turbo_confirm: "このタスクを削除しますか？", turbo_stream: true } },
                            class: "text-xs text-red-600 underline" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <!-- ▼ もっと見る（次のページへ） -->
  <% if @tasks.next_page.present? %>
    <div id="load-more-tasks" class="mt-2 flex justify-center">
      <%= link_to "もっと見る",
                  tasks_path(
                    request.query_parameters.merge(
                      page:   @tasks.next_page,
                      format: :turbo_stream
                    )
                  ),
                  class: "px-4 py-2 text-xs bg-gray-100 border border-gray-300 rounded hover:bg-gray-200" %>
    </div>
  <% end %>
  </div>



<% else %>
  <p class="text-sm text-gray-500">
    まだタスクがありません。「新規タスク作成」から追加してください。
  </p>
<% end %>
</div>


--- FILE: app/views/tasks/slot_tasks.html.erb ---
<!-- app/views/tasks/slot_tasks.html.erb -->
<turbo-frame id="side-panel-frame">
  <div class="space-y-3 text-sm">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-xs text-gray-500">
          <%= @slot_date.strftime("%Y/%m/%d") %>
          <%= "%02d:00" % @slot_hour %> のタスク
        </div>
        <div class="text-lg font-semibold text-gray-800">
          この時間帯のタスク一覧
        </div>
      </div>
    </div>

    <% if @tasks_in_slot.any? %>
      <ul class="space-y-2">
        <% @tasks_in_slot.each do |task| %>
          <li class="border border-gray-300 rounded px-3 py-2 hover:bg-gray-50">
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="font-semibold text-gray-800 truncate">
                  <%= task.title %>
                </div>
                <div class="text-[11px] text-gray-500 mt-0.5">
                  期限:
                  <% if task.due_at %>
                    <%= task.due_at.strftime("%m/%d %H:%M") %>
                  <% else %>
                    未設定
                  <% end %>
                </div>
                <div class="text-[11px] text-gray-500 mt-0.5 flex flex-wrap gap-1">
                  <% if task.assignees.any? %>
                    <% task.assignees.each do |profile| %>
                      <%= profile_chip(
                            profile,
                            size: :xs,
                            wrapper_class: "px-1 py-0.5 rounded bg-gray-100 text-[11px]"
                          ) %>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400">担当: 未設定</span>
                  <% end %>
                </div>
              </div>

              <div class="flex flex-col items-end gap-1">
                <%= status_badge(task) %>

                <%= link_to "詳細を見る",
                            task_path(task),
                            class: "text-[11px] text-blue-600 underline",
                            data: {
                              turbo_frame: "side-panel-frame",
                              action: "click->side-panel#open",
                              side_panel_title_param: "タスク詳細"
                            } %>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-xs text-gray-500">
        この時間帯のタスクはありません。
      </p>
    <% end %>
  </div>
</turbo-frame>


--- FILE: app/views/tasks/calendar.html.erb ---
<!-- app/views/tasks/calendar.html.erb -->
<% content_for :sidebar do %>
  <%= render "tasks/sidebar" %>
<% end %>

<div>
  <!-- 週移動ナビ -->
  <div class="flex items-center gap-2 text-xs text-gray-600 mb-3">
    <%= link_to "＜ 前の週",
                tasks_path(view: :calendar, date: (@week_start - 7.days).to_s),
                class: "px-2 py-1 rounded border border-gray-300 hover:bg-gray-50" %>

    <span>
      <%= @week_start.strftime("%Y/%m/%d") %> 〜 <%= @week_end.strftime("%Y/%m/%d") %>
    </span>

    <%= link_to "次の週 ＞",
                tasks_path(view: :calendar, date: (@week_start + 7.days).to_s),
                class: "px-2 py-1 rounded border border-gray-300 hover:bg-gray-50" %>

    <%= link_to "今日",
                tasks_path(view: :calendar),
                class: "px-2 py-1 rounded border border-gray-300 hover:bg-gray-50" %>
  </div>

    <!-- 共通変数 -->
    <% header_height = 48 %>              <%# ヘッダーの高さ（px）を共通化 %>
    <% column_height = 16 * 60 %>         <%# 8:00〜24:00 などを表現する高さ %>
    <% start_hour = @hours.first %>
    <% end_hour   = @hours.last %>        <%# ここでは +1 しない %>
    <% total_minutes = (end_hour - start_hour + 1) * 60 %>
    <% px_per_min = column_height.to_f / total_minutes %>

    <!-- カレンダー -->
    <div class="mt-8"> 
    <div class="border border-gray-300 rounded bg-white overflow-x-auto">

        <div class="flex min-w-[900px] text-[11px]">
            <!-- ▼ 左側：時間カラム -->
            <div class="w-10 border-r border-gray-300 bg-gray-50">
            <!-- 上のヘッダー（右の日付ヘッダーと高さを揃える） -->
            <div class="border-b border-gray-300 flex items-center justify-center text-[11px] text-gray-400"
                style="height: <%= header_height %>px;">
                時間
            </div>

            <!-- 時間軸エリア -->
            <div class="relative" style="height: <%= column_height %>px;">
                <% (start_hour..end_hour).each do |h| %>
                <% minutes_from_start = (h - start_hour) * 60 %>
                <% top = minutes_from_start * px_per_min %>

                <div class="absolute left-0 right-0 border-t border-gray-100"
                    style="top: <%= top %>px;">
                    <span class="absolute right-1 top-0.5 text-[10px] text-gray-400">
                    <%= "%02d:00" % h %>
                    </span>
                </div>
                <% end %>
            </div>
            </div>

            <!-- ▼ 右側：日カラム -->
            <div class="flex-1 flex">
            <% @calendar_days.each do |date| %>
                <% day_tasks = @tasks_for_calendar.select { |t| t.due_at&.to_date == date } %>

                <!-- 1日ぶんの縦カラム -->
                <div class="flex-1 border-l border-gray-300">
                <!-- 日付ヘッダー（高さを header_height に合わせる） -->
                <div class="bg-gray-50 border-b border-gray-300
                            flex flex-col items-center justify-center text-center"
                    style="height: <%= header_height %>px;">
                    <div class="text-lg font-semibold leading-tight">
                    <%= date.strftime("%m/%d") %>
                    </div>
                    <div class="leading-tight">
                    <%= %w[Sun. Mon. Tue. Wed. Thu. Fri. Sat.][date.wday] %>
                    </div>
                </div>

            <!-- 時間軸エリア -->
            <div class="relative" style="height: <%= column_height %>px;">
                <% day_start = date.to_time.in_time_zone.change(hour: start_hour, min: 0) %>
                <% day_end   = date.to_time.in_time_zone.change(hour: end_hour,   min: 0) + 1.hour %>

                <!-- 背景の時間グリッド（横線） -->
                <% (start_hour..end_hour).each do |h| %>
                <% minutes_from_start = (h - start_hour) * 60 %>
                <% top = minutes_from_start * px_per_min %>

                <div class="absolute left-0 right-0 border-t border-gray-100"
                    style="top: <%= top %>px;">
                    <span class="absolute left-1 top-0.5 text-[10px] text-gray-300">
                    <%= "%02d:00" % h %>
                    </span>
                </div>
                <% end %>

                <% max_per_slot = 2 %> <%# この時間帯で横に並べる最大件数 %>
                <% slot_groups = Hash.new { |h, k| h[k] = [] } %>

                <% day_tasks.each do |task| %>
                    <% next unless task.due_at %>
                    <% display_time = task.due_at - 1.hour %>
                    <% slot_time = display_time.beginning_of_hour %>
                    <% slot_groups[slot_time] << task %>
                <% end %>

                <% slot_groups.sort.each do |slot_time, tasks_in_slot| %>
                    <% start_time = slot_time %>
                    <% end_time   = slot_time + 1.hour %>

                    <% start_clamped = [start_time, day_start].max %>
                    <% end_clamped   = [end_time,   day_end].min %>

                    <% duration = end_clamped - start_clamped %>
                    <% next if duration <= 0 %>

                    <% minutes_from_start = ((start_clamped - day_start) / 60).to_i %>
                    <% top_px = minutes_from_start * px_per_min %>
                    <% height_px = 18 %>

                    <% visible_tasks = tasks_in_slot.first(max_per_slot) %>
                    <% hidden_count  = [tasks_in_slot.size - max_per_slot, 0].max %>

                    <div class="absolute left-0 right-0 px-1"
                        style="top: <%= top_px %>px; height: <%= height_px %>px;">
                    <div class="flex gap-1 items-center">
                        <% visible_tasks.each do |task| %>
                        <% color_class =
                            case task.status
                            when "todo"        then "bg-red-100 text-red-700"
                            when "in_progress" then "bg-blue-100 text-blue-700"
                            when "done"        then "bg-green-100 text-green-700"
                            when "archived"    then "bg-yellow-100 text-yellow-800"
                            else                    "bg-gray-100 text-gray-600"
                            end
                        %>

                        <%= link_to task_path(task),
                            class: "flex-1 min-w-0 rounded text-[11px] px-2 py-0 " \
                                    "overflow-hidden truncate border border-gray-300 shadow-sm " \
                                    "hover:opacity-80 #{color_class}",
                            data: {
                                turbo_frame: "side-panel-frame",
                                action: "click->side-panel#open",
                                side_panel_title_param: task.title
                            } do %>
                            <!-- <span class="text-[10px]">T｜</span> -->
                            <span><%= task.title %></span>
                        <% end %>
                        <% end %>

                        <% if hidden_count > 0 %>
                        <%= link_to(
                                "+#{hidden_count}",
                                slot_tasks_path(
                                date: date.to_s,
                                hour: slot_time.hour
                                ),
                                class: "text-[11px] px-2 py-0.5 rounded-full bg-white/80
                                        border border-gray-300 text-gray-500 whitespace-nowrap font-semibold hover:bg-gray-100",
                                data: {
                                turbo_frame: "side-panel-frame",
                                action: "click->side-panel#open",
                                side_panel_title_param: "#{date.strftime('%m/%d')} #{slot_time.strftime('%H:%M')} のタスク"
                                }
                            ) %>
                        <% end %>
                    </div>
                    </div>
                <% end %>
                </div>
            </div>
            <% end %>
        </div>
        </div>
    </div>
</div>

--- FILE: app/views/tasks/_sidebar.html.erb ---
<!-- app/views/tasks/_sidebar.html.erb -->

<h2 class="font-semibold text-lg mb-3">Task</h2>

<!-- ▼表示切り替え（リスト/カレンダー）+新規作成ボタン -->
<div class="mb-4 flex justify-between items-center text-sm">
  <div class="inline-flex items-center rounded-full border border-gray-300 bg-gray-50 p-0.5">
    <%= link_to "List",
                tasks_path,
                class: "px-3 py-1 text-xs rounded-full " +
                        (@view_mode == "calendar" ?
                          "text-gray-500 hover:bg-white" :
                          "bg-white shadow text-gray-900") %>

    <%= link_to "Calendar",
                tasks_path(view: :calendar),
                class: "px-3 py-1 text-xs rounded-full " +
                        (@view_mode == "calendar" ?
                          "bg-white shadow text-gray-900" :
                          "text-gray-500 hover:bg-white") %>
  </div>
</div>

<div class="mb-4 flex justify-between items-center text-sm">
  <%= link_to "新規タスク作成",
              new_task_path,
              class: "text-xs px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",
              data: {
                turbo_frame: "side-panel-frame",
                action: "click->side-panel#open",
                side_panel_title_param: "新規タスク"
              } %>
</div>

<nav class="space-y-1">
  <!-- 全体 -->
  <%= link_to "すべてのタスク",
              tasks_path,
              class: nav_class(tasks_path) %>

  <!-- よくある絞り込み（あとで実装予定でもOK） -->
  <%= link_to "今日のタスク",
              tasks_path(filter: :today),
              class: nav_class(tasks_path(filter: :today)) %>

  <%= link_to "今週のタスク",
              tasks_path(filter: :this_week),
              class: nav_class(tasks_path(filter: :this_week)) %>

  <%= link_to "未完了タスク",
              tasks_path(filter: :incomplete),
              class: nav_class(tasks_path(filter: :incomplete)) %>

  <%= link_to "完了タスク",
              tasks_path(filter: :done),
              class: nav_class(tasks_path(filter: :done)) %>

  <hr class="my-3">
  
</nav>

--- FILE: app/views/tasks/edit.html.erb ---
<!-- app/views/tasks/edit.html.erb -->
<turbo-frame id="side-panel-frame">
  <% unless turbo_frame_request? %>
    <% content_for :sidebar do %>
      <%= render "tasks/sidebar" %>
    <% end %>
    <h1 class="text-xl font-bold mb-4">タスク編集</h1>
  <% end %>

  <%= render "form", task: @task %>
</turbo-frame>


--- FILE: app/views/tasks/show.html.erb ---
<!-- app/views/tasks/show.html.erb -->

<turbo-frame id="side-panel-frame">
  <% unless turbo_frame_request? %>
    <% content_for :sidebar do %>
      <%= render "tasks/sidebar" %>
    <% end %>
  <% end %>

  <!-- 1行目：タイトル -->
  <h1 class="text-xl font-bold mb-2"><%= @task.title %></h1>

  <!-- 2行目：期限 ｜ 担当者 ｜ 作成者 -->
  <div class="flex flex-wrap items-center text-sm text-gray-700 mb-1">
    <!-- 期限 -->
      <div class="flex items-center gap-1">
        <span class="text-gray-500">期限</span>
        <span>
          <%= due_badge(@task) %>
        </span>
      </div>

    <!-- 区切り：薄いグレーの ｜ -->
    <span class="mx-2 text-gray-300">｜</span>

    <!-- 担当者 -->
    <div class="flex items-center gap-1 flex-wrap">
      <span class="text-gray-500">担当者</span>
      <% if @task.assignees.any? %>
        <% @task.assignees.each do |profile| %>
          <%= profile_chip(
                profile,
                size: :xs,
                wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-xs mr-1 mb-1"
              ) %>
        <% end %>
      <% else %>
        <span class="text-xs text-gray-400">未設定</span>
      <% end %>
    </div>

    <!-- 区切り -->
    <span class="mx-2 text-gray-300">｜</span>

    <!-- 作成者 -->
    <div class="flex items-center gap-1">
      <span class="text-gray-500">作成者</span>
      <% if @task.owner_profile %>
        <%= profile_chip(
              @task.owner_profile,
              size: :xs,
              wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-xs"
            ) %>
      <% else %>
        <span class="text-xs text-gray-400">不明</span>
      <% end %>
    </div>
  </div>

  <!-- 3行目：ステータス ＋ ピン留めコメント概要 -->
  <div class="flex flex-wrap items-center gap-4 text-sm text-gray-700 mb-3">
    <!-- ステータス -->
      <div class="flex items-center gap-1">
        <span class="text-gray-500">ステータス</span>
        <span class="ml-1">
          <%= status_badge(@task) %>
        </span>
        <!-- 即時変更用プルダウン -->
        <%= form_with model: @task,
                      url: task_path(@task),
                      method: :patch,
                      data: { turbo_frame: "side-panel-frame" },
                      class: "inline-block" do |f_task| %>
          <%= f_task.select :status,
                            Task.statuses.keys.map { |k| [k, k] },
                            { selected: @task.status },
                            class: "border border-gray-300 rounded px-2 py-1",
                            onchange: "this.form.submit();" %>
        <% end %>
      </div>

    <% if @task.pinned_comments.any? %>
      <!-- 区切り：薄いグレーの ｜ -->
      <span class="text-gray-300">｜</span>

      <% main_pinned = @task.pinned_comments.first %>

      <!-- ピン留めコメント概要 -->
      <div class="flex items-center gap-1 min-w-0">
        <span class="text-gray-500 text-[11px]">
          ピン
          <% if @task.pinned_comments.size > 1 %>
            (<%= @task.pinned_comments.size %>)
          <% end %>
        </span>

        <%= profile_chip(
              main_pinned.author_profile,
              size: :xs,
              wrapper_class: "inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-[11px]"
            ) %>

        <!-- コメント本文は1行だけ、省略表示 -->
        <span class="text-[11px] text-gray-600 truncate max-w-xs">
          <%= h(main_pinned.body) %>
        </span>
      </div>
    <% end %>
  </div>


  <!-- 操作ボタン -->
  <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
    <%= link_to "編集",
                edit_task_path(@task),
                class: "px-2 py-1 bg-gray-50 border border-gray-300 rounded hover:bg-gray-100",
                data: {
                  turbo_frame: "side-panel-frame",
                  action: "click->side-panel#open",
                  side_panel_title_param: "タスク編集"
                } %>

    <%= button_to "削除",
                task_path(@task),
                method: :delete,
                form: {data: { turbo_confirm: "このタスクを削除しますか？" }},
                class: "ml-auto px-2 py-1 bg-red-50 text-red-700 border border-red-200 rounded hover:bg-red-100" %>
  </div>

  <!-- コメント一覧 -->
  <div class="mt-4 pt-3 border-t border-gray-300">
    <h2 class="text-sm font-semibold mb-2">コメント</h2>

    <div class="space-y-3 mb-3">
      <%= render partial: "comments/comment",
                  collection: @task.comments.includes(:author_profile).order(:created_at),
                  as: :comment %>

      <% if @task.comments.empty? %>
        <p class="text-xs text-gray-400">まだコメントはありません。</p>
      <% end %>
    </div>

    <!-- 新規コメントフォーム -->
    <div class="mt-3">
      <h3 class="text-xs text-gray-500 mb-1">新規コメント</h3>
      <%= render "comments/form", task: @task, comment: @task.comments.build %>
    </div>
  </div>
</turbo-frame>


--- FILE: app/views/tasks/_form.html.erb ---
<!-- app/views/tasks/_form.html.erb -->
<%= form_with model: @task,
              local: true,
              data: (@task.new_record? ? { turbo_frame: "_top" } : {}) do |f| %>
  <% if @task.errors.any? %>
    <div class="mb-4 p-3 bg-red-50 text-red-700 rounded text-sm">
      <p class="font-semibold"><%= @task.errors.count %>件のエラーがあります。</p>
      <ul class="list-disc list-inside">
        <% @task.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- タイトル -->
  <div class="mb-4">
    <%= f.label :title, "タイトル", class: "block text-sm mb-1" %>
    <%= f.text_field :title,
                     class: "border border-gray-300 rounded px-2 py-1 w-full text-sm",
                     placeholder: "タイトル" %>
  </div>

  <!-- 期限 -->
  <div class="mb-4">
    <%= f.label :due_date, "期限", class: "block text-sm mb-1" %>

    <div class="flex items-center gap-2">
      <!-- 日付：カレンダーで選ぶ -->
      <%= f.date_field :due_date,
                       value: (@task.due_date || @task.due_at&.to_date),
                       class: "border border-gray-300 rounded px-2 py-1 text-sm" %>

      <span class="text-sm text-gray-500">時間</span>

      <!-- 時刻：テキスト入力のみ（30分単位を想定） -->
      <%= f.text_field :due_time,
                       value: (@task.due_time || @task.due_at&.strftime("%H:%M")),
                       class: "border border-gray-300 rounded px-2 py-1 text-sm w-20",
                       placeholder: "23:30",
                       inputmode: "numeric",
                       pattern: "[0-2][0-9]:(00|30)" %>
    </div>

    <p class="text-[11px] text-gray-500 mt-1">
      例）09:00, 13:30 のように 30分単位で入力してください。空の場合は期限なしになります。
    </p>
  </div>

  <!-- 担当者 -->
    <div class="mb-4">
      <%= f.label :assignee_ids, "担当者", class: "block text-sm mb-1" %>

      <div class="flex flex-wrap gap-2">
        <%= f.collection_check_boxes :assignee_ids,
                                    @assignee_candidates,
                                    :id,
                                    :display_name do |b| %>
          <label class="inline-flex items-center px-2 py-1 rounded-full border border-gray-300 bg-gray-50 cursor-pointer text-xs">
            <!-- 実際のチェックボックス（地味でもOK） -->
            <%= b.check_box(class: "mr-1") %>

            <!-- アイコン＋名前 -->
            <%= profile_avatar(b.object, size: :xs) %>
            <span class="ml-1"><%= b.object.display_name %></span>
          </label>
        <% end %>
      </div>

      <p class="text-[11px] text-gray-500 mt-1">
        担当者をクリックすると選択／解除できます（複数選択可）。
      </p>
    </div>

  <!-- 詳細 -->
  <div class="mb-4">
    <%= f.label :description, "詳細", class: "block text-sm mb-1" %>
    <%= f.text_area :description,
                    rows: 4,
                    class: "border border-gray-300 rounded px-2 py-1 w-full text-sm" %>
  </div>

  <!-- タグ -->
  <div class="mb-4">
    <%= f.label :tag_list, "タグ", class: "block text-sm mb-1" %>
    <%= f.text_field :tag_list,
                     value: @task.tag_list,
                     class: "border border-gray-300 rounded px-2 py-1 w-full text-sm",
                     placeholder: "例）RUNTEQ, Rails, バグ修正" %>
    <p class="text-[11px] text-gray-500 mt-1">
      カンマ（,）区切りで複数タグを入力できます。
    </p>
  </div>

  <!-- ステータス -->
  <div class="mb-4">
    <%= f.label :status, "ステータス", class: "block text-sm mb-1" %>
    <%= f.select :status,
                 Task.statuses.keys.map { |k| [k, k] },
                 {},
                 class: "border border-gray-300 rounded px-2 py-1 w-full text-sm" %>
  </div>

  <%= f.submit (@task.new_record? ? "タスクを作成" : "タスクを更新"),
             class: "px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" %>
<% end %>

--- FILE: app/views/tasks/new.html.erb ---
<!-- app/views/tasks/new.html.erb -->
<turbo-frame id="side-panel-frame">
  <% unless turbo_frame_request? %>
    <!-- 直接 /tasks/new にアクセスしたときだけページタイトルを出す -->
    <h1 class="text-xl font-bold mb-4">タスク新規作成</h1>
  <% end %>

  <%= render "form", task: @task %>
</turbo-frame>


--- FILE: app/views/profile_settings/theme.html.erb ---
<!-- app/views/profile_settings/theme.html.erb -->
<div>
  <h1 class="font-bold text-4xl">ProfileSettings#theme</h1>
  <p>Find me in app/views/profile_settings/theme.html.erb</p>
</div>


--- FILE: app/views/profile_settings/_sidebar.html.erb ---
<!-- app/views/profile_settings/_sidebar.html.erb -->
<h2 class="font-semibold text-sm mb-3">プロフィール設定</h2>
<nav class="space-y-1">

<!-- ホームをコメントアウト -->
<%#= link_to "ホーム",
            edit_profile_path(current_profile),
            class: nav_class(edit_profile_path(current_profile)) %>

<%= link_to "プロフィール編集",
            edit_profile_path(current_profile),
            class: nav_class(edit_profile_path(current_profile)) %>

<%= link_to "新規プロフィール作成",
            new_profile_path,
            class: nav_class(new_profile_path) %>

<%= link_to "メール・パスワード変更",
            edit_user_registration_path,
            class: nav_class(edit_user_registration_path) %>
</nav>

--- FILE: app/views/profile_settings/edit.html.erb ---
<!-- app/views/profile_settings/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render "profiles/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">プロフィール編集</h1>

<% if @profile %>
  <%= render "profiles/form", profile: @profile %>

  <!-- ▼ 参加IDでチームに参加申請する ▼ -->
  <div class="mt-6 border-t pt-4">
    <h3 class="text-sm font-semibold mb-2">プロフィール参加IDでチームに参加申請</h3>

    <!-- 1) 参加IDでチーム検索（GET） -->
    <%= form_with url: edit_profile_path(current_profile), method: :get, local: true,
                  class: "flex flex-wrap items-end gap-2 mb-3" do %>
      <div>
        <label class="block text-xs mb-1">参加ID</label>
        <%= text_field_tag :team_invite_token,
                           @team_invite_token,
                           class: "border rounded px-2 py-1 text-sm",
                           placeholder: "例）AB12CD34" %>
      </div>

      <div class="mb-1">
        <%= submit_tag "チームを検索",
                       class: "px-3 py-2 text-xs bg-gray-100 rounded border hover:bg-gray-200" %>
      </div>
    <% end %>

    <% if @team_invite_token.present? %>
      <% if @invite_teams.any? %>
        <!-- 2) 検索結果から参加申請（POST） -->
        <%= form_with url: membership_requests_path, method: :post, local: true,
                      class: "flex flex-wrap items-end gap-2" do %>
          <%= hidden_field_tag :direction, "profile_to_team" %>

          <div>
            <label class="block text-xs mb-1">参加申請するチーム</label>
            <%= select_tag :team_id,
                           options_from_collection_for_select(@invite_teams, :id, :name),
                           class: "border rounded px-2 py-1 text-sm" %>
          </div>

          <div class="mb-1">
            <%= submit_tag "参加申請を送る",
                           class: "px-4 py-2 text-xs bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
          </div>
        <% end %>
      <% else %>
        <p class="text-xs text-red-500 mt-2">入力された参加IDに該当するチームが見つかりませんでした。</p>
      <% end %>
    <% end %>
  </div>
 

  <%# ---- 招待一覧 ---- %>
  <% if @incoming_team_invites.present? && @incoming_team_invites.any? %>
    <div class="mt-6 border-t pt-4">
      <h2 class="text-sm font-semibold mb-2">このプロフィール宛のチーム招待</h2>

      <table class="w-full text-xs">
        <thead>
          <tr class="border-b">
            <th class="text-left py-1">チーム名</th>
            <th class="text-left py-1">招待元プロフィール</th>
            <th class="text-left py-1"></th>
          </tr>
        </thead>
        <tbody>
          <% @incoming_team_invites.each do |req| %>
            <tr class="border-b">
              <td class="py-1">
                <%= team_chip(
                      req.team,
                      size: :xs,
                      wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                      ) %>
              </td>
              <td class="py-1">
                <% if req.requester_profile.present? %>
                  <%= profile_chip(
                    req.requester_profile,
                    size: :xs,
                    wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs font-semibold"
                    ) %>
                <% else %>
                  <span class="text-s text-gray-400">不明</span>
                <% end %>
              </td>
              <td class="py-1 text-right">
                <%= button_to "承認",
                              approve_membership_request_path(req),
                              method: :patch,
                              class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-xs text-gray-500 mt-4">このプロフィール宛のチーム招待はありません。</p>
  <% end %>

<% else %>
  <p class="text-sm text-red-600">
    編集対象のプロフィールが見つかりませんでした。
  </p>
<% end %>



--- FILE: app/views/profile_settings/home.html.erb ---
<!-- app/views/profile_settings/home.html.erb -->

<% content_for :sidebar do %>
  <%= render "profiles/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">プロフィール設定ホーム</h1>

<% if @profile %>
  <p class="text-sm text-gray-600 mb-4">
    現在のプロフィールの概要です。
  </p>

  <dl class="text-sm space-y-3">
    <div>
      <dt class="text-gray-500">プロフィール名</dt>
      <dd class="font-semibold"><%= @profile.label %></dd>
    </div>

    <div>
      <dt class="text-gray-500">テーマカラー</dt>
      <dd><%= @profile.theme.presence || "未設定" %></dd>
    </div>
  </dl>

  <% if @incoming_team_invites.any? %>
    <div class="mt-6 border-t pt-4">
      <h2 class="text-sm font-semibold mb-2">このプロフィール宛のチーム招待</h2>

      <table class="w-full text-xs">
        <thead>
          <tr class="border-b">
            <th class="text-left py-1">チーム名</th>
            <th class="text-left py-1">招待元プロフィール</th>
            <th class="text-left py-1"></th>
          </tr>
        </thead>
        <tbody>
          <% @incoming_team_invites.each do |req| %>
            <tr class="border-b">
              <td class="py-1"><%= req.team.name %></td>
              <td class="py-1"><%= req.requester_profile&.display_name || "不明" %></td>
              <td class="py-1 text-right">
                <%= button_to "承認",
                              approve_membership_request_path(req),
                              method: :patch,
                              class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-xs text-gray-500 mt-4">
      このプロフィール宛のチーム招待はありません。
    </p>
  <% end %>

<% else %>
  <p class="text-sm text-red-600">
    現在のプロフィールが選択されていません。
  </p>
<% end %>


--- FILE: app/views/shared/_side_panel.html.erb ---
<!-- app/views/shared/_side_panel.html.erb -->

<div
  data-side-panel-target="panel"
  class="fixed top-0 right-0 h-full bg-white shadow-lg border-l border-gray-300
         translate-x-full transition-transform duration-200 ease-out
         flex flex-col z-40"
  style="width: 480px;"
>
  <!-- 左端リサイズ用ハンドル -->
  <div
    data-side-panel-target="resizeHandle"
    data-action="mousedown->side-panel#startResize"
    class="absolute left-0 top-0 h-full w-1 cursor-col-resize bg-transparent"
  ></div>

  <!-- ヘッダー -->
  <div class="flex items-center justify-between px-3 py-2 border-b border-gray-300">
    <h2 class="text-sm font-semibold" data-side-panel-target="title">
      <!-- タイトルはリンク側から渡す -->
    </h2>
    <button
      type="button"
      class="text-xs text-gray-500 hover:text-gray-800"
      data-action="click->side-panel#close"
    >
      ✕
    </button>
  </div>

  <!-- 中身：Turbo Frame で差し替わる -->
  <div class="flex-1 overflow-y-auto p-3">
    <turbo-frame id="side-panel-frame">
      <p class="text-xs text-gray-400">
        ここに、新規タスク作成フォームなどが表示されます。
      </p>
    </turbo-frame>
  </div>
</div>

--- FILE: app/views/layouts/application.html.erb ---
<!-- app/views/layouts/application.html.erb -->
<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Todo Beaver" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# <link rel="manifest" href="/manifest.json"> %>
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="bg-white">
    <% if submit_mode? %>
      <div class="fixed top-0 inset-x-0 z-20 text-xs px-3 py-2 bg-amber-50 text-amber-800 border-b border-amber-200">
        【提出モード】メール送信は無効です（ログインはデモアカウントをご利用ください）
      </div>
    <% end %>
    <!-- ヘッダー -->
      <header class="fixed <%= submit_mode? ? 'top-8' : 'top-0' %> inset-x-0 shadow-sm z-10 <%= header_theme_class %>">
        <div class="w-full h-16 px-4 flex items-center">
          <!-- 1段：左 = プロフィール + ナビ / 右 = ロゴ -->
          <div class="flex items-center justify-between w-full">
            <!-- 左側：プロフィールブロック + ナビブロック -->
            <div class="flex items-center gap-8">
              <!-- プロフィール表示 + プロフィール切替 + ドロップダウン -->
              <div class="flex items-center gap-4">
                <% if user_signed_in? && current_user.profiles.any? && current_profile %>
                  <!-- プロフィールアイコン＋名前（クリックでメニュー） -->
                  <details class="relative">
                    <summary class="list-none cursor-pointer">
                      <%= profile_chip(
                            current_profile,
                            size: :sm,
                            wrapper_class: "text-sm font-semibold"
                          ) %>
                    </summary>

                    <!-- ドロップダウンメニュー -->
                    <div class="absolute mt-2 left-0 w-40 bg-white border border-gray-300 rounded shadow text-sm z-50">
                      <%= button_to "ログアウト",
                        destroy_user_session_path,
                        method: :delete,
                        form: { data: { turbo_confirm: "ログアウトしますか？" } }, 
                        class: "block w-full text-left px-3 py-2 text-gray-700 hover:bg-gray-100 bg-transparent border-0" %>
                    </div>
                  </details>

                  <!-- プロフィール切り替えセレクト -->
                  <div>
                    <%= form_with url: switch_profiles_path, method: :post, local: true do |f| %>
                      <%= f.select :profile_id,
                                  options_from_collection_for_select(
                                    current_user.profiles,
                                    :id,
                                    :label,
                                    current_profile&.id
                                  ),
                                  {},
                                  class: "border border-gray-300 rounded px-3 py-1 text-sm text-gray-700 bg-white",
                                  onchange: "this.form.submit();" %>
                    <% end %>
                  </div>
                <% end %>
              </div>

              <!-- プロフィールの右に少し空けて、左詰めでナビ -->
              <% if user_signed_in? %>
                <nav class="flex items-center gap-3">
                  <!-- タスク -->
                  <%= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "beaver_icon.png",
                                  alt: "タスク",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span>Task</span>
                  <% end %>

                  <!-- ワークス -->
                  <%#= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "owl_icon.png",
                                  alt: "タスク",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <%# <span>-Works</span> %>
                  <%# end %>

                  <!-- チャット -->
                  <%#= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "wolf_icon.png",
                                  alt: "タスク",
                                  class: "block",
                                  style: "height: 27px; width: auto;" %>
                    <%# <span>-Chat</span> %>
                  <%# end %>

                  <!-- ソーシャル -->
                  <%#= link_to root_path,
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "rabbit_icon.png",
                                  alt: "タスク",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <%# <span>-Social</span> %>
                  <%# end %>                  
                  
                  <!-- プロフィール -->
                  <%= link_to edit_profile_path(current_profile),
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "butterfly_icon.png",
                                  alt: "プロフィール",
                                  class: "block",
                                  style: "height: 25px; width: auto;" %>
                    <span>Profile</span>
                  <% end %>

                  <!-- チーム -->
                  <%= link_to edit_team_path(@team),
                              class: "text-lg font-semibold px-3 py-1 rounded hover:bg-white/10 flex items-center gap-1" do %>
                    <%#= image_tag "elephant_icon.png",
                                  alt: "チーム",
                                  class: "block",
                                  style: "height: 33px; width: auto;" %>
                    <span>Team</span>
                  <% end %>
              

                  <% if controller_name == "tasks" %>
                    <div class="ml-4">
                      <%= form_with url: tasks_path, method: :get, local: true,
                                    class: "flex items-center gap-1" do %>

                        <!-- 今の検索・フィルタ状態を引き継ぐ -->
                        <%= hidden_field_tag :q, params[:q] if params[:q].present? %>
                        <%= hidden_field_tag :filter, params[:filter] if params[:filter].present? %>
                        <%= hidden_field_tag :sort, params[:sort] if params[:sort].present? %>
                        <%= hidden_field_tag :direction, params[:direction] if params[:direction].present? %>
                        <%= hidden_field_tag :view, params[:view] if params[:view].present? %>

                        <label class="flex items-center gap-1 text-xs">
                          <%= check_box_tag :all_profiles,
                                            "1",
                                            params[:all_profiles] == "1",
                                            onchange: "this.form.submit();" %>
                          <span>全てのプロフィールのタスクを表示</span>
                        </label>
                      <% end %>
                    </div>
                  <% end %>
                </nav>
                <% end %>
            </div>

            <!-- 右側：ロゴ（イラスト） -->
            <div class="flex items-center">
              <%= link_to root_path, class: "flex items-center gap-2" do %>
                <%= image_tag "forestly_logo.png",
                              alt: "forestly",
                              class: "block",
                              style: "height: 45px; width: auto;" %>
              <% end %>
            </div>
          </div>
        </div>
      </header>

    <!-- メインコンテンツ -->
    <main class="<%= submit_mode? ? 'pt-24' : 'pt-16' %> pb-0">
      <% if notice %>
        <div class="mb-4 bg-green-100 text-green-800 px-4 py-2 rounded">
          <%= notice %>
        </div>
      <% end %>
      <% if alert %>
        <div class="mb-4 bg-red-100 text-red-800 px-4 py-2 rounded">
          <%= alert %>
        </div>
      <% end %>

      <div
        class="flex gap-0 min-h-[calc(100vh-4rem)]"
        data-controller="side-panel"
        data-side-panel-initial-width-value="480"
      >
        <% if content_for?(:sidebar) %>
          <aside class="w-60 shrink-0 px-4 pt-3 pb-6 self-stretch <%= sidebar_theme_class %>">
            <%= yield :sidebar %>
          </aside>

          <section class="flex-1 bg-white px-6 pt-3 pb-6 overflow-auto">
            <%= yield %>
          </section>
        <% else %>
          <section class="flex-1 bg-white px-6 pt-3 pb-6">
            <%= yield %>
          </section>
        <% end %>

      <!-- 共通サイドパネルを描画 -->
      <%= render "shared/side_panel" %>
      </div>
    </main>

    <!-- Tailwind に yellow系クラスを認識させるためのダミー要素（画面には表示されません） -->
    <span class="hidden
      bg-slate-800 bg-slate-900
      bg-indigo-700 bg-indigo-800
      bg-emerald-700 bg-emerald-800
      bg-rose-700 bg-rose-800
      bg-amber-700 bg-amber-800
      text-white
      bg-white/10 text-white/80 hover:bg-white/10 hover:text-white
    "></span>

  </body>
</html>



--- FILE: app/views/layouts/mailer.html.erb ---
<!-- app/views/layouts/miler.html.erb -->
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
      /* Email styles need to be inline */
    </style>
  </head>

  <body>
    <%= yield %>
  </body>
</html>


--- FILE: app/views/users/confirmations/confirm_change_email.html.erb ---
<!-- app/views/users/confirmations/confirm_change_email.html.erb -->
<h1 class="text-xl font-bold mb-4">メールアドレスの変更</h1>

<p class="mb-4">
  新しいメールアドレス（確認用）：
  <span class="font-semibold"><%= resource.unconfirmed_email %></span>
</p>

<%= form_with url: user_confirmation_path, method: :post, local: true do %>
  <%= hidden_field_tag :confirmation_token, @confirmation_token %>
  <%= submit_tag "上記のメールアドレスで確定する",
                 class: "px-4 py-2 rounded bg-blue-600 text-white" %>
<% end %>


--- FILE: app/views/teams/index.html.erb ---
<!-- app/views/teams/index.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">チーム一覧</h1>

<div class="mb-4">
  <%= link_to "新規チーム作成",
              new_team_path,
              class: "text-sm px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" %>
</div>

<table class="w-full text-sm">
  <thead>
    <tr class="border-b">
      <th class="text-left py-2">チーム名</th>
      <th class="text-left py-2">作成日</th>
      <th class="text-left py-2"></th>
    </tr>
  </thead>
  <tbody>
    <% @teams.each do |team| %>
      <tr class="border-b">
        <td class="py-2">
          <%= link_to team_path(team), class: "inline-block" do %>
            <%= team_chip(
                  team,
                  size: :xs,
                  wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                ) %>
          <% end %>
        </td>
        <td class="py-2"><%= l(team.created_at.to_date) %></td>
        <td class="py-2">
          <%= link_to "編集", edit_team_path(team), class: "text-xs text-gray-600 underline mr-2" %>
        <%= button_to "削除",
          team_path(team),
          method: :delete,
          form: { data: { turbo_confirm: "本当に削除しますか？" } },
          class: "text-xs text-red-600 underline bg-transparent border-0 p-0 inline" %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>


--- FILE: app/views/teams/edit.html.erb ---
<!-- app/views/teams/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">チーム編集</h1>
<%= render "form", team: @team %>

--- FILE: app/views/teams/show.html.erb ---
<!-- app/views/teams/show.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4"><%= @team.name %></h1>

<p class="text-sm text-gray-600 mb-4">
  作成日：<%= l(@team.created_at.to_date) %>
</p>

<div class="flex gap-3 text-sm">
  <%= link_to "編集", edit_team_path(@team), class: "px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" %>
  <%= link_to "一覧に戻る", teams_path, class: "px-3 py-1 bg-gray-100 rounded hover:bg-gray-200" %>
</div>

--- FILE: app/views/teams/_form.html.erb ---
<!-- app/views/teams/_form.html.erb -->
<%= form_with model: @team, local: true do |f| %>
  <% if @team.errors.any? %>
    <div class="mb-4 text-sm text-red-700 bg-red-50 px-3 py-2 rounded">
      <p class="font-semibold"><%= @team.errors.count %>件のエラーがあります。</p>
      <ul class="list-disc list-inside">
        <% @team.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-4 max-w-md">
    <%= f.label :name, "チーム名", class: "block text-sm mb-1" %>
    <%= f.text_field :name,
                     class: "w-full border border-gray-300 rounded px-3 py-2 text-sm",
                     placeholder: "チーム名を入力してください" %>
  </div>

  <div class="mb-4">
    <%= f.label :avatar, "チームアイコン", class: "block text-sm mb-1" %>

    <% if @team.avatar.attached? %>
      <div class="mb-2">
        <%= team_avatar(@team, size: :md) %>
      </div>
    <% end %>

    <%= f.file_field :avatar,
                     accept: "image/*",
                     class: "block w-full text-sm" %>

    <% if @team.avatar.attached? %>
      <label class="mt-2 inline-flex items-center text-xs text-red-600">
        <%= f.check_box :remove_avatar, class: "mr-1" %>
        画像を削除する
      </label>
    <% end %>

    <p class="text-[11px] text-gray-500 mt-1">
      正方形の画像がおすすめです（例: 400×400）。
    </p>
  </div>
  
  <%= f.submit "チームを作成する",
               class: "px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" %>
<% end %>


--- FILE: app/views/teams/new.html.erb ---
<!-- app/views/teams/new.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">新規チーム作成</h1>
<%= render "form", team: @team %>


--- FILE: app/views/team_settings/_sidebar.html.erb ---
<!-- app/views/team_settings/_sidebar.html.erb -->
<h2 class="font-semibold text-sm mb-3">チーム設定</h2>
<nav class="space-y-1">
<%#= link_to "ホーム",
            team_path(@team),
            class: nav_class(team_path(@team)) %>

<%= link_to "チーム編集",
            edit_team_path(@team),
            class: nav_class(edit_team_path(@team)) %>

<%= link_to "メンバー管理",
            manage_team_path(@team),
            class: nav_class(manage_team_path(@team)) %>

<%= link_to "新規チーム作成",
            new_team_path,
            class: nav_class(new_team_path) %>
</nav>

--- FILE: app/views/team_settings/members.html.erb ---
<!-- app/views/team_settings/members.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">メンバー管理</h1>

<% if @teams.any? %>
  <!-- チーム選択 -->
  <div class="mb-4">
    <%= form_with url: manage_team_path(@team), method: :get, local: true, class: "inline-block" do |f| %>
      <label class="text-sm mr-2">チームを選択：</label>
      <%= f.select :team_id,
                   options_from_collection_for_select(@teams, :id, :name, @selected_team&.id),
                   {},
                   class: "border border-gray-300 rounded px-2 py-1 text-sm",
                   onchange: "this.form.submit();" %>
    <% end %>
  </div>

  <% if @selected_team %>
    <div class="flex items-center mb-2">
      <%= team_chip(
            @selected_team,
            size: :sm,
            wrapper_class: "px-2 py-1 rounded bg-gray-100 text-sm"
          ) %>
      <span class="ml-2 text-sm text-gray-500">のメンバー</span>
    </div>

    <!-- メンバー一覧 -->
    <% if @memberships.any? %>
      <table class="w-full text-sm mb-4">
        <thead>
          <tr class="border-b">
            <th class="text-left py-2">プロフィール名</th>
            <th class="text-left py-2">役割</th>
            <th class="text-left py-2"></th>
          </tr>
        </thead>
        <tbody>
          <% @memberships.each do |membership| %>
            <tr>
              <td class="py-1">
                <%= profile_chip(
                  membership.profile,
                  size: :xs,
                  wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                ) %>
              </td>

              <td class="py-2">
                <% if @can_manage_members %>
                  <!-- ✅ 管理者の場合だけ、プルダウンで変更できる -->
                  <%= form_with model: membership,
                                url: team_membership_path(membership),
                                method: :patch,
                                local: true,
                                class: "inline-block" do |f| %>
                    <%= f.select :role,
                                options_for_select(
                                  [
                                    ["管理者", TeamMembership::ADMIN_ROLE],
                                    ["メンバー", ""]
                                  ],
                                  membership.admin? ? TeamMembership::ADMIN_ROLE : ""
                                ),
                                {},
                                class: "border border-gray-300 rounded px-2 py-1 text-xs",
                                onchange: "this.form.submit();" %>
                  <% end %>
                <% else %>
                  <!-- ✅ メンバーは「表示だけ」 -->
                  <% if membership.admin? %>
                    管理者
                  <% else %>
                    メンバー
                  <% end %>
                <% end %>
              </td>

              <td class="py-2 text-right">
                <% if @can_manage_members %>
                  <%= button_to "削除",
                                team_membership_path(membership),
                                method: :delete,
                                form: { data: { turbo_confirm: "このメンバーを削除しますか？" }},
                                class: "text-xs px-3 py-1 bg-red-50 text-red-700 rounded border border-red-200 hover:bg-red-100" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      
    <% else %>
      <p class="text-sm text-gray-500 mb-4">
        まだこのチームにはメンバーがいません。
      </p>
    <% end %>

    <!-- ▼ 申請IDでプロフィールを招待するセクション ▼ -->
      <div class="mt-6 border-t pt-4">
        <h3 class="text-sm font-semibold mb-2">参加申請一覧</h3>

        <% if @incoming_join_requests.any? %>
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b">
                <th class="text-left py-1">申請プロフィール</th>
                <th class="text-left py-1"></th>
              </tr>
            </thead>
            <tbody>
              <% @incoming_join_requests.each do |req| %>
                <tr class="border-b">
                  <td class="py-1">
                    <% if req.requester_profile %>
                      <%= profile_chip(
                            req.requester_profile,
                            size: :xs,
                            wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                          ) %>
                    <% else %>
                      <span class="text-xs text-gray-400">不明</span>
                    <% end %>
                  </td>
                  <td class="py-1 text-right">
                    <%= button_to "承認",
                                  approve_membership_request_path(req),
                                  method: :patch,
                                  class: "px-3 py-1 text-[11px] bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <p class="text-xs text-gray-500 mt-2">参加申請はありません。</p>
        <% end %>
      </div>


  <% end %>
<% else %>
  <p class="text-sm text-gray-500">
    まだチームがありません。「チームを作成する」から追加してください。
  </p>
<% end %>


--- FILE: app/views/team_settings/edit.html.erb ---
<!-- app/views/team_settings/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">チーム編集</h1>

<div class="mb-4">
  <%= link_to "チームを作成する",
              new_team_path,
              class: "text-sm px-3 py-2 bg-blue-100 text-blue-700 rounded border border-blue-300 hover:bg-blue-200" %>
</div>

<% if @teams.any? %>
  <table class="w-full text-sm">
    <thead>
      <tr class="border-b">
        <th class="text-left py-2">チーム名</th>
        <th class="text-left py-2">プロフィール参加ID</th>
        <th class="text-left py-2">作成日</th>
        <th class="text-left py-2"></th>
      </tr>
    </thead>
    <tbody>
      <% @teams.each do |team| %>
        <tr class="border-b">
          <td class="py-2">
            <%= link_to team_path(team), class: "inline-block" do %>
              <%= team_chip(
                    team,
                    size: :xs,
                    wrapper_class: "px-2 py-1 rounded bg-gray-100 text-xs"
                  ) %>
            <% end %>
          </td>
          <td class="py-2 font-mono text-xs text-gray-600">
            <%= team.join_token.presence || "-" %>
          </td>
          <td class="py-2"><%= l(team.created_at.to_date) %></td>
          <td class="py-2 text-right">
            <%= link_to "編集",
                        edit_team_path(team),
                        class: "text-xs text-blue-600 underline mr-3" %>

            <%= button_to "削除",
              team_path(team),
              method: :delete,
              form: { data: { turbo_confirm: "本当に削除しますか？" } },
              class: "text-xs text-red-600 underline bg-transparent border-0 p-0 inline" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p class="text-sm text-gray-500">
    まだチームがありません。「チームを作成する」から追加してください。
  </p>
<% end %>

--- FILE: app/views/team_settings/home.html.erb ---
<!-- app/views/team_settings/home.html.erb -->
<% content_for :sidebar do %>
  <%= render "teams/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">チーム設定ホーム</h1>

<p class="text-sm text-gray-600">
  所属チームの一覧や設定への入口をここに配置していく想定です。
</p>

--- FILE: app/views/profiles/index.html.erb ---
<!-- app/views/profiles/index.html.erb -->
<div class="p-8">
  <h1 class="text-2xl font-bold mb-4">プロフィール一覧</h1>

  <div class="mb-4">
    <%= link_to "新規プロフィール作成", new_profile_path,
                class: "inline-block px-3 py-1 bg-blue-600 text-white rounded" %>
  </div>

  <% if @profiles.any? %>
    <table class="min-w-full text-sm">
      <thead>
        <tr>
          <th class="text-left p-2">名前</th>
          <th class="text-left p-2">テーマ</th>
          <th class="text-left p-2">操作</th>
        </tr>
      </thead>
      <tbody>
        <% @profiles.each do |profile| %>
          <tr class="border-t">
            <td class="p-2"><%= link_to profile.label, profile %></td>
            <td class="p-2"><%= profile.theme.presence || "-" %></td>
            <td class="p-2 space-x-2">
              <%= link_to "編集", edit_profile_path(profile),
                          class: "text-blue-600 underline" %>
              <%= button_to "削除",
                profile_path(profile),
                method: :delete,
                form: { data: { turbo_confirm: "削除してよいですか？" } },
                class: "text-red-600 underline text-xs bg-transparent border-0 p-0 inline" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p>まだプロフィールがありません。</p>
  <% end %>
</div>

--- FILE: app/views/profiles/edit.html.erb ---
<!-- app/views/profiles/edit.html.erb -->
<% content_for :sidebar do %>
  <%= render "profiles/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">プロフィール編集</h1>

<%= render "form", profile: @profile %>

--- FILE: app/views/profiles/show.html.erb ---
<!-- app/views/profiles/show.html.erb -->
<% content_for :sidebar do %>
  <%= render "profiles/sidebar" %>
<% end %>

<h1 class="text-xl font-bold mb-4">プロフィール詳細</h1>

<div class="space-y-3 text-sm">
  <div>
    <dt class="text-gray-500">プロフィール名（管理用）</dt>
    <dd class="font-semibold"><%= @profile.label %></dd>
  </div>

  <div>
    <dt class="text-gray-500">表示名（他ユーザーに見せる名前）</dt>
    <dd class="font-semibold"><%= @profile.display_name %></dd>
  </div>

  <div>
    <dt class="text-gray-500">テーマカラー</dt>
    <dd><%= @profile.theme.presence || "未設定" %></dd>
  </div>

  <div class="pt-3">
    <%= link_to "編集", edit_profile_path(@profile),
                class: "px-3 py-2 bg-blue-600 text-white rounded" %>
  </div>
</div>



--- FILE: app/views/profiles/_form.html.erb ---
<!-- app/views/profiles/_form.html.erb -->
<%= form_with model: @profile, local: true do |f| %>
  <% if @profile.errors.any? %>
    <div class="mb-4 p-3 bg-red-50 text-red-700 rounded">
      <p><%= @profile.errors.count %>件のエラーがあります：</p>
      <ul class="list-disc list-inside">
        <% @profile.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-4">
    <%= f.label :label, "プロフィール管理名（プロフィール切り替えに利用する名前）", class: "block mb-1 text-sm" %>
    <%= f.text_field :label,
                     class: "border border-gray-300 rounded px-2 py-1 w-full",
                     placeholder: "株式会社〇〇 / 副業 / プライベート など" %>
  </div>

  <div class="mb-4">
    <%= f.label :display_name, "表示名（他のユーザーに表示される名前）", class: "block mb-1 text-sm" %>
    <%= f.text_field :display_name,
                    class: "border border-gray-300 rounded px-2 py-1 w-full",
                    placeholder: "例）田中太郎 / Tanaka Taro など" %>
  </div>

  <div class="mb-4">
    <%= f.label :avatar, "アイコン画像", class: "block text-sm mb-1" %>

    <% if @profile.avatar.attached? %>
        <div class="mb-2">
        <%= profile_avatar(@profile, size: :md) %>
        </div>
    <% end %>

    <div class="flex items-center gap-2">
      <!-- 見た目用のボタン（label） -->
      <%= f.label :avatar,
                  class: "px-3 py-1 border border-gray-300 rounded text-sm bg-white cursor-pointer hover:bg-gray-50" do %>
        ファイルを選択
      <% end %>

      <!-- 選択されたファイル名を表示する所 -->
      <span id="avatar-filename" class="text-xs text-gray-500">
        選択されていません
      </span>

      <!-- 本体の file input は隠す -->
      <%= f.file_field :avatar,
                       accept: "image/*",
                       class: "hidden",
                       onchange: "document.getElementById('avatar-filename').textContent = this.files[0]?.name || '選択されていません';" %>
    </div>


    <% if @profile.avatar.attached? %>
        <label class="mt-2 inline-flex items-center text-xs text-red-600">
        <%= f.check_box :remove_avatar, class: "mr-1" %>
        画像を削除する
        </label>
    <% end %>

    <p class="text-[11px] text-gray-500 mt-1">
        正方形の画像が推奨です（例: 400×400）。
    </p>
    </div>

  <% if @profile.persisted? && @profile.join_token.present? %>
    <div class="mb-4">
      <label class="block text-xs mb-1 text-gray-500">
        チーム招待ID
      </label>

      <input type="text"
             value="<%= @profile.join_token %>"
             readonly
             class="border border-gray-300 rounded px-2 py-1 w-full bg-gray-50 text-gray-600 text-sm" />

      <p class="text-[11px] text-gray-400 mt-1">
        このIDは編集できません。プロフィール参加申請に使います。
      </p>
    </div>
  <% end %>

  <div class="mb-4">
    <p class="block mb-2 text-sm">テーマ（ヘッダー・左ナビの色）</p>

    <div class="flex flex-wrap gap-2">
      <% Profile::THEMES.each do |key| %>
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded border border-gray-300 bg-white cursor-pointer">
          <%= f.radio_button :theme, key, class: "mr-1" %>
          <span class="text-sm"><%= key %></span>
        </label>
      <% end %>
    </div>

    <p class="text-[11px] text-gray-500 mt-2">
      メイン画面とライトパネルは白のまま、ヘッダーと左ナビだけ色が変わります。
    </p>
  </div>

  <%= f.submit(@profile.persisted? ? "プロフィール設定を更新する" : "プロフィールを作成する",
             class: "px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700") %>
<% end %>


--- FILE: app/views/profiles/new.html.erb ---
<!-- app/views/profiles/new.html.erb -->

<% if user_signed_in? && current_user.profiles.any? %>
  <% content_for :sidebar do %>
    <%= render "profiles/sidebar" %>
  <% end %>
<% end %>

<h1 class="text-xl font-bold mb-4">プロフィール作成</h1>

<%= render "form", profile: @profile %>


--- FILE: app/helpers/team_settings_helper.rb ---
# app/helpers/team_settings_hepler.rb
module TeamSettingsHelper
end


--- FILE: app/helpers/avatars_helper.rb ---
# app/helpers/avatars_helper.rb
module AvatarsHelper
end


--- FILE: app/helpers/tasks_helper.rb ---
# app/helper/tasks_helper.rb
module TasksHelper
  def status_badge(task)
    base_class = "inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold"

    color_class =
      case task.status
      when "todo"
        # 淡い赤
        "bg-red-100 text-red-700"
      when "in_progress"
        # 淡い青
        "bg-blue-100 text-blue-700"
      when "done"
        # 淡い緑
        "bg-green-100 text-green-700"
      when "archived"
        # 淡い黄色
        "bg-yellow-100 text-yellow-800"
      else
        "bg-gray-100 text-gray-600"
      end

    label =
      case task.status
      when "todo"        then "todo"
      when "in_progress" then "in_progress"
      when "done"        then "done"
      when "archived"    then "archived"
      else task.status
      end

    content_tag :span, label, class: "#{base_class} #{color_class}"
  end

  # ここから 期限バッジ
  def due_badge(task)
    base_class = "inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold"

    # 期限未設定
    return content_tag(:span, "未設定", class: "#{base_class} bg-gray-100 text-gray-500") if task.due_at.blank?

    now = Time.zone.now
    due = task.due_at.in_time_zone(Time.zone)

    label = due.strftime("%m/%d %H:%M")

    color_class =
      if due < now
        # 期限切れ
        "bg-red-100 text-red-700"
      elsif due.to_date == now.to_date
        # 今日が期限
        "bg-blue-100 text-blue-700"
      else
        # 未来
        "bg-green-100 text-green-700"
      end

    content_tag :span, label, class: "#{base_class} #{color_class}"
  end

  # カラム名クリックでソートするリンク
  # 1回目クリック → 降順
  # 同じカラムをもう1回クリック → 昇順
  def sort_link(label, column)
    current_sort      = params[:sort]
    current_direction = params[:direction]

    # 次の direction を決める
    next_direction =
      if current_sort == column && current_direction == "desc"
        "asc"   # 今が desc で同じカラム → 昇順に切り替え
      else
        "desc"  # それ以外（初回 or 別カラム）→ 降順スタート
      end

    # 今の状態に応じて矢印アイコン
    icon =
      if current_sort == column
        current_direction == "desc" ? "▼" : "▲"
      else
        ""
      end

    link_to(
      safe_join([ label, icon ].reject(&:blank?), " "),
      tasks_path(
        # いまの検索/フィルタ/カラムフィルタのパラメータを維持しつつ
        request.query_parameters.merge(sort: column, direction: next_direction)
      ),
      class: "inline-flex items-center gap-1 text-xs text-gray-700 hover:underline"
    )
  end
end


--- FILE: app/helpers/team_memberships_helper.rb ---
# app/helpers/team_memberships_helper.rb
module TeamMembershipsHelper
end


--- FILE: app/helpers/home_helper.rb ---
# app/helper/home_helper.rb
module HomeHelper
end


--- FILE: app/helpers/profile_settings_helper.rb ---
# app/helpers/profile_settings/helper.rb
module ProfileSettingsHelper
end


--- FILE: app/helpers/teams_helper.rb ---
# app/helpers/team_helper.rb
module TeamsHelper
end


--- FILE: app/helpers/profiles_helper.rb ---
# app/helpers/profiles_helper.rb
module ProfilesHelper
end


--- FILE: app/helpers/application_helper.rb ---
# app/helpers/application_helper.rb
module ApplicationHelper
  # ナビ用クラス（前と同じ役割）
  THEME_CLASSES = {
    "default" => { header: "bg-gray-50 text-gray-800", nav: "bg-white text-gray-800 border-r border-gray-300" },

    # 濃い背景 + 白文字（ヘッダー/左ナビ）
    "slate"   => { header: "bg-slate-800 text-white",  nav: "bg-slate-900 text-white" },
    "indigo"  => { header: "bg-indigo-700 text-white", nav: "bg-indigo-800 text-white" },
    "emerald" => { header: "bg-emerald-700 text-white", nav: "bg-emerald-800 text-white" },
    "rose"    => { header: "bg-rose-700 text-white",   nav: "bg-rose-800 text-white" },
    "amber"   => { header: "bg-amber-700 text-white",  nav: "bg-amber-800 text-white" }
  }.freeze

  def submit_mode?
    ENV.fetch("DELIVER_EMAILS", "false") != "true"
  end

  def current_theme_key
    key = current_profile&.theme.presence || "default"
    THEME_CLASSES.key?(key) ? key : "default"
  end

  def header_theme_class
    THEME_CLASSES[current_theme_key][:header]
  end

  def sidebar_theme_class
    THEME_CLASSES[current_theme_key][:nav]
  end

  def dark_theme?
    current_theme_key != "default"
  end

  def nav_class(path)
    base = "block px-3 py-1 rounded text-sm"

    if dark_theme?
      if current_page?(path)
        "#{base} bg-white/10 text-white font-semibold"
      else
        "#{base} text-white/80 hover:bg-white/10 hover:text-white"
      end
    else
      if current_page?(path)
        "#{base} bg-blue-50 text-blue-700 font-semibold"
      else
        "#{base} text-gray-700 hover:bg-gray-50"
      end
    end
  end


  def profile_chip(profile, size: :xs, wrapper_class: "", show_label_fallback: true)
    return "" if profile.nil?

    name =
      profile.display_name.presence ||
      (show_label_fallback ? profile.label : "")

    content_tag :span,
                class: [ "inline-flex items-center space-x-1", wrapper_class ].reject(&:blank?).join(" ") do
      concat profile_avatar(profile, size: size)
      concat content_tag(:span, name, class: "truncate")
    end
  end

  # プロフィールアイコン
  def profile_avatar(profile, size: :md)
    sizes = {
      xs: 24,
      sm: 32,
      md: 40,
      lg: 64
    }

    dimension = sizes[size] || sizes[:md]

    if profile&.avatar&.attached?
      # ✅ vips / variant を使わず、そのまま表示して CSS でサイズ調整
      image_tag profile.avatar,
                class: "object-cover rounded",
                style: "width: #{dimension}px; height: #{dimension}px;",
                alt: profile.display_name || profile.label
    else
      initials = profile.display_initials

      content_tag :div,
                  initials,
                  class: "inline-flex items-center justify-center bg-gray-400 text-white font-semibold rounded",
                  style: "width: #{dimension}px; height: #{dimension}px; font-size: #{(dimension * 0.4).round}px;"
    end
  end

  def team_avatar(team, size: :md)
    return "" if team.nil?

    sizes = {
      xs: 24,
      sm: 32,
      md: 40,
      lg: 64
    }

    dimension = sizes[size] || sizes[:md]

    if team.avatar.attached?
      # ✅ variant をやめて、直接表示 + CSS でサイズ調整
      image_tag team.avatar,
                class: "rounded object-cover",
                style: "width: #{dimension}px; height: #{dimension}px;",
                alt: team.name
    else
      # アイコンが無いときのイニシャル表示とか
      initial = team.name.to_s[0].presence || "T"

      content_tag :div,
                  initial,
                  class: "inline-flex items-center justify-center rounded bg-blue-400 text-white font-semibold",
                  style: "width: #{dimension}px; height: #{dimension}px; font-size: #{(dimension * 0.5).round}px;"
    end
  end

  def team_chip(team, size: :xs, wrapper_class: "")
    return "" if team.nil?

    content_tag :span,
                class: [ "inline-flex items-center space-x-1", wrapper_class ].reject(&:blank?).join(" ") do
      concat team_avatar(team, size: size)
      concat content_tag(:span, team.name, class: "truncate")
    end
  end
end


--- FILE: app/channels/application_cable/connection.rb ---
module ApplicationCable
  class Connection < ActionCable::Connection::Base
  end
end


--- FILE: app/channels/application_cable/channel.rb ---
module ApplicationCable
  class Channel < ActionCable::Channel::Base
  end
end


--- FILE: config/routes.rb ---
# config/routes.rb
Rails.application.routes.draw do
  root "tasks#index"

  devise_for :users, controllers: {
    confirmations: "users/confirmations",
    passwords: "users/passwords"
  }

  post "/account/send_change_email", to: "account_settings#send_change_email", as: :send_change_email
  post "/account/send_password_reset", to: "account_settings#send_password_reset", as: :send_password_reset

  resources :profiles do
    collection { post :switch }
  end

  get "up" => "rails/health#show", as: :rails_health_check

  resource :profile_settings, only: [] do
    get :home
    get :edit
    get :theme
  end

  resource :team_settings, only: [] do
    get :home
    get :edit
    get :members
  end

  resources :teams

  get "tasks/slot_tasks", to: "tasks#slot_tasks", as: :slot_tasks

  resources :tasks do
    resources :comments, only: %i[create edit update destroy] do
      resources :reactions, only: :create
    end
  end

  resources :team_memberships, only: %i[create destroy update]

  resources :membership_requests, only: %i[create] do
    member { patch :approve }
  end

  if Rails.env.development?
    mount LetterOpenerWeb::Engine, at: "/letter_opener"
  end
end


--- FILE: config/environments/production.rb ---
# config/environments/production.rb
require "active_support/core_ext/integer/time"

Rails.application.configure do
  config.enable_reloading = false

  config.eager_load = true

  config.consider_all_requests_local = false
  config.action_controller.perform_caching = true

  config.assets.compile = true

  config.active_storage.service = :local

  config.force_ssl = true

  config.logger = ActiveSupport::Logger.new(STDOUT)
    .tap  { |logger| logger.formatter = ::Logger::Formatter.new }
    .then { |logger| ActiveSupport::TaggedLogging.new(logger) }

  config.log_tags = [ :request_id ]

  config.log_level = ENV.fetch("RAILS_LOG_LEVEL", "info")

  config.action_mailer.perform_caching = false

  config.i18n.fallbacks = true

  config.active_support.report_deprecations = false

  config.active_record.dump_schema_after_migration = false

  config.active_record.attributes_for_inspect = [ :id ]

  config.action_mailer.default_url_options = {
    host: ENV.fetch("APP_HOST", "todo-beaver.onrender.com"),
    protocol: "https"
  }

  # --- Submit mode switch (email delivery) ---
  deliver_emails = ENV.fetch("DELIVER_EMAILS", "false") == "true"

  config.action_mailer.perform_deliveries = deliver_emails
  config.action_mailer.raise_delivery_errors = deliver_emails

  config.public_file_server.enabled = true

  if deliver_emails
    config.action_mailer.delivery_method = :smtp
    config.action_mailer.smtp_settings = {
      address: ENV.fetch("SMTP_ADDRESS"),
      port: ENV.fetch("SMTP_PORT", "587").to_i,
      domain: ENV.fetch("SMTP_DOMAIN", "todo-beaver.onrender.com"),
      user_name: ENV.fetch("SMTP_USERNAME"),
      password: ENV.fetch("SMTP_PASSWORD"),
      authentication: ENV.fetch("SMTP_AUTH", "plain").to_sym,
      enable_starttls_auto: ENV.fetch("SMTP_STARTTLS", "true") == "true"
    }
  else
    # Don't deliver emails in submit mode (prevents 500)
    config.action_mailer.delivery_method = :test
  end
end


--- FILE: config/environments/development.rb ---
# config/environments/development.rb
require "active_support/core_ext/integer/time"

Rails.application.configure do
  config.enable_reloading = true

  config.eager_load = false

  config.consider_all_requests_local = true

  config.server_timing = true

  if Rails.root.join("tmp/caching-dev.txt").exist?
    config.action_controller.perform_caching = true
    config.action_controller.enable_fragment_cache_logging = true

    config.cache_store = :memory_store
    config.public_file_server.headers = { "Cache-Control" => "public, max-age=#{2.days.to_i}" }
  else
    config.action_controller.perform_caching = false

    config.cache_store = :null_store
  end

  config.active_storage.service = :local

  config.action_mailer.perform_deliveries = true
  config.action_mailer.raise_delivery_errors = true
  config.action_mailer.delivery_method = :letter_opener_web
  config.action_mailer.default_url_options = { host: "localhost", port: 3000 }

  config.active_support.deprecation = :log

  config.active_support.disallowed_deprecation = :raise

  config.active_support.disallowed_deprecation_warnings = []

  config.active_record.migration_error = :page_load

  config.active_record.verbose_query_logs = true

  config.active_job.verbose_enqueue_logs = true

  config.assets.quiet = true

  config.action_view.annotate_rendered_view_with_filenames = true

  config.action_controller.raise_on_missing_callback_actions = true
end


--- FILE: config/environments/test.rb ---
# config/environments/test.rb
require "active_support/core_ext/integer/time"

Rails.application.configure do
  config.enable_reloading = false

  config.eager_load = ENV["CI"].present?

  config.public_file_server.headers = { "Cache-Control" => "public, max-age=#{1.hour.to_i}" }

  config.consider_all_requests_local = true
  config.action_controller.perform_caching = false
  config.cache_store = :null_store

  config.action_dispatch.show_exceptions = :rescuable

  config.action_controller.allow_forgery_protection = false

  config.active_storage.service = :test

  config.action_mailer.perform_caching = false

  config.action_mailer.delivery_method = :test

  config.action_mailer.default_url_options = { host: "www.example.com" }

  config.active_support.deprecation = :stderr

  config.active_support.disallowed_deprecation = :raise

  config.active_support.disallowed_deprecation_warnings = []

  config.action_controller.raise_on_missing_callback_actions = true
end


--- FILE: config/environment.rb ---
# config/environment.rb
# Load the Rails application.
require_relative "application"

# Initialize the Rails application.
Rails.application.initialize!


--- FILE: config/application.rb ---
# config/application.rb
require_relative "boot"

require "rails/all"

Bundler.require(*Rails.groups)

module TodoBeaver
  class Application < Rails::Application
    config.load_defaults 7.2

    config.autoload_lib(ignore: %w[assets tasks])

    config.time_zone = "Tokyo"
    config.active_record.default_timezone = :local

    config.i18n.default_locale = :ja
  end
end


--- FILE: config/puma.rb ---
# This configuration file will be evaluated by Puma. The top-level methods that
# are invoked here are part of Puma's configuration DSL. For more information
# about methods provided by the DSL, see https://puma.io/puma/Puma/DSL.html.

# Puma starts a configurable number of processes (workers) and each process
# serves each request in a thread from an internal thread pool.
#
# The ideal number of threads per worker depends both on how much time the
# application spends waiting for IO operations and on how much you wish to
# to prioritize throughput over latency.
#
# As a rule of thumb, increasing the number of threads will increase how much
# traffic a given process can handle (throughput), but due to CRuby's
# Global VM Lock (GVL) it has diminishing returns and will degrade the
# response time (latency) of the application.
#
# The default is set to 3 threads as it's deemed a decent compromise between
# throughput and latency for the average Rails application.
#
# Any libraries that use a connection pool or another resource pool should
# be configured to provide at least as many connections as the number of
# threads. This includes Active Record's `pool` parameter in `database.yml`.
threads_count = ENV.fetch("RAILS_MAX_THREADS", 3)
threads threads_count, threads_count

# Specifies the `port` that Puma will listen on to receive requests; default is 3000.
port ENV.fetch("PORT", 3000)

# Allow puma to be restarted by `bin/rails restart` command.
plugin :tmp_restart

# Specify the PID file. Defaults to tmp/pids/server.pid in development.
# In other environments, only set the PID file if requested.
pidfile ENV["PIDFILE"] if ENV["PIDFILE"]


--- FILE: config/boot.rb ---
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

require "bundler/setup" # Set up gems listed in the Gemfile.
require "bootsnap/setup" # Speed up boot time by caching expensive operations.


--- FILE: config/importmap.rb ---
# config/importmap.rb
pin "application"
pin "@hotwired/turbo-rails", to: "turbo.min.js"
pin "@hotwired/stimulus", to: "stimulus.min.js"
pin "@hotwired/stimulus-loading", to: "stimulus-loading.js"

pin "controllers", to: "controllers/index.js"
pin_all_from "app/javascript/controllers", under: "controllers"


--- FILE: config/initializers/filter_parameter_logging.rb ---
# Be sure to restart your server when you modify this file.

# Configure parameters to be partially matched (e.g. passw matches password) and filtered from the log file.
# Use this to limit dissemination of sensitive information.
# See the ActiveSupport::ParameterFilter documentation for supported notations and behaviors.
Rails.application.config.filter_parameters += [
  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn
]


--- FILE: config/initializers/assets.rb ---
# Be sure to restart your server when you modify this file.

# Version of your assets, change this if you want to expire all your assets.
Rails.application.config.assets.version = "1.0"

# Add additional assets to the asset load path.
# Rails.application.config.assets.paths << Emoji.images_path

# Precompile additional assets.
# application.js, application.css, and all non-JS/CSS in the app/assets
# folder are already added.
# Rails.application.config.assets.precompile += %w[ admin.js admin.css ]


--- FILE: config/initializers/parameter_encoding_patch.rb ---
# config/initializers/parameter_encoding_patch.rb
Rails.application.config.to_prepare do
  ActionController::Base.class_eval do
    if instance_variable_get(:@_parameter_encodings).nil?
      instance_variable_set(:@_parameter_encodings, {})
    end
  end
end


--- FILE: config/initializers/devise.rb ---
# frozen_string_literal: true

# Assuming you have not yet modified this file, each configuration option below
# is set to its default value. Note that some are commented out while others
# are not: uncommented lines are intended to protect your configuration from
# breaking changes in upgrades (i.e., in the event that future versions of
# Devise change the default values for those options).
#
# Use this hook to configure devise mailer, warden hooks and so forth.
# Many of these configuration options can be set straight in your model.
Devise.setup do |config|
  # The secret key used by Devise. Devise uses this key to generate
  # random tokens. Changing this key will render invalid all existing
  # confirmation, reset password and unlock tokens in the database.
  # Devise will use the `secret_key_base` as its `secret_key`
  # by default. You can change it below and use your own secret key.
  # config.secret_key = '6799c1f91f1d0a80d48df75b7b4f4de90fabc6b567e70515d092e117944d6f6d9d1799b40ed799ee8493a05085234c6502d59c2e1db163d2b03ecded3c322059'

  # ==> Controller configuration
  # Configure the parent class to the devise controllers.
  # config.parent_controller = 'DeviseController'

  # ==> Mailer Configuration
  # Configure the e-mail address which will be shown in Devise::Mailer,
  # note that it will be overwritten if you use your own mailer class
  # with default "from" parameter.
  config.mailer_sender = "please-change-me-at-config-initializers-devise@example.com"

  # Configure the class responsible to send e-mails.
  # config.mailer = 'Devise::Mailer'

  # Configure the parent class responsible to send e-mails.
  # config.parent_mailer = 'ActionMailer::Base'

  # ==> ORM configuration
  # Load and configure the ORM. Supports :active_record (default) and
  # :mongoid (bson_ext recommended) by default. Other ORMs may be
  # available as additional gems.
  require "devise/orm/active_record"

  # ==> Configuration for any authentication mechanism
  # Configure which keys are used when authenticating a user. The default is
  # just :email. You can configure it to use [:username, :subdomain], so for
  # authenticating a user, both parameters are required. Remember that those
  # parameters are used only when authenticating and not when retrieving from
  # session. If you need permissions, you should implement that in a before filter.
  # You can also supply a hash where the value is a boolean determining whether
  # or not authentication should be aborted when the value is not present.
  # config.authentication_keys = [:email]

  # Configure parameters from the request object used for authentication. Each entry
  # given should be a request method and it will automatically be passed to the
  # find_for_authentication method and considered in your model lookup. For instance,
  # if you set :request_keys to [:subdomain], :subdomain will be used on authentication.
  # The same considerations mentioned for authentication_keys also apply to request_keys.
  # config.request_keys = []

  # Configure which authentication keys should be case-insensitive.
  # These keys will be downcased upon creating or modifying a user and when used
  # to authenticate or find a user. Default is :email.
  config.case_insensitive_keys = [ :email ]

  # Configure which authentication keys should have whitespace stripped.
  # These keys will have whitespace before and after removed upon creating or
  # modifying a user and when used to authenticate or find a user. Default is :email.
  config.strip_whitespace_keys = [ :email ]

  # Tell if authentication through request.params is enabled. True by default.
  # It can be set to an array that will enable params authentication only for the
  # given strategies, for example, `config.params_authenticatable = [:database]` will
  # enable it only for database (email + password) authentication.
  # config.params_authenticatable = true

  # Tell if authentication through HTTP Auth is enabled. False by default.
  # It can be set to an array that will enable http authentication only for the
  # given strategies, for example, `config.http_authenticatable = [:database]` will
  # enable it only for database authentication.
  # For API-only applications to support authentication "out-of-the-box", you will likely want to
  # enable this with :database unless you are using a custom strategy.
  # The supported strategies are:
  # :database      = Support basic authentication with authentication key + password
  # config.http_authenticatable = false

  # If 401 status code should be returned for AJAX requests. True by default.
  # config.http_authenticatable_on_xhr = true

  # The realm used in Http Basic Authentication. 'Application' by default.
  # config.http_authentication_realm = 'Application'

  # It will change confirmation, password recovery and other workflows
  # to behave the same regardless if the e-mail provided was right or wrong.
  # Does not affect registerable.
  # config.paranoid = true

  # By default Devise will store the user in session. You can skip storage for
  # particular strategies by setting this option.
  # Notice that if you are skipping storage for all authentication paths, you
  # may want to disable generating routes to Devise's sessions controller by
  # passing skip: :sessions to `devise_for` in your config/routes.rb
  config.skip_session_storage = [ :http_auth ]

  # By default, Devise cleans up the CSRF token on authentication to
  # avoid CSRF token fixation attacks. This means that, when using AJAX
  # requests for sign in and sign up, you need to get a new CSRF token
  # from the server. You can disable this option at your own risk.
  # config.clean_up_csrf_token_on_authentication = true

  # When false, Devise will not attempt to reload routes on eager load.
  # This can reduce the time taken to boot the app but if your application
  # requires the Devise mappings to be loaded during boot time the application
  # won't boot properly.
  # config.reload_routes = true

  # ==> Configuration for :database_authenticatable
  # For bcrypt, this is the cost for hashing the password and defaults to 12. If
  # using other algorithms, it sets how many times you want the password to be hashed.
  # The number of stretches used for generating the hashed password are stored
  # with the hashed password. This allows you to change the stretches without
  # invalidating existing passwords.
  #
  # Limiting the stretches to just one in testing will increase the performance of
  # your test suite dramatically. However, it is STRONGLY RECOMMENDED to not use
  # a value less than 10 in other environments. Note that, for bcrypt (the default
  # algorithm), the cost increases exponentially with the number of stretches (e.g.
  # a value of 20 is already extremely slow: approx. 60 seconds for 1 calculation).
  config.stretches = Rails.env.test? ? 1 : 12

  # Set up a pepper to generate the hashed password.
  # config.pepper = 'b09cbad222847be41062e7cb9ebaceab341e6f01ed91c8a33801433bd432b69ffa36e7b7b38ca3b8b2f6023b7946d4d998cef5dddeab730f7593d7c12c1ee189'

  # Send a notification to the original email when the user's email is changed.
  # config.send_email_changed_notification = false

  # Send a notification email when the user's password is changed.
  # config.send_password_change_notification = false

  # ==> Configuration for :confirmable
  # A period that the user is allowed to access the website even without
  # confirming their account. For instance, if set to 2.days, the user will be
  # able to access the website for two days without confirming their account,
  # access will be blocked just in the third day.
  # You can also set it to nil, which will allow the user to access the website
  # without confirming their account.
  # Default is 0.days, meaning the user cannot access the website without
  # confirming their account.
  # config.allow_unconfirmed_access_for = 2.days

  # A period that the user is allowed to confirm their account before their
  # token becomes invalid. For example, if set to 3.days, the user can confirm
  # their account within 3 days after the mail was sent, but on the fourth day
  # their account can't be confirmed with the token any more.
  # Default is nil, meaning there is no restriction on how long a user can take
  # before confirming their account.
  # config.confirm_within = 3.days

  # If true, requires any email changes to be confirmed (exactly the same way as
  # initial account confirmation) to be applied. Requires additional unconfirmed_email
  # db field (see migrations). Until confirmed, new email is stored in
  # unconfirmed_email column, and copied to email column on successful confirmation.
  config.reconfirmable = true

  # Defines which key will be used when confirming an account
  # config.confirmation_keys = [:email]

  # ==> Configuration for :rememberable
  # The time the user will be remembered without asking for credentials again.
  # config.remember_for = 2.weeks

  # Invalidates all the remember me tokens when the user signs out.
  config.expire_all_remember_me_on_sign_out = true

  # If true, extends the user's remember period when remembered via cookie.
  # config.extend_remember_period = false

  # Options to be passed to the created cookie. For instance, you can set
  # secure: true in order to force SSL only cookies.
  # config.rememberable_options = {}

  # ==> Configuration for :validatable
  # Range for password length.
  config.password_length = 6..128

  # Email regex used to validate email formats. It simply asserts that
  # one (and only one) @ exists in the given string. This is mainly
  # to give user feedback and not to assert the e-mail validity.
  config.email_regexp = /\A[^@\s]+@[^@\s]+\z/

  # ==> Configuration for :timeoutable
  # The time you want to timeout the user session without activity. After this
  # time the user will be asked for credentials again. Default is 30 minutes.
  # config.timeout_in = 30.minutes

  # ==> Configuration for :lockable
  # Defines which strategy will be used to lock an account.
  # :failed_attempts = Locks an account after a number of failed attempts to sign in.
  # :none            = No lock strategy. You should handle locking by yourself.
  # config.lock_strategy = :failed_attempts

  # Defines which key will be used when locking and unlocking an account
  # config.unlock_keys = [:email]

  # Defines which strategy will be used to unlock an account.
  # :email = Sends an unlock link to the user email
  # :time  = Re-enables login after a certain amount of time (see :unlock_in below)
  # :both  = Enables both strategies
  # :none  = No unlock strategy. You should handle unlocking by yourself.
  # config.unlock_strategy = :both

  # Number of authentication tries before locking an account if lock_strategy
  # is failed attempts.
  # config.maximum_attempts = 20

  # Time interval to unlock the account if :time is enabled as unlock_strategy.
  # config.unlock_in = 1.hour

  # Warn on the last attempt before the account is locked.
  # config.last_attempt_warning = true

  # ==> Configuration for :recoverable
  #
  # Defines which key will be used when recovering the password for an account
  # config.reset_password_keys = [:email]

  # Time interval you can reset your password with a reset password key.
  # Don't put a too small interval or your users won't have the time to
  # change their passwords.
  config.reset_password_within = 6.hours

  # When set to false, does not sign a user in automatically after their password is
  # reset. Defaults to true, so a user is signed in automatically after a reset.
  # config.sign_in_after_reset_password = true

  # ==> Configuration for :encryptable
  # Allow you to use another hashing or encryption algorithm besides bcrypt (default).
  # You can use :sha1, :sha512 or algorithms from others authentication tools as
  # :clearance_sha1, :authlogic_sha512 (then you should set stretches above to 20
  # for default behavior) and :restful_authentication_sha1 (then you should set
  # stretches to 10, and copy REST_AUTH_SITE_KEY to pepper).
  #
  # Require the `devise-encryptable` gem when using anything other than bcrypt
  # config.encryptor = :sha512

  # ==> Scopes configuration
  # Turn scoped views on. Before rendering "sessions/new", it will first check for
  # "users/sessions/new". It's turned off by default because it's slower if you
  # are using only default views.
  # config.scoped_views = false

  # Configure the default scope given to Warden. By default it's the first
  # devise role declared in your routes (usually :user).
  # config.default_scope = :user

  # Set this configuration to false if you want /users/sign_out to sign out
  # only the current scope. By default, Devise signs out all scopes.
  # config.sign_out_all_scopes = true

  # ==> Navigation configuration
  # Lists the formats that should be treated as navigational. Formats like
  # :html should redirect to the sign in page when the user does not have
  # access, but formats like :xml or :json, should return 401.
  #
  # If you have any extra navigational formats, like :iphone or :mobile, you
  # should add them to the navigational formats lists.
  #
  # The "*/*" below is required to match Internet Explorer requests.
  # config.navigational_formats = ['*/*', :html, :turbo_stream]

  # The default HTTP method used to sign out a resource. Default is :delete.
  config.sign_out_via = :delete

  # ==> OmniAuth
  # Add a new OmniAuth provider. Check the wiki for more information on setting
  # up on your models and hooks.
  # config.omniauth :github, 'APP_ID', 'APP_SECRET', scope: 'user,public_repo'

  # ==> Warden configuration
  # If you want to use other strategies, that are not supported by Devise, or
  # change the failure app, you can configure them inside the config.warden block.
  #
  # config.warden do |manager|
  #   manager.intercept_401 = false
  #   manager.default_strategies(scope: :user).unshift :some_external_strategy
  # end

  # ==> Mountable engine configurations
  # When using Devise inside an engine, let's call it `MyEngine`, and this engine
  # is mountable, there are some extra configurations to be taken into account.
  # The following options are available, assuming the engine is mounted as:
  #
  #     mount MyEngine, at: '/my_engine'
  #
  # The router that invoked `devise_for`, in the example above, would be:
  # config.router_name = :my_engine
  #
  # When using OmniAuth, Devise cannot automatically set OmniAuth path,
  # so you need to do it manually. For the users scope, it would be:
  # config.omniauth_path_prefix = '/my_engine/users/auth'

  # ==> Hotwire/Turbo configuration
  # When using Devise with Hotwire/Turbo, the http status for error responses
  # and some redirects must match the following. The default in Devise for existing
  # apps is `200 OK` and `302 Found` respectively, but new apps are generated with
  # these new defaults that match Hotwire/Turbo behavior.
  # Note: These might become the new default in future versions of Devise.
  config.responder.error_status = :unprocessable_entity
  config.responder.redirect_status = :see_other

  # ==> Configuration for :registerable

  # When set to false, does not sign a user in automatically after their password is
  # changed. Defaults to true, so a user is signed in automatically after changing a password.
  # config.sign_in_after_change_password = true
end


--- FILE: config/initializers/permissions_policy.rb ---
# Be sure to restart your server when you modify this file.

# Define an application-wide HTTP permissions policy. For further
# information see: https://developers.google.com/web/updates/2018/06/feature-policy

# Rails.application.config.permissions_policy do |policy|
#   policy.camera      :none
#   policy.gyroscope   :none
#   policy.microphone  :none
#   policy.usb         :none
#   policy.fullscreen  :self
#   policy.payment     :self, "https://secure.example.com"
# end


--- FILE: config/initializers/content_security_policy.rb ---
# Be sure to restart your server when you modify this file.

# Define an application-wide content security policy.
# See the Securing Rails Applications Guide for more information:
# https://guides.rubyonrails.org/security.html#content-security-policy-header

# Rails.application.configure do
#   config.content_security_policy do |policy|
#     policy.default_src :self, :https
#     policy.font_src    :self, :https, :data
#     policy.img_src     :self, :https, :data
#     policy.object_src  :none
#     policy.script_src  :self, :https
#     policy.style_src   :self, :https
#     # Specify URI for violation reports
#     # policy.report_uri "/csp-violation-report-endpoint"
#   end
#
#   # Generate session nonces for permitted importmap, inline scripts, and inline styles.
#   config.content_security_policy_nonce_generator = ->(request) { request.session.id.to_s }
#   config.content_security_policy_nonce_directives = %w(script-src style-src)
#
#   # Report violations without enforcing the policy.
#   # config.content_security_policy_report_only = true
# end


--- FILE: config/initializers/inflections.rb ---
# Be sure to restart your server when you modify this file.

# Add new inflection rules using the following format. Inflections
# are locale specific, and you may define rules for as many different
# locales as you wish. All of these examples are active by default:
# ActiveSupport::Inflector.inflections(:en) do |inflect|
#   inflect.plural /^(ox)$/i, "\\1en"
#   inflect.singular /^(ox)en/i, "\\1"
#   inflect.irregular "person", "people"
#   inflect.uncountable %w( fish sheep )
# end

# These inflection rules are supported but not enabled by default:
# ActiveSupport::Inflector.inflections(:en) do |inflect|
#   inflect.acronym "RESTful"
# end


--- FILE: db/migrate/20251201030420_create_membership_requests.rb ---
class CreateMembershipRequests < ActiveRecord::Migration[7.2]
  def change
    create_table :membership_requests do |t|
      # 申請を出した側のプロフィール
      t.references :requester_profile, null: false, foreign_key: { to_table: :profiles }

      # 相手のプロフィール（Team -> Profile 招待で使う）
      t.references :target_profile, foreign_key: { to_table: :profiles }

      # 対象チーム（Profile -> Team 申請で使う）
      t.references :team, foreign_key: true

      # 方向: profile_to_team / team_to_profile
      t.integer :direction, null: false, default: 0

      # 状態: pending / approved / rejected / canceled
      t.integer :status, null: false, default: 0

      # メッセージ（任意）
      t.text :message

      t.timestamps
    end

    # 「同じ内容の pending 申請を二重で作らない」ためのインデックス（とりあえず方向も含めておく）
    add_index :membership_requests,
              [ :requester_profile_id, :target_profile_id, :team_id, :direction ],
              name: "idx_membership_requests_uniqueness"
  end
end


--- FILE: db/migrate/20251129122723_create_team_memberships.rb ---
# db/migrate/xxxx_create_team_memberships.rb
class CreateTeamMemberships < ActiveRecord::Migration[7.2]
  def change
    create_table :team_memberships do |t|
      t.references :profile, null: false, foreign_key: true
      t.references :team,    null: false, foreign_key: true
      t.string :role

      t.timestamps
    end

    # 同じ profile が同じ team に二重登録されないようにする
    add_index :team_memberships, [ :profile_id, :team_id ], unique: true
  end
end


--- FILE: db/migrate/20251129114825_create_teams.rb ---
class CreateTeams < ActiveRecord::Migration[7.2]
  def change
    create_table :teams do |t|
      t.string :name

      t.timestamps
    end
  end
end


--- FILE: db/migrate/20251201151350_add_admin_flag_to_membership_requests.rb ---
class AddAdminFlagToMembershipRequests < ActiveRecord::Migration[7.2]
  def change
    add_column :membership_requests, :admin, :boolean, default: false, null: false
  end
end


--- FILE: db/migrate/20251213084433_add_confirmable_to_users.rb ---
# db/migrate/xxxx_add_confimable_to_users.rb
class AddConfirmableToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :confirmation_token, :string
    add_column :users, :confirmed_at, :datetime
    add_column :users, :confirmation_sent_at, :datetime
    add_column :users, :unconfirmed_email, :string

    add_index :users, :confirmation_token, unique: true
  end
end


--- FILE: db/migrate/20251203152911_create_task_assignments.rb ---
# db/migrate/xxxx_create_task_assignments.rb
class CreateTaskAssignments < ActiveRecord::Migration[7.1]
  def change
    create_table :task_assignments do |t|
      t.references :task,    null: false, foreign_key: true
      t.references :profile, null: false, foreign_key: true

      t.timestamps
    end

    add_index :task_assignments, [ :task_id, :profile_id ], unique: true
  end
end


--- FILE: db/migrate/20251125033848_create_profiles.rb ---
class CreateProfiles < ActiveRecord::Migration[7.2]
  def change
    create_table :profiles do |t|
      t.references :user, null: false, foreign_key: true
      t.string :name
      t.string :theme

      t.timestamps
    end
  end
end


--- FILE: db/migrate/20251202142010_create_tasks.rb ---
# db/migrate/xxxx_create_tasks.rb
class CreateTasks < ActiveRecord::Migration[7.1]
  def change
    create_table :tasks do |t|
      t.references :owner_profile, null: false, foreign_key: { to_table: :profiles }
      t.references :assignee_profile, foreign_key: { to_table: :profiles }
      t.references :team, null: false, foreign_key: true

      t.string   :title, null: false
      t.text     :description
      t.datetime :due_at
      t.integer  :status, null: false, default: 0  # enum 用

      t.timestamps
    end
  end
end


--- FILE: db/migrate/20251203115451_create_tags.rb ---
# db/migrate/xxxx_create_tags.rb
class CreateTags < ActiveRecord::Migration[7.1]
  def change
    create_table :tags do |t|
      t.string :name, null: false

      t.timestamps
    end

    add_index :tags, :name, unique: true
  end
end


--- FILE: db/migrate/20251203115524_create_task_tags.rb ---
# db/migrate/xxxx_create_task_tags.rb
class CreateTaskTags < ActiveRecord::Migration[7.1]
  def change
    create_table :task_tags do |t|
      t.references :task, null: false, foreign_key: true
      t.references :tag,  null: false, foreign_key: true

      t.timestamps
    end

    add_index :task_tags, [ :task_id, :tag_id ], unique: true
  end
end


--- FILE: db/migrate/20251130053718_add_join_token_to_profiles_and_teams.rb ---
class AddJoinTokenToProfilesAndTeams < ActiveRecord::Migration[7.2]
  def change
    add_column :profiles, :join_token, :string
    add_index  :profiles, :join_token, unique: true

    add_column :teams, :join_token, :string
    add_index  :teams, :join_token, unique: true
  end
end


--- FILE: db/migrate/20251205103631_create_comments.rb ---
# db/migrate/xxxx_create_commments.rb
class CreateComments < ActiveRecord::Migration[7.2]
  def change
    create_table :comments do |t|
      t.references :task, null: false, foreign_key: true
      t.references :author_profile, null: false, foreign_key: { to_table: :profiles }
      t.text :body, null: false

      t.timestamps
    end
  end
end


--- FILE: db/migrate/20251214072957_remove_onboarding_from_users.rb ---
class RemoveOnboardingFromUsers < ActiveRecord::Migration[7.2]
  def change
    remove_column :users, :onboarding, :boolean
  end
end


--- FILE: db/migrate/20251206141956_add_pinned_to_comments.rb ---
# db/migrate/xxxx_add_pinned_to_comments.rb
class AddPinnedToComments < ActiveRecord::Migration[7.1]
  def change
    add_column :comments, :pinned, :boolean, null: false, default: false
  end
end


--- FILE: db/migrate/20251214064818_add_onboarding_to_users.rb ---
# db/migrate/xxxx_add_onboarding_to_users.rb
class AddOnboardingToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :onboarding, :boolean, null: false, default: false
  end
end


--- FILE: db/migrate/20251123061232_devise_create_users.rb ---
# frozen_string_literal: true

class DeviseCreateUsers < ActiveRecord::Migration[7.2]
  def change
    create_table :users do |t|
      ## Database authenticatable
      t.string :email,              null: false, default: ""
      t.string :encrypted_password, null: false, default: ""

      ## Recoverable
      t.string   :reset_password_token
      t.datetime :reset_password_sent_at

      ## Rememberable
      t.datetime :remember_created_at

      ## Trackable
      # t.integer  :sign_in_count, default: 0, null: false
      # t.datetime :current_sign_in_at
      # t.datetime :last_sign_in_at
      # t.string   :current_sign_in_ip
      # t.string   :last_sign_in_ip

      ## Confirmable
      # t.string   :confirmation_token
      # t.datetime :confirmed_at
      # t.datetime :confirmation_sent_at
      # t.string   :unconfirmed_email # Only if using reconfirmable

      ## Lockable
      # t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts
      # t.string   :unlock_token # Only if unlock strategy is :email or :both
      # t.datetime :locked_at


      t.timestamps null: false
    end

    add_index :users, :email,                unique: true
    add_index :users, :reset_password_token, unique: true
    # add_index :users, :confirmation_token,   unique: true
    # add_index :users, :unlock_token,         unique: true
  end
end


--- FILE: db/migrate/20251207042702_create_reactions.rb ---
class CreateReactions < ActiveRecord::Migration[7.2]
  def change
    create_table :reactions do |t|
      t.references :comment, null: false, foreign_key: true
      t.references :profile, null: false, foreign_key: true
      t.string :kind

      t.timestamps
    end
  end
end


--- FILE: db/migrate/20251130024714_rename_name_to_label_in_profiles.rb ---
class RenameNameToLabelInProfiles < ActiveRecord::Migration[7.2]
  def change
    rename_column :profiles, :name, :label
  end
end


--- FILE: db/migrate/20251205111906_create_active_storage_tables.active_storage.rb ---
# This migration comes from active_storage (originally 20170806125915)
class CreateActiveStorageTables < ActiveRecord::Migration[7.0]
  def change
    # Use Active Record's configured type for primary and foreign keys
    primary_key_type, foreign_key_type = primary_and_foreign_key_types

    create_table :active_storage_blobs, id: primary_key_type do |t|
      t.string   :key,          null: false
      t.string   :filename,     null: false
      t.string   :content_type
      t.text     :metadata
      t.string   :service_name, null: false
      t.bigint   :byte_size,    null: false
      t.string   :checksum

      if connection.supports_datetime_with_precision?
        t.datetime :created_at, precision: 6, null: false
      else
        t.datetime :created_at, null: false
      end

      t.index [ :key ], unique: true
    end

    create_table :active_storage_attachments, id: primary_key_type do |t|
      t.string     :name,     null: false
      t.references :record,   null: false, polymorphic: true, index: false, type: foreign_key_type
      t.references :blob,     null: false, type: foreign_key_type

      if connection.supports_datetime_with_precision?
        t.datetime :created_at, precision: 6, null: false
      else
        t.datetime :created_at, null: false
      end

      t.index [ :record_type, :record_id, :name, :blob_id ], name: :index_active_storage_attachments_uniqueness, unique: true
      t.foreign_key :active_storage_blobs, column: :blob_id
    end

    create_table :active_storage_variant_records, id: primary_key_type do |t|
      t.belongs_to :blob, null: false, index: false, type: foreign_key_type
      t.string :variation_digest, null: false

      t.index [ :blob_id, :variation_digest ], name: :index_active_storage_variant_records_uniqueness, unique: true
      t.foreign_key :active_storage_blobs, column: :blob_id
    end
  end

  private
    def primary_and_foreign_key_types
      config = Rails.configuration.generators
      setting = config.options[config.orm][:primary_key_type]
      primary_key_type = setting || :primary_key
      foreign_key_type = setting || :bigint
      [ primary_key_type, foreign_key_type ]
    end
end


--- FILE: db/migrate/20251214143313_make_tasks_team_optional.rb ---
# db/migrate/xxxx_make_tasks_team_optional.rb
class MakeTasksTeamOptional < ActiveRecord::Migration[7.2]
  def change
    change_column_null :tasks, :team_id, true
  end
end


--- FILE: db/migrate/20251129125826_add_display_name_to_profiles.rb ---
class AddDisplayNameToProfiles < ActiveRecord::Migration[7.2]
  def change
    add_column :profiles, :display_name, :string
  end
end


